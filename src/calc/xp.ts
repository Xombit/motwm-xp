/** ===== D35E progression helpers (single source of truth) ===== */

export function systemTotalXPForLevel(level: number): number {
  const L = Math.max(1, Math.floor(level));
  const rate = game.settings.get("D35E", "experienceRate") as string; // "fast" | "medium" | "slow" (or others)
  const table = (CONFIG as any)?.D35E?.CHARACTER_EXP_LEVELS?.[rate];
  if (Array.isArray(table)) {
    return Number(table[Math.min(L - 1, table.length - 1)] ?? 0);
  }
  // ultra-safe fallback: 3.5e classic quadratic
  return Math.floor(1000 * ((L - 1) * L) / 2);
}

/** Total number of bubble segments in the XP bar UI */
export const TOTAL_BUBBLE_SEGMENTS = 13 + 1/3;

/** ===== Award methods ===== */

/** 
 * D&D 3.5 XP Table
 */
function getBaseXPForSingleMonster(pcLevel: number, monsterCR: number): number {
  const TABLE_2_6: Record<number, Record<number, number>> = {
    1: { 1: 300, 2: 600, 3: 900, 4: 1350, 5: 1800, 6: 2700, 7: 3600, 8: 5400, 9: 7200, 10: 10800 },
    2: { 1: 300, 2: 600, 3: 900, 4: 1350, 5: 1800, 6: 2700, 7: 3600, 8: 5400, 9: 7200, 10: 10800 },
    3: { 1: 300, 2: 600, 3: 900, 4: 1350, 5: 1800, 6: 2700, 7: 3600, 8: 5400, 9: 7200, 10: 10800 },
    4: { 1: 300, 2: 600, 3: 800, 4: 1200, 5: 1600, 6: 2400, 7: 3200, 8: 4800, 9: 6400, 10: 9600, 11: 12800 },
    5: { 1: 300, 2: 500, 3: 750, 4: 1000, 5: 1500, 6: 2250, 7: 3000, 8: 4500, 9: 6000, 10: 9000, 11: 12000, 12: 18000 },
    6: { 1: 300, 2: 450, 3: 600, 4: 900, 5: 1200, 6: 1800, 7: 2700, 8: 3600, 9: 5400, 10: 7200, 11: 10800, 12: 14400, 13: 21600 },
    7: { 1: 263, 2: 350, 3: 525, 4: 700, 5: 1050, 6: 1400, 7: 2100, 8: 3150, 9: 4200, 10: 6300, 11: 8400, 12: 12600, 13: 16800, 14: 25200 },
    8: { 1: 200, 2: 300, 3: 400, 4: 600, 5: 800, 6: 1200, 7: 1600, 8: 2400, 9: 3600, 10: 4800, 11: 7200, 12: 9600, 13: 14400, 14: 19200, 15: 28800 },
    9: { 1: 0, 2: 225, 3: 338, 4: 450, 5: 675, 6: 900, 7: 1350, 8: 1800, 9: 2700, 10: 4050, 11: 5400, 12: 8100, 13: 10800, 14: 16200, 15: 21600, 16: 32400 },
    10: { 1: 0, 2: 0, 3: 250, 4: 375, 5: 500, 6: 750, 7: 1000, 8: 1500, 9: 2000, 10: 3000, 11: 4500, 12: 6000, 13: 9000, 14: 12000, 15: 18000, 16: 24000, 17: 36000 },
    11: { 1: 0, 2: 0, 3: 0, 4: 275, 5: 413, 6: 550, 7: 825, 8: 1100, 9: 1650, 10: 2200, 11: 3300, 12: 4950, 13: 6600, 14: 9900, 15: 13200, 16: 19800, 17: 26400, 18: 39600 },
    12: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 300, 6: 450, 7: 600, 8: 900, 9: 1200, 10: 1800, 11: 2400, 12: 3600, 13: 5400, 14: 7200, 15: 10800, 16: 14400, 17: 21600, 18: 28800, 19: 43200 },
    13: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 325, 7: 488, 8: 650, 9: 975, 10: 1300, 11: 1950, 12: 2600, 13: 3900, 14: 5850, 15: 7800, 16: 11700, 17: 15600, 18: 23400, 19: 31200, 20: 46800 },
    14: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 350, 8: 525, 9: 700, 10: 1050, 11: 1400, 12: 2100, 13: 2800, 14: 4200, 15: 6300, 16: 8400, 17: 12600, 18: 16800, 19: 25200, 20: 33600 },
    15: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 375, 9: 563, 10: 750, 11: 1125, 12: 1500, 13: 2250, 14: 3000, 15: 4500, 16: 6750, 17: 9000, 18: 13500, 19: 18000, 20: 27000 },
    16: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 400, 10: 600, 11: 800, 12: 1200, 13: 1600, 14: 2400, 15: 3200, 16: 4800, 17: 7200, 18: 9600, 19: 14400, 20: 19200 },
    17: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 425, 11: 638, 12: 850, 13: 1275, 14: 1700, 15: 2550, 16: 3400, 17: 5100, 18: 7650, 19: 10200, 20: 15300 },
    18: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 450, 12: 675, 13: 900, 14: 1350, 15: 1800, 16: 2700, 17: 3600, 18: 5400, 19: 8100, 20: 10800 },
    19: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 475, 13: 713, 14: 950, 15: 1425, 16: 1900, 17: 2850, 18: 3800, 19: 5700, 20: 8550 },
    20: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 500, 14: 750, 15: 1000, 16: 1500, 17: 2000, 18: 3000, 19: 4000, 20: 6000, 21: 11400, 22: 12000, 23: 22800, 24: 24000, 25: 36000, 26: 48000, 27: 72000, 28: 96000 },
    21: { 13: 0, 14: 0, 15: 525, 16: 788, 17: 1050, 18: 1575, 19: 2100, 20: 3150, 21: 4200, 22: 6300, 23: 8400, 24: 12600, 25: 16800, 26: 25200, 27: 33600, 28: 50400, 29: 67200, 30: 100800 },
    22: { 14: 0, 15: 0, 16: 550, 17: 825, 18: 1100, 19: 1650, 20: 2200, 21: 3300, 22: 4400, 23: 6600, 24: 8800, 25: 13200, 26: 17600, 27: 26400, 28: 35200, 29: 52800, 30: 70400, 31: 105600 },
    23: { 15: 0, 16: 0, 17: 575, 18: 863, 19: 1150, 20: 1725, 21: 2300, 22: 3450, 23: 4600, 24: 6900, 25: 9200, 26: 13800, 27: 18400, 28: 27600, 29: 36800, 30: 55200, 31: 73600, 32: 110400 },
    24: { 16: 0, 17: 0, 18: 600, 19: 900, 20: 1200, 21: 1800, 22: 2400, 23: 3600, 24: 4800, 25: 7200, 26: 9600, 27: 14400, 28: 19200, 29: 28800, 30: 38400, 31: 57600, 32: 76800, 33: 115200 },
    25: { 17: 0, 18: 0, 19: 625, 20: 938, 21: 1250, 22: 1875, 23: 2500, 24: 3750, 25: 5000, 26: 7500, 27: 10000, 28: 15000, 29: 20000, 30: 30000, 31: 40000, 32: 60000, 33: 80000, 34: 120000 },
    26: { 18: 0, 19: 0, 20: 650, 21: 975, 22: 1300, 23: 1950, 24: 2600, 25: 3900, 26: 5200, 27: 7800, 28: 10400, 29: 15600, 30: 20800, 31: 31200, 32: 41600, 33: 62400, 34: 83200, 35: 124800 },
    27: { 19: 0, 20: 0, 21: 675, 22: 1013, 23: 1350, 24: 2025, 25: 2700, 26: 4050, 27: 5400, 28: 8100, 29: 10800, 30: 16200, 31: 21600, 32: 32400, 33: 43200, 34: 64800, 35: 86400, 36: 129600 },
    28: { 20: 0, 21: 0, 22: 700, 23: 1050, 24: 1400, 25: 2100, 26: 2800, 27: 4200, 28: 5600, 29: 8400, 30: 11200, 31: 16800, 32: 22400, 33: 33600, 34: 44800, 35: 67200, 36: 89600, 37: 134400 },
    29: { 21: 0, 22: 0, 23: 725, 24: 1088, 25: 1450, 26: 2175, 27: 2900, 28: 4350, 29: 5800, 30: 8700, 31: 11600, 32: 17400, 33: 23200, 34: 34800, 35: 46400, 36: 69600, 37: 92800, 38: 139200 },
    30: { 22: 0, 23: 0, 24: 750, 25: 1125, 26: 1500, 27: 2250, 28: 3000, 29: 4500, 30: 6000, 31: 9000, 32: 12000, 33: 18000, 34: 24000, 35: 36000, 36: 48000, 37: 72000, 38: 96000, 39: 144000 },
    31: { 23: 0, 24: 0, 25: 775, 26: 1163, 27: 1550, 28: 2325, 29: 3100, 30: 4650, 31: 6200, 32: 9300, 33: 12400, 34: 18600, 35: 24800, 36: 37200, 37: 49600, 38: 74400, 39: 99200, 40: 148800 },
    32: { 24: 0, 25: 0, 26: 800, 27: 1200, 28: 1600, 29: 2400, 30: 3200, 31: 4800, 32: 6400, 33: 9600, 34: 12800, 35: 19200, 36: 25600, 37: 38400, 38: 51200, 39: 76800, 40: 102400 },
    33: { 25: 0, 26: 0, 27: 825, 28: 1238, 29: 1650, 30: 2475, 31: 3300, 32: 4950, 33: 6600, 34: 9900, 35: 13200, 36: 19800, 37: 26400, 38: 39600, 39: 52800, 40: 79200 },
    34: { 26: 0, 27: 0, 28: 850, 29: 1275, 30: 1700, 31: 2550, 32: 3400, 33: 5100, 34: 6800, 35: 10200, 36: 13600, 37: 20400, 38: 27200, 39: 40800, 40: 54400 },
    35: { 27: 0, 28: 0, 29: 875, 30: 1313, 31: 1750, 32: 2625, 33: 3500, 34: 5250, 35: 7000, 36: 10500, 37: 14000, 38: 21000, 39: 28000, 40: 42000 },
    36: { 28: 0, 29: 0, 30: 900, 31: 1350, 32: 1800, 33: 2700, 34: 3600, 35: 5400, 36: 7200, 37: 10800, 38: 14400, 39: 21600, 40: 28800 },
    37: { 29: 0, 30: 0, 31: 925, 32: 1388, 33: 1850, 34: 2775, 35: 3700, 36: 5550, 37: 7400, 38: 11100, 39: 14800, 40: 22200 },
    38: { 30: 0, 31: 0, 32: 950, 33: 1425, 34: 1900, 35: 2850, 36: 3800, 37: 5700, 38: 7600, 39: 11400, 40: 15200 },
    39: { 31: 0, 32: 0, 33: 975, 34: 1463, 35: 1950, 36: 2925, 37: 3900, 38: 5850, 39: 7800, 40: 11700 },
    40: { 32: 0, 33: 0, 34: 1000, 35: 1500, 36: 2000, 37: 3000, 38: 4000, 39: 6000, 40: 8000 }
  };

  const level = Math.max(1, Math.min(40, Math.floor(pcLevel)));
  const cr = Math.max(0.125, monsterCR);
  
  // Handle fractional CRs (below CR 1)
  if (cr < 1) {
    // Fractional CRs scale proportionally from the CR 1 value
    const cr1XP = TABLE_2_6[level]?.[1] ?? 0;
    return Math.round(cr1XP * cr);
  }
  
  const crInt = Math.floor(cr);
  const row = TABLE_2_6[level];
  
  if (!row) return 0;
  
  // Direct table lookup
  if (row[crInt] !== undefined) {
    return row[crInt];
  }
  
  // For CRs above the table, use DMG rule: double XP for every +2 CR
  // Find the highest CR in this level's row
  const maxCRInRow = Math.max(...Object.keys(row).map(k => parseInt(k)).filter(k => row[k] > 0));
  if (crInt > maxCRInRow) {
    // Calculate how many doubling steps above the max CR
    const stepsAbove = Math.floor((crInt - maxCRInRow) / 2);
    const baseXP = row[maxCRInRow] ?? 0;
    return Math.round(baseXP * Math.pow(2, stepsAbove));
  }
  
  return 0;
}

/**
 * Get XP for a monster with a fractional CR adjustment applied.
 * For whole number adjustments, just adds to CR.
 * For fractional adjustments (e.g., +1.5), interpolates between whole CR values.
 * 
 * @param pcLevel - PC level
 * @param baseCR - Monster's base CR
 * @param crAdjustment - CR adjustment (can be fractional, e.g., 1.5, -0.3)
 * @param partySize - Number of PCs for division
 * @returns XP award for one PC
 */
export function getAdjustedMonsterXP(pcLevel: number, baseCR: number, crAdjustment: number, partySize: number): number {
  if (partySize <= 0) return 0;
  
  // Apply the adjustment
  const adjustedCR = Math.max(0.125, baseCR + crAdjustment);
  
  // If the adjustment is a whole number (or very close), just use direct lookup
  const fractionalPart = adjustedCR - Math.floor(adjustedCR);
  if (fractionalPart < 0.001) {
    return Math.round(getBaseXPForSingleMonster(pcLevel, adjustedCR) / partySize);
  }
  
  // For fractional CRs, interpolate between floor and ceiling
  const floorCR = Math.floor(adjustedCR);
  const ceilCR = Math.ceil(adjustedCR);
  
  const floorXP = getBaseXPForSingleMonster(pcLevel, floorCR);
  const ceilXP = getBaseXPForSingleMonster(pcLevel, ceilCR);
  
  // Linear interpolation
  const interpolatedXP = floorXP + (ceilXP - floorXP) * fractionalPart;
  
  return Math.round(interpolatedXP / partySize);
}

/** 
 * D&D 3.0 XP Table: Returns the total party XP pot for a given APL and CR.
 * Supports decimal CR adjustments via linear interpolation.
 */
export function getPot30(apl: number, cr: number): number {
  const TABLE_30: Record<number, Record<number, number>> = {
    1:  { 1:300, 2:600, 3:900, 4:1350, 5:1800, 6:2700, 7:3600, 8:5400, 9:7200, 10:10800 },
    2:  { 1:300, 2:600, 3:900, 4:1350, 5:1800, 6:2700, 7:3600, 8:5400, 9:7200, 10:10800 },
    3:  { 1:300, 2:600, 3:900, 4:1350, 5:1800, 6:2700, 7:3600, 8:5400, 9:7200, 10:10800 },
    4:  { 1:300, 2:600, 3:800, 4:1200, 5:1600, 6:2400, 7:3200, 8:4800, 9:6400, 10:9600, 11:12800, 12:18000, 13:21600, 14:28800 },
    5:  { 1:300, 2:500, 3:750, 4:1000, 5:1500, 6:2250, 7:3000, 8:4500, 9:6000, 10:9000, 11:12000, 12:18000, 13:21600, 14:28800, 15:28800 },
    6:  { 1:300, 2:450, 3:600, 4:900, 5:1200, 6:1800, 7:2400, 8:3600, 9:4800, 10:7200, 11:10800, 12:14400, 13:21600, 14:25200, 15:28800, 16:28800 },
    7:  { 1:263, 2:394, 3:525, 4:700, 5:1050, 6:1400, 7:2100, 8:3150, 9:4200, 10:6300, 11:8400, 12:12600, 13:16800, 14:25200, 15:28800 },
    8:  { 1:200, 2:300, 3:450, 4:600, 5:875, 6:1200, 7:1600, 8:2400, 9:3600, 10:4800, 11:6300, 12:8400, 13:12600, 14:16800, 15:25200, 16:28800 },
    9:  { 1:0, 2:225, 3:338, 4:506, 5:675, 6:1013, 7:1350, 8:2025, 9:2700, 10:4050, 11:5400, 12:8100, 13:10800, 14:16200, 15:21600, 16:32400, 17:36000, 18:39600 },
    10: { 3:250, 4:375, 5:563, 6:750, 7:1000, 8:1500, 9:2000, 10:3000, 11:3600, 12:4800, 13:6400, 14:9600 },
    11: { 4:275, 5:413, 6:619, 7:825, 8:1238, 9:1650, 10:2475, 11:3300, 12:4950, 13:6600, 14:9900, 15:13200, 16:17600, 17:26400, 18:39600 },
    12: { 5:300, 6:450, 7:675, 8:900, 9:1350, 10:1800, 11:1950, 12:2600, 13:3900, 14:5850, 15:7800, 16:11700, 17:15600, 18:23400, 19:31200, 20:46800 },
    13: { 6:325, 7:488, 8:731, 9:975, 10:1463, 11:1400, 12:2100, 13:2800, 14:4200, 15:6300, 16:8400, 17:12600, 18:18900, 19:25200, 20:33600 },
    14: { 6:350, 7:525, 8:788, 9:1050, 10:1575, 11:900, 12:1200, 13:1800, 14:2400, 15:4200, 16:4800, 17:7200, 18:10800, 19:13500, 20:18900 },
    15: { 7:375, 8:563, 9:844, 10:1125, 11:638, 12:850, 13:1275, 14:1900, 15:2500, 16:4800, 17:7200, 18:10800, 19:13500, 20:18900 },
    16: { 7:400, 8:600, 9:900, 10:1350, 11:900, 12:1200, 13:1800, 14:2400, 15:3200, 16:4800, 17:7200, 18:10800, 19:14400, 20:19200 },
    17: { 8:425, 9:638, 10:956, 11:900, 12:1200, 13:1800, 14:2400, 15:3200, 16:4800, 17:7200, 18:10800, 19:14400, 20:19200 },
    18: { 8:450, 9:675, 10:1013, 11:638, 12:850, 13:1275, 14:1900, 15:2500, 16:4800, 17:7200, 18:10800, 19:14400, 20:19200 },
    19: { 9:475, 10:713, 11:638, 12:850, 13:1275, 14:1900, 15:2500, 16:4800, 17:7200, 18:10800, 19:14400, 20:19200 },
    20: { 10:750, 11:900, 12:1200, 13:1800, 14:2400, 15:3200, 16:4800, 17:7200, 18:10800, 19:14400, 20:19200 },
    21: { 11:1125, 12:1350, 13:1800, 14:2700, 15:3600, 16:4800, 17:7200, 18:10800, 19:14400, 20:21600, 21:28800, 22:43200, 23:57600, 24:76800 },
    22: { 12:1688, 13:2025, 14:2700, 15:4050, 16:5400, 17:7200, 18:10800, 19:16200, 20:21600, 21:32400, 22:43200, 23:64800, 24:86400, 25:115200 },
    23: { 13:2250, 14:2700, 15:3600, 16:5400, 17:7200, 18:9600, 19:14400, 20:21600, 21:28800, 22:43200, 23:57600, 24:86400, 25:115200, 26:153600 },
    24: { 14:3000, 15:3600, 16:4800, 17:7200, 18:9600, 19:12800, 20:19200, 21:28800, 22:38400, 23:57600, 24:76800, 25:115200, 26:153600, 27:204800 },
    25: { 15:4500, 16:5400, 17:7200, 18:10800, 19:14400, 20:19200, 21:28800, 22:43200, 23:57600, 24:86400, 25:115200, 26:172800, 27:230400, 28:307200 },
    26: { 16:6750, 17:8100, 18:10800, 19:16200, 20:21600, 21:28800, 22:43200, 23:64800, 24:86400, 25:129600, 26:172800, 27:259200, 28:345600, 29:460800 },
    27: { 17:9000, 18:10800, 19:14400, 20:21600, 21:28800, 22:38400, 23:57600, 24:86400, 25:115200, 26:172800, 27:230400, 28:345600, 29:460800, 30:614400 },
    28: { 18:12000, 19:14400, 20:19200, 21:28800, 22:38400, 23:51200, 24:76800, 25:115200, 26:153600, 27:230400, 28:307200, 29:460800, 30:614400, 31:819200 },
    29: { 19:18000, 20:21600, 21:28800, 22:43200, 23:57600, 24:76800, 25:115200, 26:172800, 27:230400, 28:345600, 29:460800, 30:691200, 31:921600, 32:1228800 },
    30: { 20:27000, 21:32400, 22:43200, 23:64800, 24:86400, 25:115200, 26:172800, 27:259200, 28:345600, 29:518400, 30:691200, 31:1036800, 32:1382400, 33:1843200 },
    31: { 21:36000, 22:43200, 23:57600, 24:86400, 25:115200, 26:153600, 27:230400, 28:345600, 29:460800, 30:691200, 31:921600, 32:1382400, 33:1843200, 34:2457600 },
    32: { 22:48000, 23:57600, 24:76800, 25:115200, 26:153600, 27:204800, 28:307200, 29:460800, 30:614400, 31:921600, 32:1228800, 33:1843200, 34:2457600, 35:3276800 },
    33: { 23:72000, 24:86400, 25:115200, 26:172800, 27:230400, 28:307200, 29:460800, 30:691200, 31:921600, 32:1382400, 33:1843200, 34:2764800, 35:3686400, 36:4915200 },
    34: { 24:108000, 25:129600, 26:172800, 27:259200, 28:345600, 29:460800, 30:691200, 31:1036800, 32:1382400, 33:2073600, 34:2764800, 35:4147200, 36:5529600, 37:7372800 },
    35: { 25:144000, 26:172800, 27:230400, 28:345600, 29:460800, 30:614400, 31:921600, 32:1382400, 33:1843200, 34:2764800, 35:3686400, 36:5529600, 37:7372800, 38:9830400 },
    36: { 26:192000, 27:230400, 28:307200, 29:460800, 30:614400, 31:819200, 32:1228800, 33:1843200, 34:2457600, 35:3686400, 36:4915200, 37:7372800, 38:9830400, 39:13107200 },
    37: { 27:288000, 28:345600, 29:460800, 30:691200, 31:921600, 32:1228800, 33:1843200, 34:2764800, 35:3686400, 36:5529600, 37:7372800, 38:11059200, 39:14745600, 40:19660800 },
    38: { 28:432000, 29:518400, 30:691200, 31:1036800, 32:1382400, 33:1843200, 34:2764800, 35:4147200, 36:5529600, 37:8294400, 38:11059200, 39:16588800, 40:22118400 },
    39: { 29:576000, 30:691200, 31:921600, 32:1382400, 33:1843200, 34:2457600, 35:3686400, 36:5529600, 37:7372800, 38:11059200, 39:14745600, 40:22118400 },
    40: { 30:768000, 31:921600, 32:1228800, 33:1843200, 34:2457600, 35:3276800, 36:4915200, 37:7372800, 38:9830400, 39:14745600, 40:19660800 }
  };

  // Helper function to get XP for integer CR
  const getIntegerPot = (aplInt: number, crInt: number): number => {
    const levelRow = TABLE_30[aplInt];
    if (!levelRow) return 0;
    
    const xp = levelRow[crInt];
    if (xp !== undefined) return xp;
    
    // If CR not in table, use the baseline for that APL and apply the standard scaling
    const baseXP = getBasePot30(aplInt);
    const diff = crInt - aplInt;
    
    // Apply the alternating ×3/2, ×4/3 pattern for higher CRs
    // Or ×2/3, ×3/4 pattern for lower CRs
    let result = baseXP;
    if (diff > 0) {
      // Higher CR: alternating ×3/2 and ×4/3
      for (let step = 0; step < diff; step++) {
        result = Math.floor(result * (step % 2 === 0 ? 3/2 : 4/3));
      }
    } else if (diff < 0) {
      // Lower CR: alternating ×2/3 and ×3/4
      for (let step = 0; step < Math.abs(diff); step++) {
        result = Math.floor(result * (step % 2 === 0 ? 2/3 : 3/4));
      }
    }
    
    return Math.max(0, result);
  };

  const aplInt = Math.max(1, Math.min(40, Math.floor(apl)));
  const crFloor = Math.max(1, Math.floor(cr));
  
  // If CR is an integer, return directly
  if (cr === crFloor) {
    return getIntegerPot(aplInt, crFloor);
  }
  
  // Decimal CR: interpolate between floor and ceiling
  const crCeil = crFloor + 1;
  const floorXP = getIntegerPot(aplInt, crFloor);
  const ceilXP = getIntegerPot(aplInt, crCeil);
  
  // Linear interpolation
  const fractionalPart = cr - crFloor;
  const interpolatedXP = floorXP + (ceilXP - floorXP) * fractionalPart;
  
  return Math.round(interpolatedXP);
}

/** Helper: Get the baseline XP for a party level when CR = APL */
function getBasePot30(apl: number): number {
  // Levels 1-11: simple 300 × level
  if (apl <= 11) return 300 * apl;
  
  // Irregular levels 12-15 (from actual table)
  const irregular: Record<number, number> = { 12: 2600, 13: 2800, 14: 2400, 15: 2500 };
  if (irregular[apl]) return irregular[apl];
  
  // Levels 16+: use the geometric progression pattern
  // Starting from level 16 = 4800, apply ×1.5, ×1.5, ×4/3, ×4/3 pattern
  let xp = 4800;
  const pattern = [1.5, 1.5, 4/3, 4/3];
  for (let level = 17; level <= apl; level++) {
    const mult = pattern[(level - 17) % 4];
    xp = Math.floor(xp * mult);
  }
  return xp;
}

/** Classic 3.0 Split: pass a total pot (you compute from APL vs EL) and return each share (weighted elsewhere) */
export function split30(pot: number, weight: number, totalWeight: number): number {
  if (pot <= 0 || totalWeight <= 0) return 0;
  return Math.round((pot * weight) / totalWeight);
}
