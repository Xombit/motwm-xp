var U=Object.defineProperty;var z=(f,c,e)=>c in f?U(f,c,{enumerable:!0,configurable:!0,writable:!0,value:e}):f[c]=e;var N=(f,c,e)=>z(f,typeof c!="symbol"?c+"":c,e);function Y(){game.settings.register("motwm-xp","broadcastChat",{name:"Broadcast XP to Chat",hint:"When enabled, XP awards are posted as chat messages visible to all players.",scope:"world",config:!0,type:Boolean,default:!1}),game.settings.register("motwm-xp","showPlayerBar",{name:"Show Player XP Bar",hint:"Display a draggable XP progress bar on your screen for your assigned character.",scope:"client",config:!0,type:Boolean,default:!0,onChange:f=>{var t,n,a;const c=(t=game.user)==null?void 0:t.character;if(!c)return;const e=(n=window.MOTWM_XP)==null?void 0:n.bars;if(!e)return;let s=e.get(c.id);if(f){if(!s){const r=(a=window.MOTWM_XP)==null?void 0:a.XpBarApp;if(!r)return;s=new r(c,{top:window.innerHeight-54,left:0}),e.set(c.id,s)}s.render(!0)}else s&&s.close()}}),game.settings.register("motwm-xp","barPos",{name:"XP Bar Position",scope:"client",config:!1,type:String,default:""}),game.settings.register("motwm-xp","awardMode",{name:"XP Award Method",hint:"DMG 3.5e: Official per-monster method using Table 2-6 (each PC's level vs each monster's CR). D&D 3.0: Split-pot method (total party XP divided equally).",scope:"world",config:!0,type:String,choices:{dmg35:"D&D 3.5e (Individual XP)",split30:"D&D 3.0 (split pot by APL)"},default:"dmg35"})}class O{static getXP(c){const e=getProperty(c,"system.details.xp.value");return Number(e??0)}static async setXP(c,e){return c.update({"system.details.xp.value":Number(e)})}static getLevel(c){const e=getProperty(c,"system.classes");if(e&&typeof e=="object"){let t=0;for(const n of Object.values(e)){const a=Number(getProperty(n,"level")??0);t+=a}if(t>0)return t}const s=getProperty(c,"system.details.level.value");return Number(s??0)}static getCR(c){const e=["system.details.totalCr","system.details.cr.total","system.attributes.cr.total","system.details.cr.value","system.details.cr","data.details.totalCr","data.details.cr.total","data.details.cr.value","data.details.cr"];for(const t of e){const n=getProperty(c,t);if(n!=null&&Number.isFinite(Number(n)))return Number(n)}const s=this.getLevel(c);return s?Number(s):null}}function C(f,c){if(c<=0)return-1/0;let e=f,s=c;for(;s>=2;)e+=2,s=Math.floor(s/2);return e}function I(f){if(!f.length)return-1/0;let c=f.slice().sort((e,s)=>e-s);for(;c.length>1;){const e=c.pop(),s=c.pop(),t=Math.abs(e-s);let n=e;t===0?n=e+2:t>=1&&t<=7?n=e+1:n=e,c.push(n),c.sort((a,r)=>a-r)}return c[0]}function S(f){var t,n;const c=Math.max(1,Math.floor(f)),e=game.settings.get("D35E","experienceRate"),s=(n=(t=CONFIG==null?void 0:CONFIG.D35E)==null?void 0:t.CHARACTER_EXP_LEVELS)==null?void 0:n[e];return Array.isArray(s)?Number(s[Math.min(c-1,s.length-1)]??0):Math.floor(1e3*((c-1)*c)/2)}const V=13+1/3;function D(f,c){var i;const e={1:{1:300,2:600,3:900,4:1350,5:1800,6:2700,7:3600,8:5400,9:7200,10:10800},2:{1:300,2:600,3:900,4:1350,5:1800,6:2700,7:3600,8:5400,9:7200,10:10800},3:{1:300,2:600,3:900,4:1350,5:1800,6:2700,7:3600,8:5400,9:7200,10:10800},4:{1:300,2:600,3:800,4:1200,5:1600,6:2400,7:3200,8:4800,9:6400,10:9600,11:12800},5:{1:300,2:500,3:750,4:1e3,5:1500,6:2250,7:3e3,8:4500,9:6e3,10:9e3,11:12e3,12:18e3},6:{1:300,2:450,3:600,4:900,5:1200,6:1800,7:2700,8:3600,9:5400,10:7200,11:10800,12:14400,13:21600},7:{1:263,2:350,3:525,4:700,5:1050,6:1400,7:2100,8:3150,9:4200,10:6300,11:8400,12:12600,13:16800,14:25200},8:{1:200,2:300,3:400,4:600,5:800,6:1200,7:1600,8:2400,9:3600,10:4800,11:7200,12:9600,13:14400,14:19200,15:28800},9:{1:0,2:225,3:338,4:450,5:675,6:900,7:1350,8:1800,9:2700,10:4050,11:5400,12:8100,13:10800,14:16200,15:21600,16:32400},10:{1:0,2:0,3:250,4:375,5:500,6:750,7:1e3,8:1500,9:2e3,10:3e3,11:4500,12:6e3,13:9e3,14:12e3,15:18e3,16:24e3,17:36e3},11:{1:0,2:0,3:0,4:275,5:413,6:550,7:825,8:1100,9:1650,10:2200,11:3300,12:4950,13:6600,14:9900,15:13200,16:19800,17:26400,18:39600},12:{1:0,2:0,3:0,4:0,5:300,6:450,7:600,8:900,9:1200,10:1800,11:2400,12:3600,13:5400,14:7200,15:10800,16:14400,17:21600,18:28800,19:43200},13:{1:0,2:0,3:0,4:0,5:0,6:325,7:488,8:650,9:975,10:1300,11:1950,12:2600,13:3900,14:5850,15:7800,16:11700,17:15600,18:23400,19:31200,20:46800},14:{1:0,2:0,3:0,4:0,5:0,6:0,7:350,8:525,9:700,10:1050,11:1400,12:2100,13:2800,14:4200,15:6300,16:8400,17:12600,18:16800,19:25200,20:33600},15:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:375,9:563,10:750,11:1125,12:1500,13:2250,14:3e3,15:4500,16:6750,17:9e3,18:13500,19:18e3,20:27e3},16:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:400,10:600,11:800,12:1200,13:1600,14:2400,15:3200,16:4800,17:7200,18:9600,19:14400,20:19200},17:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:425,11:638,12:850,13:1275,14:1700,15:2550,16:3400,17:5100,18:7650,19:10200,20:15300},18:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:450,12:675,13:900,14:1350,15:1800,16:2700,17:3600,18:5400,19:8100,20:10800},19:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:475,13:713,14:950,15:1425,16:1900,17:2850,18:3800,19:5700,20:8550},20:{1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:500,14:750,15:1e3,16:1500,17:2e3,18:3e3,19:4e3,20:6e3,21:11400,22:12e3,23:22800,24:24e3,25:36e3,26:48e3,27:72e3,28:96e3},21:{13:0,14:0,15:525,16:788,17:1050,18:1575,19:2100,20:3150,21:4200,22:6300,23:8400,24:12600,25:16800,26:25200,27:33600,28:50400,29:67200,30:100800},22:{14:0,15:0,16:550,17:825,18:1100,19:1650,20:2200,21:3300,22:4400,23:6600,24:8800,25:13200,26:17600,27:26400,28:35200,29:52800,30:70400,31:105600},23:{15:0,16:0,17:575,18:863,19:1150,20:1725,21:2300,22:3450,23:4600,24:6900,25:9200,26:13800,27:18400,28:27600,29:36800,30:55200,31:73600,32:110400},24:{16:0,17:0,18:600,19:900,20:1200,21:1800,22:2400,23:3600,24:4800,25:7200,26:9600,27:14400,28:19200,29:28800,30:38400,31:57600,32:76800,33:115200},25:{17:0,18:0,19:625,20:938,21:1250,22:1875,23:2500,24:3750,25:5e3,26:7500,27:1e4,28:15e3,29:2e4,30:3e4,31:4e4,32:6e4,33:8e4,34:12e4},26:{18:0,19:0,20:650,21:975,22:1300,23:1950,24:2600,25:3900,26:5200,27:7800,28:10400,29:15600,30:20800,31:31200,32:41600,33:62400,34:83200,35:124800},27:{19:0,20:0,21:675,22:1013,23:1350,24:2025,25:2700,26:4050,27:5400,28:8100,29:10800,30:16200,31:21600,32:32400,33:43200,34:64800,35:86400,36:129600},28:{20:0,21:0,22:700,23:1050,24:1400,25:2100,26:2800,27:4200,28:5600,29:8400,30:11200,31:16800,32:22400,33:33600,34:44800,35:67200,36:89600,37:134400},29:{21:0,22:0,23:725,24:1088,25:1450,26:2175,27:2900,28:4350,29:5800,30:8700,31:11600,32:17400,33:23200,34:34800,35:46400,36:69600,37:92800,38:139200},30:{22:0,23:0,24:750,25:1125,26:1500,27:2250,28:3e3,29:4500,30:6e3,31:9e3,32:12e3,33:18e3,34:24e3,35:36e3,36:48e3,37:72e3,38:96e3,39:144e3},31:{23:0,24:0,25:775,26:1163,27:1550,28:2325,29:3100,30:4650,31:6200,32:9300,33:12400,34:18600,35:24800,36:37200,37:49600,38:74400,39:99200,40:148800},32:{24:0,25:0,26:800,27:1200,28:1600,29:2400,30:3200,31:4800,32:6400,33:9600,34:12800,35:19200,36:25600,37:38400,38:51200,39:76800,40:102400},33:{25:0,26:0,27:825,28:1238,29:1650,30:2475,31:3300,32:4950,33:6600,34:9900,35:13200,36:19800,37:26400,38:39600,39:52800,40:79200},34:{26:0,27:0,28:850,29:1275,30:1700,31:2550,32:3400,33:5100,34:6800,35:10200,36:13600,37:20400,38:27200,39:40800,40:54400},35:{27:0,28:0,29:875,30:1313,31:1750,32:2625,33:3500,34:5250,35:7e3,36:10500,37:14e3,38:21e3,39:28e3,40:42e3},36:{28:0,29:0,30:900,31:1350,32:1800,33:2700,34:3600,35:5400,36:7200,37:10800,38:14400,39:21600,40:28800},37:{29:0,30:0,31:925,32:1388,33:1850,34:2775,35:3700,36:5550,37:7400,38:11100,39:14800,40:22200},38:{30:0,31:0,32:950,33:1425,34:1900,35:2850,36:3800,37:5700,38:7600,39:11400,40:15200},39:{31:0,32:0,33:975,34:1463,35:1950,36:2925,37:3900,38:5850,39:7800,40:11700},40:{32:0,33:0,34:1e3,35:1500,36:2e3,37:3e3,38:4e3,39:6e3,40:8e3}},s=Math.max(1,Math.min(40,Math.floor(f))),t=Math.max(.125,c);if(t<1){const o=((i=e[s])==null?void 0:i[1])??0;return Math.round(o*t)}const n=Math.floor(t),a=e[s];if(!a)return 0;if(a[n]!==void 0)return a[n];const r=Math.max(...Object.keys(a).map(o=>parseInt(o)).filter(o=>a[o]>0));if(n>r){const o=Math.floor((n-r)/2),l=a[r]??0;return Math.round(l*Math.pow(2,o))}return 0}function R(f,c,e,s){if(s<=0)return 0;const t=Math.max(.125,c+e),n=t-Math.floor(t);if(n<.001)return Math.round(D(f,t)/s);const a=Math.floor(t),r=Math.ceil(t),i=D(f,a),o=D(f,r),l=i+(o-i)*n;return Math.round(l/s)}function F(f,c){const e={1:{1:300,2:600,3:900,4:1350,5:1800,6:2700,7:3600,8:5400,9:7200,10:10800},2:{1:300,2:600,3:900,4:1350,5:1800,6:2700,7:3600,8:5400,9:7200,10:10800},3:{1:300,2:600,3:900,4:1350,5:1800,6:2700,7:3600,8:5400,9:7200,10:10800},4:{1:300,2:600,3:800,4:1200,5:1600,6:2400,7:3200,8:4800,9:6400,10:9600,11:12800,12:18e3,13:21600,14:28800},5:{1:300,2:500,3:750,4:1e3,5:1500,6:2250,7:3e3,8:4500,9:6e3,10:9e3,11:12e3,12:18e3,13:21600,14:28800,15:28800},6:{1:300,2:450,3:600,4:900,5:1200,6:1800,7:2400,8:3600,9:4800,10:7200,11:10800,12:14400,13:21600,14:25200,15:28800,16:28800},7:{1:263,2:394,3:525,4:700,5:1050,6:1400,7:2100,8:3150,9:4200,10:6300,11:8400,12:12600,13:16800,14:25200,15:28800},8:{1:200,2:300,3:450,4:600,5:875,6:1200,7:1600,8:2400,9:3600,10:4800,11:6300,12:8400,13:12600,14:16800,15:25200,16:28800},9:{1:0,2:225,3:338,4:506,5:675,6:1013,7:1350,8:2025,9:2700,10:4050,11:5400,12:8100,13:10800,14:16200,15:21600,16:32400,17:36e3,18:39600},10:{3:250,4:375,5:563,6:750,7:1e3,8:1500,9:2e3,10:3e3,11:3600,12:4800,13:6400,14:9600},11:{4:275,5:413,6:619,7:825,8:1238,9:1650,10:2475,11:3300,12:4950,13:6600,14:9900,15:13200,16:17600,17:26400,18:39600},12:{5:300,6:450,7:675,8:900,9:1350,10:1800,11:1950,12:2600,13:3900,14:5850,15:7800,16:11700,17:15600,18:23400,19:31200,20:46800},13:{6:325,7:488,8:731,9:975,10:1463,11:1400,12:2100,13:2800,14:4200,15:6300,16:8400,17:12600,18:18900,19:25200,20:33600},14:{6:350,7:525,8:788,9:1050,10:1575,11:900,12:1200,13:1800,14:2400,15:4200,16:4800,17:7200,18:10800,19:13500,20:18900},15:{7:375,8:563,9:844,10:1125,11:638,12:850,13:1275,14:1900,15:2500,16:4800,17:7200,18:10800,19:13500,20:18900},16:{7:400,8:600,9:900,10:1350,11:900,12:1200,13:1800,14:2400,15:3200,16:4800,17:7200,18:10800,19:14400,20:19200},17:{8:425,9:638,10:956,11:900,12:1200,13:1800,14:2400,15:3200,16:4800,17:7200,18:10800,19:14400,20:19200},18:{8:450,9:675,10:1013,11:638,12:850,13:1275,14:1900,15:2500,16:4800,17:7200,18:10800,19:14400,20:19200},19:{9:475,10:713,11:638,12:850,13:1275,14:1900,15:2500,16:4800,17:7200,18:10800,19:14400,20:19200},20:{10:750,11:900,12:1200,13:1800,14:2400,15:3200,16:4800,17:7200,18:10800,19:14400,20:19200},21:{11:1125,12:1350,13:1800,14:2700,15:3600,16:4800,17:7200,18:10800,19:14400,20:21600,21:28800,22:43200,23:57600,24:76800},22:{12:1688,13:2025,14:2700,15:4050,16:5400,17:7200,18:10800,19:16200,20:21600,21:32400,22:43200,23:64800,24:86400,25:115200},23:{13:2250,14:2700,15:3600,16:5400,17:7200,18:9600,19:14400,20:21600,21:28800,22:43200,23:57600,24:86400,25:115200,26:153600},24:{14:3e3,15:3600,16:4800,17:7200,18:9600,19:12800,20:19200,21:28800,22:38400,23:57600,24:76800,25:115200,26:153600,27:204800},25:{15:4500,16:5400,17:7200,18:10800,19:14400,20:19200,21:28800,22:43200,23:57600,24:86400,25:115200,26:172800,27:230400,28:307200},26:{16:6750,17:8100,18:10800,19:16200,20:21600,21:28800,22:43200,23:64800,24:86400,25:129600,26:172800,27:259200,28:345600,29:460800},27:{17:9e3,18:10800,19:14400,20:21600,21:28800,22:38400,23:57600,24:86400,25:115200,26:172800,27:230400,28:345600,29:460800,30:614400},28:{18:12e3,19:14400,20:19200,21:28800,22:38400,23:51200,24:76800,25:115200,26:153600,27:230400,28:307200,29:460800,30:614400,31:819200},29:{19:18e3,20:21600,21:28800,22:43200,23:57600,24:76800,25:115200,26:172800,27:230400,28:345600,29:460800,30:691200,31:921600,32:1228800},30:{20:27e3,21:32400,22:43200,23:64800,24:86400,25:115200,26:172800,27:259200,28:345600,29:518400,30:691200,31:1036800,32:1382400,33:1843200},31:{21:36e3,22:43200,23:57600,24:86400,25:115200,26:153600,27:230400,28:345600,29:460800,30:691200,31:921600,32:1382400,33:1843200,34:2457600},32:{22:48e3,23:57600,24:76800,25:115200,26:153600,27:204800,28:307200,29:460800,30:614400,31:921600,32:1228800,33:1843200,34:2457600,35:3276800},33:{23:72e3,24:86400,25:115200,26:172800,27:230400,28:307200,29:460800,30:691200,31:921600,32:1382400,33:1843200,34:2764800,35:3686400,36:4915200},34:{24:108e3,25:129600,26:172800,27:259200,28:345600,29:460800,30:691200,31:1036800,32:1382400,33:2073600,34:2764800,35:4147200,36:5529600,37:7372800},35:{25:144e3,26:172800,27:230400,28:345600,29:460800,30:614400,31:921600,32:1382400,33:1843200,34:2764800,35:3686400,36:5529600,37:7372800,38:9830400},36:{26:192e3,27:230400,28:307200,29:460800,30:614400,31:819200,32:1228800,33:1843200,34:2457600,35:3686400,36:4915200,37:7372800,38:9830400,39:13107200},37:{27:288e3,28:345600,29:460800,30:691200,31:921600,32:1228800,33:1843200,34:2764800,35:3686400,36:5529600,37:7372800,38:11059200,39:14745600,40:19660800},38:{28:432e3,29:518400,30:691200,31:1036800,32:1382400,33:1843200,34:2764800,35:4147200,36:5529600,37:8294400,38:11059200,39:16588800,40:22118400},39:{29:576e3,30:691200,31:921600,32:1382400,33:1843200,34:2457600,35:3686400,36:5529600,37:7372800,38:11059200,39:14745600,40:22118400},40:{30:768e3,31:921600,32:1228800,33:1843200,34:2457600,35:3276800,36:4915200,37:7372800,38:9830400,39:14745600,40:19660800}},s=(p,d)=>{const h=e[p];if(!h)return 0;const m=h[d];if(m!==void 0)return m;const A=K(p),E=d-p;let M=A;if(E>0)for(let g=0;g<E;g++)M=Math.floor(M*(g%2===0?3/2:4/3));else if(E<0)for(let g=0;g<Math.abs(E);g++)M=Math.floor(M*(g%2===0?2/3:3/4));return Math.max(0,M)},t=Math.max(1,Math.min(40,Math.floor(f))),n=Math.max(1,Math.floor(c));if(c===n)return s(t,n);const a=n+1,r=s(t,n),i=s(t,a),o=c-n,l=r+(i-r)*o;return Math.round(l)}function K(f){if(f<=11)return 300*f;const c={12:2600,13:2800,14:2400,15:2500};if(c[f])return c[f];let e=4800;const s=[1.5,1.5,4/3,4/3];for(let t=17;t<=f;t++){const n=s[(t-17)%4];e=Math.floor(e*n)}return e}function B(f,c,e){return f<=0||e<=0?0:Math.round(f*c/e)}function H(f){const c={.125:"⅛",.25:"¼",.33:"⅓",.333:"⅓",.5:"½",.66:"⅔",.667:"⅔",.75:"¾"};for(const[e,s]of Object.entries(c))if(Math.abs(f-parseFloat(e))<.01)return s;return Number.isInteger(f)?f.toString():f.toFixed(2)}function _(f){var t,n;const c=(t=window.CONFIG)!=null&&t.D35E?CONFIG.D35E.CHARACTER_EXP_LEVELS[game.settings.get("D35E","experienceRate")][Math.max(0,f-1)]:0,e=(n=window.CONFIG)!=null&&n.D35E?CONFIG.D35E.CHARACTER_EXP_LEVELS[game.settings.get("D35E","experienceRate")][Math.max(0,f)]:c+1e3;return Math.max(1,Number(e)-Number(c))/(13+1/3)}class q extends Application{constructor(){super(...arguments);N(this,"party",new Map);N(this,"enemies",new Map);N(this,"manualAwards",new Map);N(this,"elDelta",0);N(this,"showElDetails",!1);N(this,"isProcessing",!1);N(this,"lastAward",null)}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"motwmxp-calc",title:"MOTWM XP Calculator",width:960,height:660,resizable:!0,template:"modules/motwm-xp/templates/xp-calculator.hbs"})}getData(){const e=new Map;for(const u of this.enemies.values()){const P=Math.max(.125,Number(u.cr)||1);e.set(P,(e.get(P)??0)+1)}const s=[];for(const[u,P]of e.entries())s.push(C(u,P));const t=s.length?I(s):0,n=Number.isFinite(this.elDelta)?this.elDelta:0,a=t+n,r=[...this.party.values()].map(u=>u.level),i=r.length,o=u=>u<2?u:Math.pow(2,u/2),l=u=>u<2?u:2*Math.log2(u),p=r.length>0?r.reduce((u,P)=>u+P,0)/r.length:0;let d=0;if(r.length>0){const P=r.reduce((w,b)=>w+o(b),0)/4;d=l(P)}const h=a-d;let m="—";d>0&&a>0&&(h<-9?m="Trivial":h<-4?m="Very Easy":h<0?m="Easy":h===0?m="Challenging":h<=4?m="Very Difficult":h<=7?m="Overpowering":m="Unbeatable");const A=d>0&&a>0?`Party: ${i} PCs, Avg Lvl ${p.toFixed(1)}, Party Level ${d.toFixed(1)} | EL: ${a} | Difficulty: ${m} (${h>=0?"+":""}${h.toFixed(1)})`:"—";let E="";if(s.length>0){const u=[],P=[...e.entries()].map(([w,b])=>{const x=C(w,b);return{cr:w,count:b,groupEL:x,text:`${b}×CR${H(w)} → EL${x}`}}).sort((w,b)=>b.groupEL-w.groupEL);if(u.push(...P.map(w=>`└─ ${w.text}`)),P.length>1){const w=P.map(v=>v.groupEL).sort((v,L)=>L-v);let b=[],x=[...w];for(;x.length>1;){const v=x.shift(),L=x.shift(),X=Math.abs(v-L);let $=v;X===0?($=v+2,b.push(`EL${v} + EL${L} (same level) → EL${$}`)):X>=1&&X<=2?($=v+1,b.push(`EL${v} + EL${L} (−${X}) → EL${$}`)):X>=3&&X<=7?($=v+1,b.push(`EL${v} + EL${L} (−${X}, weak but helps) → EL${$}`)):b.push(`EL${v} + EL${L} (−${X}, too weak) → EL${v}`),x.push($),x.sort((W,j)=>j-W)}u.push(...b.map(v=>`    └─ ${v}`))}this.elDelta!==0&&u.push(`    └─ EL modifier ${this.elDelta>=0?"+":""}${this.elDelta} → EL${a}`),E=u.join(`
`)}const M=game.settings.get("motwm-xp","awardMode"),g=[...this.party.values()].map(u=>{var w,b;const P=((b=(w=this.manualAwards)==null?void 0:w.get)==null?void 0:b.call(w,u.id))??{amount:0,unit:"points",reason:""};return{...u,bubble:Math.round(_(u.level)),manual:P}});let T=[];const y=new Map;if(g.some(u=>u.earns)){if(M==="dmg35"){const u=g.filter(b=>b.earns),P=u.length,w=n;u.forEach(b=>{let x=0;for(const v of this.enemies.values()){const L=Number(v.cr)||1;x+=R(b.level,L,w,P)}y.set(b.id,x)})}else if(M==="split30"&&a>0){const u=Math.round(g.reduce((x,v)=>x+v.level,0)/Math.max(1,g.length)),P=F(u,a),w=g.filter(x=>x.earns),b=B(P,1,w.length);w.forEach(x=>{y.set(x.id,b)})}}g.forEach(u=>{const P=y.get(u.id)||0,w=this.manualAwards.get(u.id);let b=0;if(w&&w.amount){const v=_(u.level);b=Math.round(w.unit==="bubbles"?w.amount*v:w.amount)}const x=P+b;x>0&&T.push({id:u.id,name:u.name,level:u.level,el:a||"—",xp:x})});const k=[...this.enemies.entries()].map(([u,P])=>({...P,mapKey:u,cr:H(Number(P.cr)||0)}));return{party:g,enemies:k,el:a,encounterInfo:A,elBreakdown:E,showElDetails:this.showElDetails,elDelta:this.elDelta,preview:T,hasRollback:!!this.lastAward}}activateListeners(e){super.activateListeners(e),e.on("click","[data-action='remove-party']",s=>{const t=s.currentTarget.dataset.id;this.party.delete(t),this.render()}),e.on("click","[data-action='remove-enemy']",s=>{const t=s.currentTarget.dataset.id;this.enemies.delete(t),this.render()}),e.on("change","input[data-action='toggle-earns']",s=>{const t=s.currentTarget.dataset.id,n=this.party.get(t);n&&(n.earns=s.currentTarget.checked,this.render(!1))}),e.on("change blur","[data-action='el-delta']",s=>{const t=s.currentTarget.value.trim();if(t===""){this.elDelta=0,this.render(!0);return}if(t==="-"||t===".")return;const n=parseFloat(t);this.elDelta=Number.isFinite(n)?n:0,this.render(!0)}),e.on("change blur","[data-action='award-amount']",s=>{const t=s.currentTarget.closest("[data-id]"),n=t==null?void 0:t.dataset.id,a=this.manualAwards.get(n)??{amount:0,unit:"points",reason:""};this.manualAwards.set(n,{...a,amount:Number(s.currentTarget.value)||0}),this.render(!1)}),e.on("change","[data-action='award-unit']",s=>{const t=s.currentTarget.closest("[data-id]"),n=t==null?void 0:t.dataset.id,a=this.manualAwards.get(n)??{amount:0,unit:"points",reason:""};this.manualAwards.set(n,{...a,unit:s.currentTarget.value}),this.render(!1)}),e.on("input","[data-action='award-reason']",s=>{const t=s.currentTarget.closest("[data-id]"),n=t==null?void 0:t.dataset.id,a=this.manualAwards.get(n)??{amount:0,unit:"points",reason:""};this.manualAwards.set(n,{...a,reason:s.currentTarget.value??""})}),e.on("click","[data-action='add-online-assigned']",()=>this.addAssignedPlayersToPartyOnlineOnly()),e.on("click","[data-action='add-all-assigned']",()=>this.addAssignedPlayersToPartyAll()),e.on("click","[data-action='add-friendly-scene']",()=>this.addFriendlySceneTokensToParty()),e.on("click","[data-action='add-selected-party']",()=>this.addSelectedToParty()),e.on("click","[data-action='add-selected-enemies']",()=>this.addSelectedToEnemies()),e.on("click","[data-action='add-hostile-scene']",()=>this.addHostileSceneTokensToEnemies()),e.on("click","[data-action='add-neutral-scene']",()=>this.addNeutralSceneTokensToEnemies()),e.on("click","[data-action='clear-party']",()=>{this.party.clear(),this.render(!0)}),e.on("click","[data-action='clear-enemies']",()=>{this.enemies.clear(),this.render(!0)}),e.on("click","[data-action='apply-xp']",()=>this.applyXP()),e.on("click","[data-action='rollback-xp']",()=>this.rollbackXP()),e.on("click","[data-action='toggle-el-details']",()=>{this.showElDetails=!this.showElDetails,this.render(!1)}),e.on("dblclick",".party .row",s=>{var a;const t=s.target;if(t.tagName==="INPUT"||t.tagName==="SELECT"||t.tagName==="BUTTON"||t.closest("button"))return;const n=s.currentTarget.dataset.id;if(n){const r=(a=game.actors)==null?void 0:a.get(n);r!=null&&r.sheet&&r.sheet.render(!0)}}),e.on("dblclick",".enemies .row",s=>{var a;const t=s.target;if(t.tagName==="BUTTON"||t.closest("button"))return;const n=s.currentTarget.dataset.actorId;if(n){const r=(a=game.actors)==null?void 0:a.get(n);r!=null&&r.sheet&&r.sheet.render(!0)}})}getActorCR(e){const s=["system.details.totalCr","system.details.cr.total","system.attributes.cr.total","system.details.cr.value","system.details.cr","data.details.totalCr","data.details.cr.total","data.details.cr.value","data.details.cr"];for(const a of s){const r=Number(getProperty(e,a));if(Number.isFinite(r)&&r>0)return r}const t=e.type,n=Number(getProperty(e,"system.details.level.value"))||0;return t==="character"?Math.max(1,Math.floor(n)):Math.max(1,Math.floor(n)||1)}addHostileSceneTokensToEnemies(){var a,r,i,o,l;const e=((a=CONST==null?void 0:CONST.TOKEN_DISPOSITIONS)==null?void 0:a.HOSTILE)??-1,t=(((r=canvas.tokens)==null?void 0:r.placeables)??[]).filter(p=>{var d;return((d=p.document)==null?void 0:d.disposition)===e});let n=0;for(const p of t){const d=p.actor,h=p.id;if(!(d!=null&&d.id)||!h||this.enemies.has(h))continue;const m=d.name??"Unknown",A=d.img??((o=(i=d.prototypeToken)==null?void 0:i.texture)==null?void 0:o.src)??"icons/svg/skull.svg",E=this.getActorCR(d);this.enemies.set(h,{id:d.id,tokenId:h,name:m,img:A,cr:E}),n++}(l=ui.notifications)==null||l.info(`Added ${n} hostile token(s) from this scene.`),this.render(!0)}addNeutralSceneTokensToEnemies(){var a,r,i,o,l;const e=((a=CONST==null?void 0:CONST.TOKEN_DISPOSITIONS)==null?void 0:a.NEUTRAL)??0,t=(((r=canvas.tokens)==null?void 0:r.placeables)??[]).filter(p=>{var d;return((d=p.document)==null?void 0:d.disposition)===e});let n=0;for(const p of t){const d=p.actor,h=p.id;if(!(d!=null&&d.id)||!h||this.enemies.has(h))continue;const m=d.name??"Unknown",A=d.img??((o=(i=d.prototypeToken)==null?void 0:i.texture)==null?void 0:o.src)??"icons/svg/eye.svg",E=this.getActorCR(d);this.enemies.set(h,{id:d.id,tokenId:h,name:m,img:A,cr:E}),n++}(l=ui.notifications)==null||l.info(`Added ${n} neutral token(s) from this scene.`),this.render(!0)}addActorsToParty(e){var t,n;let s=0;for(const a of e){if(!(a!=null&&a.id)||this.party.has(a.id))continue;const r=a.name??"Unknown",i=a.img??((n=(t=a.prototypeToken)==null?void 0:t.texture)==null?void 0:n.src)??"icons/svg/mystery-man.svg",o=Number(getProperty(a,"system.details.level.value"))||1;this.party.set(a.id,{id:a.id,name:r,img:i,level:o,earns:!0,friend:!1}),s++}return s}addAssignedPlayersToPartyOnlineOnly(){var a,r;const t=(((a=game.users)==null?void 0:a.players)??[]).filter(i=>i.active).map(i=>i.character).filter(i=>!!i),n=this.addActorsToParty(t);(r=ui.notifications)==null||r.info(`Added ${n} online assigned PC(s).`),this.render(!0)}addAssignedPlayersToPartyAll(){var n,a;const s=(((n=game.users)==null?void 0:n.players)??[]).map(r=>r.character).filter(r=>!!r),t=this.addActorsToParty(s);(a=ui.notifications)==null||a.info(`Added ${t} assigned PC(s) (all logins).`),this.render(!0)}addFriendlySceneTokensToParty(){var a,r,i;const e=((a=CONST==null?void 0:CONST.TOKEN_DISPOSITIONS)==null?void 0:a.FRIENDLY)??1,t=(((r=canvas.tokens)==null?void 0:r.placeables)??[]).filter(o=>{var l;return((l=o.document)==null?void 0:l.disposition)===e}).map(o=>o.actor).filter(o=>!!o),n=this.addActorsToParty(t);(i=ui.notifications)==null||i.info(`Added ${n} Friendly token actor(s) from this scene.`),this.render(!0)}populateScenePlayers(){var a,r,i;const e=((a=CONST==null?void 0:CONST.TOKEN_DISPOSITIONS)==null?void 0:a.FRIENDLY)??1,s=((r=canvas.tokens)==null?void 0:r.placeables)??[],t=[];for(const o of s){const l=o.document,p=o.actor??void 0;if(!l||!p)continue;const d=l.disposition===e,h=p.type==="character";d&&h&&t.push(p)}const n=this.addActorsToParty(t);(i=ui.notifications)==null||i.info(`Added ${n} Friendly PC(s) from this scene.`),this.render(!0)}addFoundryParty(){var n,a,r,i;let e=[];const s=game.party;(n=s==null?void 0:s.members)!=null&&n.length&&(e=s.members.map(o=>o==null?void 0:o.actor).filter(o=>!!o)),e.length||(e=(a=game.users)==null?void 0:a.players.map(l=>l.character).filter(l=>!!l)),e.length||(e=(((r=canvas.tokens)==null?void 0:r.placeables)??[]).map(l=>l.actor).filter(l=>!!l&&l.type==="character"));const t=this.addActorsToParty(e);(i=ui.notifications)==null||i.info(`Added ${t} actor(s) from Foundry Party.`),this.render(!0)}_manualAwardsToGrants(){var s,t;const e=[];for(const[n,a]of this.manualAwards){if(!a||!a.amount)continue;const r=(s=game.actors)==null?void 0:s.get(n);if(!r)continue;const i=r.name??n,o=Number(getProperty(r,"system.details.level.value")??1),l=_(o),p=Math.round(a.unit==="bubbles"?a.amount*l:a.amount);p!==0&&e.push({id:n,name:i,xp:p,reason:((t=a.reason)==null?void 0:t.trim())||"Manual award"})}return e}populatePartyPlayers(){var n,a;let e=0,s=0;const t=((n=game.users)==null?void 0:n.players)??[];for(const r of t){const i=r.character;if(!i)continue;if(this.enemies.has(i.id)){s++;continue}const o=O.getLevel(i)||1,l={id:i.id,name:i.name??"Actor",img:i.img??"",level:o,earns:!0,friend:!i.hasPlayerOwner};this.party.has(i.id)?s++:(this.party.set(i.id,l),e++)}(a=ui.notifications)==null||a.info(`Party +${e}${s?`, skipped ${s}`:""}`),this.render()}addSelectedToParty(){var n,a,r;const e=((n=canvas==null?void 0:canvas.tokens)==null?void 0:n.controlled)??[];if(!e.length)return(a=ui.notifications)==null?void 0:a.warn("Select one or more tokens first.");let s=0,t=0;for(const i of e){const o=i.actor;if(!o){t++;continue}if(this.enemies.has(o.id)){t++;continue}const l=O.getLevel(o)||1,p={id:o.id,name:o.name??"Actor",img:o.img??"",level:l,earns:!0,friend:!o.hasPlayerOwner};this.party.has(o.id)?t++:(this.party.set(o.id,p),s++)}(r=ui.notifications)==null||r.info(`Party +${s}${t?`, skipped ${t}`:""}`),this.render()}addSelectedToEnemies(){var n,a,r,i,o;const e=((n=canvas==null?void 0:canvas.tokens)==null?void 0:n.controlled)??[];if(!e.length){(a=ui.notifications)==null||a.warn("Select one or more tokens first.");return}let s=0,t=0;for(const l of e){const p=l.actor,d=l.id;if(!p||!d){t++;continue}if(this.party.has(p.id)||this.enemies.has(d)){t++;continue}const h=this.getActorCR(p);if(!Number.isFinite(h)||h<=0){t++;continue}const m=p.img??((i=(r=p.prototypeToken)==null?void 0:r.texture)==null?void 0:i.src)??"icons/svg/skull.svg",A=p.name??"Enemy",E={id:p.id,tokenId:d,name:A,img:m,cr:Number(h)};this.enemies.set(d,E),s++}(o=ui.notifications)==null||o.info(`Enemies +${s}${t?`, skipped ${t}`:""}`),this.render(!0)}addTargetedToEnemies(){var n,a,r;const e=((n=game.user)==null?void 0:n.targets)??new Set;if(!e.size)return(a=ui.notifications)==null?void 0:a.warn("Target one or more creatures first.");let s=0,t=0;for(const i of e){const o=i.actor,l=i.id;if(!o||!l){t++;continue}if(this.party.has(o.id)){t++;continue}const p=O.getCR(o);if(!p){t++;continue}const d={id:o.id,tokenId:l,name:o.name??"Enemy",img:o.img??"",cr:Number(p)};this.enemies.has(l)?t++:(this.enemies.set(l,d),s++)}(r=ui.notifications)==null||r.info(`Enemies +${s}${t?`, skipped ${t}`:""}`),this.render()}async applyXP(){var e,s,t,n;if(this.isProcessing){(e=ui.notifications)==null||e.warn("XP operation already in progress...");return}this.isProcessing=!0;try{const a={enemies:new Map(this.enemies),manualAwards:new Map(this.manualAwards),elDelta:this.elDelta},r=[],i=[...this.party.values()],o=i.filter(M=>M.earns),l=new Map;for(const M of a.enemies.values()){const g=Math.max(.125,Number(M.cr)||1);l.set(g,(l.get(g)??0)+1)}const p=[];for(const[M,g]of l.entries())p.push(C(M,g));let d=p.length?I(p):0;d+=a.elDelta;const h=game.settings.get("motwm-xp","awardMode");if(o.length){if(h==="dmg35"){const M=o.length,g=a.elDelta;for(const T of o){let y=0;for(const k of a.enemies.values()){const u=Number(k.cr)||1;y+=R(T.level,u,g,M)}r.push({id:T.id,name:T.name,xp:y})}}else if(h==="split30"&&d>0){const M=Math.round(i.reduce((y,k)=>y+k.level,0)/Math.max(1,i.length)),g=F(M,d),T=B(g,1,o.length);for(const y of o)r.push({id:y.id,name:y.name,xp:T})}}const m=this._manualAwardsToGrants();if(!r.length&&!m.length){(s=ui.notifications)==null||s.info("No XP to award: add enemies and/or manual awards first.");return}const A=async M=>{var g;for(const T of M){const y=(g=game.actors)==null?void 0:g.get(T.id);if(!y)continue;const k=Number(getProperty(y,"system.details.xp.value")??0);await y.update({"system.details.xp.value":k+T.xp})}};r.length&&await A(r),m.length&&await A(m);const E=[];if(game.settings.get("motwm-xp","broadcastChat")){const M=T=>{var y;try{return TextEditor.escapeHTML(String(T??""))}catch{return(y=foundry.utils)!=null&&y.escapeHTML?foundry.utils.escapeHTML(String(T??"")):String(T??"").replace(/[&<>"']/g,k=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[k])}},g=T=>`<ul>${T.map(y=>{const k=M(y.name),u=y.reason?` <em>(${M(y.reason)})</em>`:"";return`<li><b>${k}</b>: +${y.xp.toLocaleString()} XP${u}</li>`}).join("")}</ul>`;if(r.length){const T=`<div><h3>Encounter XP Awards</h3>${g(r)}</div>`,y=await ChatMessage.create({content:T});y!=null&&y.id&&E.push(y.id)}if(m.length){const T=m.map(u=>{var P;return{...u,reason:((P=a.manualAwards.get(u.id))==null?void 0:P.reason)||"Manual award"}}),y=`<div><h3>Manual XP Awards</h3>${g(T)}</div>`,k=await ChatMessage.create({content:y});k!=null&&k.id&&E.push(k.id)}}this.lastAward={enemies:a.enemies,manualAwards:a.manualAwards,elDelta:a.elDelta,grants:[...r,...m],chatMessageIds:E},this.enemies.clear(),this.manualAwards.clear(),this.elDelta=0,(t=ui.notifications)==null||t.info("XP awarded successfully."),this.render(!0)}catch(a){console.error("Error applying XP:",a),(n=ui.notifications)==null||n.error("Failed to apply XP. See console for details.")}finally{this.isProcessing=!1}}async rollbackXP(){var e,s,t,n,a;if(this.isProcessing){(e=ui.notifications)==null||e.warn("XP operation already in progress...");return}if(!this.lastAward){(s=ui.notifications)==null||s.warn("No XP award to rollback.");return}this.isProcessing=!0;try{const r=this.lastAward;this.lastAward=null;for(const o of r.chatMessageIds){const l=(t=game.messages)==null?void 0:t.get(o);await(l==null?void 0:l.delete())}await(async o=>{var l;for(const p of o){const d=(l=game.actors)==null?void 0:l.get(p.id);if(!d)continue;const h=Number(getProperty(d,"system.details.xp.value")??0);await d.update({"system.details.xp.value":h-p.xp})}})(r.grants),this.enemies=new Map(r.enemies),this.manualAwards=new Map(r.manualAwards),this.elDelta=r.elDelta,(n=ui.notifications)==null||n.info("XP award rolled back successfully."),this.render(!0)}catch(r){console.error("Error rolling back XP:",r),(a=ui.notifications)==null||a.error("Failed to rollback XP. See console for details.")}finally{this.isProcessing=!1}}}class G extends Application{constructor(e,s={}){super({popOut:!1,id:"motwmxp-bar",...s});N(this,"actor");N(this,"_dragging",!1);N(this,"_dragOffset",{x:0,y:0});N(this,"_wired",!1);this.actor=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"motwmxp-bar",template:"modules/motwm-xp/templates/xp-bar.hbs"})}_getSavedPos(){const e=game.settings.get("motwm-xp","barPos");if(!e)return null;try{const s=JSON.parse(e);return s&&Number.isFinite(s.left)&&Number.isFinite(s.top)?s:null}catch{return null}}async _savePos(e,s){await game.settings.set("motwm-xp","barPos",JSON.stringify({left:e,top:s}))}_applyPos(){const e=this.element[0];if(!e)return;const s=this._getSavedPos();if(e.style.position="fixed",e.style.zIndex="70000",s)e.style.left=`${s.left}px`,e.style.top=`${s.top}px`;else{const t=e.getBoundingClientRect().width||520,n=e.getBoundingClientRect().height||18,a=Math.round((window.innerWidth-t)/2),r=Math.round(window.innerHeight-n-8);e.style.left=`${a}px`,e.style.top=`${r}px`}}getData(){const e=Number(getProperty(this.actor,"system.details.level.value")??1),s=Number(getProperty(this.actor,"system.details.xp.value")??0),t=getProperty(this.actor,"system.details.xp.max"),n=Number(t??S(e+1)),r=[S(e),n,S(e+2),S(e+3)];let i=Math.max(0,s-r[0]);const o=[];for(let m=0;m<3;m++){const A=Math.max(1,r[m+1]-r[m]),E=Math.max(0,Math.min(1,i/A));o.push({class:`layer${m}`,width:Math.round(E*1e4)/100}),i=Math.max(0,i-A)}const l=[],p=V;for(let m=1;m<=13;m++)l.push({left:m/p*100,class:""});l.push({left:13/p*100,class:"mini"});const d=`Lv ${e} | ${s.toLocaleString()} / ${n.toLocaleString()} XP`,h=`Level: ${e}`;return{layers:o,segments:l,label:d,tooltip:h}}async _render(e,s){await super._render(e,s),this._applyPos();const t=this.element[0];t&&(t.addEventListener("pointerdown",n=>{var r,i;n.preventDefault();const a=t.getBoundingClientRect();t.style.left=`${a.left}px`,t.style.top=`${a.top}px`,this._dragging=!0,(i=(r=n.currentTarget).setPointerCapture)==null||i.call(r,n.pointerId),this._dragOffset.x=n.clientX-a.left,this._dragOffset.y=n.clientY-a.top}),!this._wired&&(this._wired=!0,window.addEventListener("pointermove",n=>{if(!this._dragging)return;const a=this.element[0];if(!a)return;const r=Math.max(0,Math.min(window.innerWidth-50,n.clientX-this._dragOffset.x)),i=Math.max(0,Math.min(window.innerHeight-24,n.clientY-this._dragOffset.y));a.style.left=`${r}px`,a.style.top=`${i}px`}),window.addEventListener("pointerup",async()=>{if(!this._dragging)return;this._dragging=!1;const n=this.element[0];if(!n)return;const a=parseInt(n.style.left||"0",10),r=parseInt(n.style.top||"0",10);await this._savePos(a,r)}),window.addEventListener("resize",()=>this._applyPos(),{passive:!0})))}render(e,s){return game.settings.get("motwm-xp","showPlayerBar")?super.render(e,s):this}}Hooks.once("init",()=>{Y(),window.MOTWM_XP=window.MOTWM_XP??{bars:new Map},window.MOTWM_XP.XpBarApp=G});Hooks.once("ready",()=>{var e;const f=game.settings.get("motwm-xp","showPlayerBar"),c=(e=game.user)==null?void 0:e.character;if(f&&c){const s=window.MOTWM_XP.bars;let t=s.get(c.id);t||(t=new G(c,{top:window.innerHeight-54,left:0}),s.set(c.id,t)),t.render(!0)}Hooks.on("updateActor",(s,t)=>{var r;const n=(r=game.user)==null?void 0:r.character;if(!n||s.id!==n.id)return;const a=window.MOTWM_XP.bars.get(n.id);a==null||a.render(!0)}),Hooks.on("updateSetting",(s,t)=>{var n;if(s.key==="motwm-xp.awardMode"&&((n=window.MOTWM_XP)!=null&&n.calc)){const a=window.MOTWM_XP.calc;a.element&&a.render(!1)}})});Hooks.on("getSceneControlButtons",f=>{var e,s;if(!((e=game.user)!=null&&e.isGM))return;const c=f.find(t=>t.name==="token");(s=c==null?void 0:c.tools)==null||s.push({name:"motwm-xp-calc",title:"Open XP Calculator",icon:"fas fa-calculator",visible:!0,onClick:()=>{var t;(t=window.MOTWM_XP)!=null&&t.calc||(window.MOTWM_XP.calc=new q),window.MOTWM_XP.calc.render(!0)},button:!0})});
//# sourceMappingURL=main.js.map
