var B=Object.defineProperty;var H=(u,l,e)=>l in u?B(u,l,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[l]=e;var T=(u,l,e)=>H(u,typeof l!="symbol"?l+"":l,e);function G(){game.settings.register("motwm-xp","broadcastChat",{name:"Broadcast XP to Chat",scope:"world",config:!0,type:Boolean,default:!1}),game.settings.register("motwm-xp","showPlayerBar",{name:"Show Player XP Bar",scope:"client",config:!0,type:Boolean,default:!0}),game.settings.register("motwm-xp","barPos",{name:"XP Bar Position",scope:"client",config:!1,type:String,default:""}),game.settings.register("motwm-xp","awardMode",{name:"XP Award Method",hint:"RAW 3.5e = per-PC (Level vs EL). Classic 3.0 = split single pot based on APL.",scope:"world",config:!0,type:String,choices:{raw35:"D&D 3.5e (per-PC)",split30:"D&D 3.0 (split pot)"},default:"raw35"})}class S{static getXP(l){const e=getProperty(l,"system.details.xp.value");return Number(e??0)}static async setXP(l,e){return l.update({"system.details.xp.value":Number(e)})}static getLevel(l){const e=getProperty(l,"system.classes");if(e&&typeof e=="object"){let t=0;for(const n of Object.values(e)){const a=Number(getProperty(n,"level")??0);t+=a}if(t>0)return t}const s=getProperty(l,"system.details.level.value");return Number(s??0)}static getCR(l){const e=getProperty(l,"system.details.cr.value");if(e!=null)return Number(e);const s=this.getLevel(l);return s?Number(s):null}}function O(u,l){if(l<=0)return-1/0;let e=u,s=l;for(;s>=2;)e+=2,s=Math.floor(s/2);return e}function C(u){if(!u.length)return-1/0;let l=u.slice().sort((e,s)=>e-s);for(;l.length>1;){const e=l.pop(),s=l.pop(),t=Math.abs(e-s);let n=e;t===0?n=e+2:t===1||t===2?n=e+1:n=e,l.push(n),l.sort((a,o)=>a-o)}return l[0]}function $(u){var t,n;const l=Math.max(1,Math.floor(u)),e=game.settings.get("D35E","experienceRate"),s=(n=(t=CONFIG==null?void 0:CONFIG.D35E)==null?void 0:t.CHARACTER_EXP_LEVELS)==null?void 0:n[e];return Array.isArray(s)?Number(s[Math.min(l-1,s.length-1)]??0):Math.floor(1e3*((l-1)*l)/2)}function W(){return 13+1/3}function _(u,l){if(u<=0)return 0;const e=75*u,s=l-u,t=Math.floor(s/2),n=Math.pow(2,t);return Math.max(0,Math.round(e*n))}function X(u,l){const e={1:{1:300,2:600,3:900,4:1350,5:1800,6:2700,7:3600,8:5400,9:7200,10:10800},2:{1:300,2:600,3:900,4:1350,5:1800,6:2700,7:3600,8:5400,9:7200,10:10800},3:{1:300,2:600,3:900,4:1350,5:1800,6:2700,7:3600,8:5400,9:7200,10:10800},4:{1:300,2:600,3:800,4:1200,5:1600,6:2400,7:3200,8:4800,9:6400,10:9600,11:12800,12:18e3,13:21600,14:28800},5:{1:300,2:500,3:750,4:1e3,5:1500,6:2250,7:3e3,8:4500,9:6e3,10:9e3,11:12e3,12:18e3,13:21600,14:28800,15:28800},6:{1:300,2:450,3:600,4:900,5:1200,6:1800,7:2400,8:3600,9:4800,10:7200,11:10800,12:14400,13:21600,14:25200,15:28800,16:28800},7:{1:263,2:394,3:525,4:700,5:1050,6:1400,7:2100,8:3150,9:4200,10:6300,11:8400,12:12600,13:16800,14:25200,15:28800},8:{1:200,2:300,3:450,4:600,5:875,6:1200,7:1600,8:2400,9:3600,10:4800,11:6300,12:8400,13:12600,14:16800,15:25200,16:28800},9:{1:0,2:225,3:338,4:506,5:675,6:1013,7:1350,8:2025,9:2700,10:4050,11:5400,12:8100,13:10800,14:16200,15:21600,16:32400,17:36e3,18:39600},10:{3:250,4:375,5:563,6:750,7:1e3,8:1500,9:2e3,10:3e3,11:3600,12:4800,13:6400,14:9600},11:{4:275,5:413,6:619,7:825,8:1238,9:1650,10:2475,11:3300,12:4950,13:6600,14:9900,15:13200,16:17600,17:26400,18:39600},12:{5:300,6:450,7:675,8:900,9:1350,10:1800,11:1950,12:2600,13:3900,14:5850,15:7800,16:11700,17:15600,18:23400,19:31200,20:46800},13:{6:325,7:488,8:731,9:975,10:1463,11:1400,12:2100,13:2800,14:4200,15:6300,16:8400,17:12600,18:18900,19:25200,20:33600},14:{6:350,7:525,8:788,9:1050,10:1575,11:900,12:1200,13:1800,14:2400,15:4200,16:4800,17:7200,18:10800,19:13500,20:18900},15:{7:375,8:563,9:844,10:1125,11:638,12:850,13:1275,14:1900,15:2500,16:4800,17:7200,18:10800,19:13500,20:18900},16:{7:400,8:600,9:900,10:1350,11:900,12:1200,13:1800,14:2400,15:3200,16:4800,17:7200,18:10800,19:14400,20:19200},17:{8:425,9:638,10:956,11:900,12:1200,13:1800,14:2400,15:3200,16:4800,17:7200,18:10800,19:14400,20:19200},18:{8:450,9:675,10:1013,11:638,12:850,13:1275,14:1900,15:2500,16:4800,17:7200,18:10800,19:14400,20:19200},19:{9:475,10:713,11:638,12:850,13:1275,14:1900,15:2500,16:4800,17:7200,18:10800,19:14400,20:19200},20:{10:750,11:900,12:1200,13:1800,14:2400,15:3200,16:4800,17:7200,18:10800,19:14400,20:19200},21:{11:1125,12:1350,13:1800,14:2700,15:3600,16:4800,17:7200,18:10800,19:14400,20:21600,21:28800,22:43200,23:57600,24:76800},22:{12:1688,13:2025,14:2700,15:4050,16:5400,17:7200,18:10800,19:16200,20:21600,21:32400,22:43200,23:64800,24:86400,25:115200},23:{13:2250,14:2700,15:3600,16:5400,17:7200,18:9600,19:14400,20:21600,21:28800,22:43200,23:57600,24:86400,25:115200,26:153600},24:{14:3e3,15:3600,16:4800,17:7200,18:9600,19:12800,20:19200,21:28800,22:38400,23:57600,24:76800,25:115200,26:153600,27:204800},25:{15:4500,16:5400,17:7200,18:10800,19:14400,20:19200,21:28800,22:43200,23:57600,24:86400,25:115200,26:172800,27:230400,28:307200},26:{16:6750,17:8100,18:10800,19:16200,20:21600,21:28800,22:43200,23:64800,24:86400,25:129600,26:172800,27:259200,28:345600,29:460800},27:{17:9e3,18:10800,19:14400,20:21600,21:28800,22:38400,23:57600,24:86400,25:115200,26:172800,27:230400,28:345600,29:460800,30:614400},28:{18:12e3,19:14400,20:19200,21:28800,22:38400,23:51200,24:76800,25:115200,26:153600,27:230400,28:307200,29:460800,30:614400,31:819200},29:{19:18e3,20:21600,21:28800,22:43200,23:57600,24:76800,25:115200,26:172800,27:230400,28:345600,29:460800,30:691200,31:921600,32:1228800},30:{20:27e3,21:32400,22:43200,23:64800,24:86400,25:115200,26:172800,27:259200,28:345600,29:518400,30:691200,31:1036800,32:1382400,33:1843200},31:{21:36e3,22:43200,23:57600,24:86400,25:115200,26:153600,27:230400,28:345600,29:460800,30:691200,31:921600,32:1382400,33:1843200,34:2457600},32:{22:48e3,23:57600,24:76800,25:115200,26:153600,27:204800,28:307200,29:460800,30:614400,31:921600,32:1228800,33:1843200,34:2457600,35:3276800},33:{23:72e3,24:86400,25:115200,26:172800,27:230400,28:307200,29:460800,30:691200,31:921600,32:1382400,33:1843200,34:2764800,35:3686400,36:4915200},34:{24:108e3,25:129600,26:172800,27:259200,28:345600,29:460800,30:691200,31:1036800,32:1382400,33:2073600,34:2764800,35:4147200,36:5529600,37:7372800},35:{25:144e3,26:172800,27:230400,28:345600,29:460800,30:614400,31:921600,32:1382400,33:1843200,34:2764800,35:3686400,36:5529600,37:7372800,38:9830400},36:{26:192e3,27:230400,28:307200,29:460800,30:614400,31:819200,32:1228800,33:1843200,34:2457600,35:3686400,36:4915200,37:7372800,38:9830400,39:13107200},37:{27:288e3,28:345600,29:460800,30:691200,31:921600,32:1228800,33:1843200,34:2764800,35:3686400,36:5529600,37:7372800,38:11059200,39:14745600,40:19660800},38:{28:432e3,29:518400,30:691200,31:1036800,32:1382400,33:1843200,34:2764800,35:4147200,36:5529600,37:8294400,38:11059200,39:16588800,40:22118400},39:{29:576e3,30:691200,31:921600,32:1382400,33:1843200,34:2457600,35:3686400,36:5529600,37:7372800,38:11059200,39:14745600,40:22118400},40:{30:768e3,31:921600,32:1228800,33:1843200,34:2457600,35:3276800,36:4915200,37:7372800,38:9830400,39:14745600,40:19660800}},s=Math.max(1,Math.min(40,Math.floor(u))),t=Math.max(1,Math.floor(l)),n=e[s];if(!n)return 0;const a=n[t];if(a!==void 0)return a;const o=z(s),c=t-s;let r=o;if(c>0)for(let d=0;d<c;d++)r=Math.floor(r*(d%2===0?3/2:4/3));else if(c<0)for(let d=0;d<Math.abs(c);d++)r=Math.floor(r*(d%2===0?2/3:3/4));return Math.max(0,r)}function z(u){if(u<=11)return 300*u;const l={12:2600,13:2800,14:2400,15:2500};if(l[u])return l[u];let e=4800;const s=[1.5,1.5,4/3,4/3];for(let t=17;t<=u;t++){const n=s[(t-17)%4];e=Math.floor(e*n)}return e}function I(u,l,e){return u<=0||e<=0?0:Math.round(u*l/e)}function D(u){var t,n;const l=(t=window.CONFIG)!=null&&t.D35E?CONFIG.D35E.CHARACTER_EXP_LEVELS[game.settings.get("D35E","experienceRate")][Math.max(0,u-1)]:0,e=(n=window.CONFIG)!=null&&n.D35E?CONFIG.D35E.CHARACTER_EXP_LEVELS[game.settings.get("D35E","experienceRate")][Math.max(0,u)]:l+1e3;return Math.max(1,Number(e)-Number(l))/(13+1/3)}class j extends Application{constructor(){super(...arguments);T(this,"party",new Map);T(this,"enemies",new Map);T(this,"manualAwards",new Map);T(this,"elDelta",0);T(this,"showElDetails",!1);T(this,"lastAward",null)}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"motwmxp-calc",title:"MOTWM XP Calculator",width:960,height:660,resizable:!0,template:"modules/motwm-xp/templates/xp-calculator.hbs"})}getData(){const e=new Map;for(const h of this.enemies.values()){const x=Math.max(1,Math.floor(Number(h.cr)||0));e.set(x,(e.get(x)??0)+1)}const s=[];for(const[h,x]of e.entries())s.push(O(h,x));const t=s.length?C(s):0,n=Number.isFinite(this.elDelta)?Math.trunc(this.elDelta):0,a=t+n,o=[...this.party.values()].map(h=>h.level),c=o.length,r=o.length>0?Math.round(o.reduce((h,x)=>h+x,0)/o.length*10)/10:0;let d=0;c>=6?d=Math.floor((c-4)/2):c<=3&&(d=-1);const i=r+d,g=a-i;let p="—";r>0&&a>0&&(g<0?p="Easy":g===0?p="Even":g===1?p="Challenging":g===2?p="Very Challenging":p="High Risk");const f=r>0&&a>0?`APL: ${i.toFixed(1)} (${r} base, ${d>=0?"+":""}${d} size) | EL: ${a} | Difficulty: ${p} (${g>=0?"+":""}${g})`:"—";let y="";if(s.length>0){const h=[],x=[...e.entries()].map(([w,M])=>{const v=O(w,M);return{cr:w,count:M,groupEL:v,text:`${M}×CR${w} → EL${v}`}}).sort((w,M)=>M.groupEL-w.groupEL);if(h.push(...x.map(w=>`└─ ${w.text}`)),x.length>1){const w=x.map(P=>P.groupEL).sort((P,k)=>k-P);let M=[],v=[...w];for(;v.length>1;){const P=v.shift(),k=v.shift(),L=Math.abs(P-k);let N=P;L===0?(N=P+2,M.push(`EL${P} + EL${k} (same) → EL${N}`)):L===1||L===2?(N=P+1,M.push(`EL${P} + EL${k} (±${L}) → EL${N}`)):M.push(`EL${P} + EL${k} (±${L}, negligible) → EL${P}`),v.push(N),v.sort((R,F)=>F-R)}h.push(...M.map(P=>`    └─ ${P}`))}this.elDelta!==0&&h.push(`    └─ EL modifier ${this.elDelta>=0?"+":""}${this.elDelta} → EL${a}`),y=h.join(`
`)}const m=game.settings.get("motwm-xp","awardMode"),b=[...this.party.values()].map(h=>{var w,M;const x=((M=(w=this.manualAwards)==null?void 0:w.get)==null?void 0:M.call(w,h.id))??{amount:0,unit:"points",reason:""};return{...h,bubble:Math.round(D(h.level)),manual:x}});let E=[];const A=new Map;if(a>0&&b.some(h=>h.earns)){if(m==="raw35")b.filter(h=>h.earns).forEach(h=>{A.set(h.id,_(h.level,a))});else if(m==="split30"){const h=Math.round(b.reduce((v,P)=>v+P.level,0)/Math.max(1,b.length)),x=X(h,a),w=b.filter(v=>v.earns),M=I(x,1,w.length);w.forEach(v=>{A.set(v.id,M)})}}return b.forEach(h=>{const x=A.get(h.id)||0,w=this.manualAwards.get(h.id);let M=0;if(w&&w.amount){const P=D(h.level);M=Math.round(w.unit==="bubbles"?w.amount*P:w.amount)}const v=x+M;v>0&&E.push({id:h.id,name:h.name,level:h.level,el:a||"—",xp:v})}),{party:b,enemies:[...this.enemies.values()],el:a,encounterInfo:f,elBreakdown:y,showElDetails:this.showElDetails,elDelta:this.elDelta,preview:E,hasRollback:!!this.lastAward}}activateListeners(e){super.activateListeners(e),e.on("click","[data-action='remove-party']",s=>{const t=s.currentTarget.dataset.id;this.party.delete(t),this.render()}),e.on("click","[data-action='remove-enemy']",s=>{const t=s.currentTarget.dataset.id;this.enemies.delete(t),this.render()}),e.on("change","input[data-action='toggle-earns']",s=>{const t=s.currentTarget.dataset.id,n=this.party.get(t);n&&(n.earns=s.currentTarget.checked,this.render(!1))}),e.on("change blur","[data-action='el-delta']",s=>{const t=s.currentTarget.value.trim();if(t===""||t==="-")return;const n=parseInt(t,10);this.elDelta=Number.isFinite(n)?n:0,this.render(!0)}),e.on("input","[data-action='award-amount']",s=>{const t=s.currentTarget.closest("[data-id]"),n=t==null?void 0:t.dataset.id,a=this.manualAwards.get(n)??{amount:0,unit:"points",reason:""};this.manualAwards.set(n,{...a,amount:Number(s.currentTarget.value)||0})}),e.on("change","[data-action='award-unit']",s=>{const t=s.currentTarget.closest("[data-id]"),n=t==null?void 0:t.dataset.id,a=this.manualAwards.get(n)??{amount:0,unit:"points",reason:""};this.manualAwards.set(n,{...a,unit:s.currentTarget.value})}),e.on("input","[data-action='award-reason']",s=>{const t=s.currentTarget.closest("[data-id]"),n=t==null?void 0:t.dataset.id,a=this.manualAwards.get(n)??{amount:0,unit:"points",reason:""};this.manualAwards.set(n,{...a,reason:s.currentTarget.value??""})}),e.on("click","[data-action='add-online-assigned']",()=>this.addAssignedPlayersToPartyOnlineOnly()),e.on("click","[data-action='add-all-assigned']",()=>this.addAssignedPlayersToPartyAll()),e.on("click","[data-action='add-friendly-scene']",()=>this.addFriendlySceneTokensToParty()),e.on("click","[data-action='add-selected-party']",()=>this.addSelectedToParty()),e.on("click","[data-action='add-selected-enemies']",()=>this.addSelectedToEnemies()),e.on("click","[data-action='add-hostile-scene']",()=>this.addHostileSceneTokensToEnemies()),e.on("click","[data-action='add-neutral-scene']",()=>this.addNeutralSceneTokensToEnemies()),e.on("click","[data-action='clear-party']",()=>{this.party.clear(),this.render(!0)}),e.on("click","[data-action='clear-enemies']",()=>{this.enemies.clear(),this.render(!0)}),e.on("click","[data-action='apply-xp']",()=>this.applyXP()),e.on("click","[data-action='rollback-xp']",()=>this.rollbackXP()),e.on("click","[data-action='toggle-el-details']",()=>{this.showElDetails=!this.showElDetails,this.render(!1)}),e.on("dblclick",".party .row",s=>{var a;const t=s.target;if(t.tagName==="INPUT"||t.tagName==="SELECT"||t.tagName==="BUTTON"||t.closest("button"))return;const n=s.currentTarget.dataset.id;if(n){const o=(a=game.actors)==null?void 0:a.get(n);o!=null&&o.sheet&&o.sheet.render(!0)}}),e.on("dblclick",".enemies .row",s=>{var a;const t=s.target;if(t.tagName==="BUTTON"||t.closest("button"))return;const n=s.currentTarget.dataset.id;if(n){const o=(a=game.actors)==null?void 0:a.get(n);o!=null&&o.sheet&&o.sheet.render(!0)}})}getActorCR(e){const s=["system.details.cr.value","system.details.cr","data.details.cr.value","data.details.cr"];for(const a of s){const o=Number(getProperty(e,a));if(Number.isFinite(o)&&o>0)return Math.round(o)}const t=e.type,n=Number(getProperty(e,"system.details.level.value"))||0;return t==="character"?Math.max(1,Math.floor(n)):Math.max(1,Math.floor(n)||1)}addHostileSceneTokensToEnemies(){var a,o,c,r,d;const e=((a=CONST==null?void 0:CONST.TOKEN_DISPOSITIONS)==null?void 0:a.HOSTILE)??-1,t=(((o=canvas.tokens)==null?void 0:o.placeables)??[]).filter(i=>{var g;return((g=i.document)==null?void 0:g.disposition)===e}).map(i=>i.actor).filter(i=>!!i);let n=0;for(const i of t){if(!(i!=null&&i.id)||this.enemies.has(i.id))continue;const g=i.name??"Unknown",p=i.img??((r=(c=i.prototypeToken)==null?void 0:c.texture)==null?void 0:r.src)??"icons/svg/skull.svg",f=this.getActorCR(i);this.enemies.set(i.id,{id:i.id,name:g,img:p,cr:f}),n++}(d=ui.notifications)==null||d.info(`Added ${n} hostile actor(s) from this scene.`),this.render(!0)}addNeutralSceneTokensToEnemies(){var a,o,c,r,d;const e=((a=CONST==null?void 0:CONST.TOKEN_DISPOSITIONS)==null?void 0:a.NEUTRAL)??0,t=(((o=canvas.tokens)==null?void 0:o.placeables)??[]).filter(i=>{var g;return((g=i.document)==null?void 0:g.disposition)===e}).map(i=>i.actor).filter(i=>!!i);let n=0;for(const i of t){if(!(i!=null&&i.id)||this.enemies.has(i.id))continue;const g=i.name??"Unknown",p=i.img??((r=(c=i.prototypeToken)==null?void 0:c.texture)==null?void 0:r.src)??"icons/svg/eye.svg",f=this.getActorCR(i);this.enemies.set(i.id,{id:i.id,name:g,img:p,cr:f}),n++}(d=ui.notifications)==null||d.info(`Added ${n} neutral actor(s) from this scene.`),this.render(!0)}addActorsToParty(e){var t,n;let s=0;for(const a of e){if(!(a!=null&&a.id)||this.party.has(a.id))continue;const o=a.name??"Unknown",c=a.img??((n=(t=a.prototypeToken)==null?void 0:t.texture)==null?void 0:n.src)??"icons/svg/mystery-man.svg",r=Number(getProperty(a,"system.details.level.value"))||1;this.party.set(a.id,{id:a.id,name:o,img:c,level:r,earns:!0,friend:!1}),s++}return s}addAssignedPlayersToPartyOnlineOnly(){var a,o;const t=(((a=game.users)==null?void 0:a.players)??[]).filter(c=>c.active).map(c=>c.character).filter(c=>!!c),n=this.addActorsToParty(t);(o=ui.notifications)==null||o.info(`Added ${n} online assigned PC(s).`),this.render(!0)}addAssignedPlayersToPartyAll(){var n,a;const s=(((n=game.users)==null?void 0:n.players)??[]).map(o=>o.character).filter(o=>!!o),t=this.addActorsToParty(s);(a=ui.notifications)==null||a.info(`Added ${t} assigned PC(s) (all logins).`),this.render(!0)}addFriendlySceneTokensToParty(){var a,o,c;const e=((a=CONST==null?void 0:CONST.TOKEN_DISPOSITIONS)==null?void 0:a.FRIENDLY)??1,t=(((o=canvas.tokens)==null?void 0:o.placeables)??[]).filter(r=>{var d;return((d=r.document)==null?void 0:d.disposition)===e}).map(r=>r.actor).filter(r=>!!r),n=this.addActorsToParty(t);(c=ui.notifications)==null||c.info(`Added ${n} Friendly token actor(s) from this scene.`),this.render(!0)}populateScenePlayers(){var a,o,c;const e=((a=CONST==null?void 0:CONST.TOKEN_DISPOSITIONS)==null?void 0:a.FRIENDLY)??1,s=((o=canvas.tokens)==null?void 0:o.placeables)??[],t=[];for(const r of s){const d=r.document,i=r.actor??void 0;if(!d||!i)continue;const g=d.disposition===e,p=i.type==="character";g&&p&&t.push(i)}const n=this.addActorsToParty(t);(c=ui.notifications)==null||c.info(`Added ${n} Friendly PC(s) from this scene.`),this.render(!0)}addFoundryParty(){var n,a,o,c;let e=[];const s=game.party;(n=s==null?void 0:s.members)!=null&&n.length&&(e=s.members.map(r=>r==null?void 0:r.actor).filter(r=>!!r)),e.length||(e=(a=game.users)==null?void 0:a.players.map(d=>d.character).filter(d=>!!d)),e.length||(e=(((o=canvas.tokens)==null?void 0:o.placeables)??[]).map(d=>d.actor).filter(d=>!!d&&d.type==="character"));const t=this.addActorsToParty(e);(c=ui.notifications)==null||c.info(`Added ${t} actor(s) from Foundry Party.`),this.render(!0)}_manualAwardsToGrants(){var s,t;const e=[];for(const[n,a]of this.manualAwards){if(!a||!a.amount)continue;const o=(s=game.actors)==null?void 0:s.get(n);if(!o)continue;const c=o.name??n,r=Number(getProperty(o,"system.details.level.value")??1),d=D(r),i=Math.round(a.unit==="bubbles"?a.amount*d:a.amount);i!==0&&e.push({id:n,name:c,xp:i,reason:((t=a.reason)==null?void 0:t.trim())||"Manual award"})}return e}populatePartyPlayers(){var n,a;let e=0,s=0;const t=((n=game.users)==null?void 0:n.players)??[];for(const o of t){const c=o.character;if(!c)continue;if(this.enemies.has(c.id)){s++;continue}const r=S.getLevel(c)||1,d={id:c.id,name:c.name??"Actor",img:c.img??"",level:r,earns:!0,friend:!c.hasPlayerOwner};this.party.has(c.id)?s++:(this.party.set(c.id,d),e++)}(a=ui.notifications)==null||a.info(`Party +${e}${s?`, skipped ${s}`:""}`),this.render()}addSelectedToParty(){var n,a,o;const e=((n=canvas==null?void 0:canvas.tokens)==null?void 0:n.controlled)??[];if(!e.length)return(a=ui.notifications)==null?void 0:a.warn("Select one or more tokens first.");let s=0,t=0;for(const c of e){const r=c.actor;if(!r){t++;continue}if(this.enemies.has(r.id)){t++;continue}const d=S.getLevel(r)||1,i={id:r.id,name:r.name??"Actor",img:r.img??"",level:d,earns:!0,friend:!r.hasPlayerOwner};this.party.has(r.id)?t++:(this.party.set(r.id,i),s++)}(o=ui.notifications)==null||o.info(`Party +${s}${t?`, skipped ${t}`:""}`),this.render()}addSelectedToEnemies(){var n,a,o,c,r;const e=((n=canvas==null?void 0:canvas.tokens)==null?void 0:n.controlled)??[];if(!e.length){(a=ui.notifications)==null||a.warn("Select one or more tokens first.");return}let s=0,t=0;for(const d of e){const i=d.actor;if(!i){t++;continue}if(this.party.has(i.id)||this.enemies.has(i.id)){t++;continue}const g=this.getActorCR(i);if(!Number.isFinite(g)||g<=0){t++;continue}const p=i.img??((c=(o=i.prototypeToken)==null?void 0:o.texture)==null?void 0:c.src)??"icons/svg/skull.svg",f=i.name??"Enemy",y={id:i.id,name:f,img:p,cr:Number(g)};this.enemies.set(i.id,y),s++}(r=ui.notifications)==null||r.info(`Enemies +${s}${t?`, skipped ${t}`:""}`),this.render(!0)}addTargetedToEnemies(){var n,a,o;const e=((n=game.user)==null?void 0:n.targets)??new Set;if(!e.size)return(a=ui.notifications)==null?void 0:a.warn("Target one or more creatures first.");let s=0,t=0;for(const c of e){const r=c.actor;if(!r){t++;continue}if(this.party.has(r.id)){t++;continue}const d=S.getCR(r);if(!d){t++;continue}const i={id:r.id,name:r.name??"Enemy",img:r.img??"",cr:Number(d)};this.enemies.has(r.id)?t++:(this.enemies.set(r.id,i),s++)}(o=ui.notifications)==null||o.info(`Enemies +${s}${t?`, skipped ${t}`:""}`),this.render()}async applyXP(){var g;const e=[],s=[...this.party.values()],t=s.filter(p=>p.earns),n=new Map;for(const p of this.enemies.values()){const f=Math.max(1,Math.floor(Number(p.cr)||0));n.set(f,(n.get(f)??0)+1)}const a=[];for(const[p,f]of n.entries())a.push(O(p,f));let o=a.length?C(a):0;o+=this.elDelta;const c=game.settings.get("motwm-xp","awardMode");if(o>0&&t.length){if(c==="raw35")for(const p of t)e.push({id:p.id,name:p.name,xp:_(p.level,o)});else if(c==="split30"){const p=Math.round(s.reduce((m,b)=>m+b.level,0)/Math.max(1,s.length)),f=X(p,o),y=I(f,1,t.length);for(const m of t)e.push({id:m.id,name:m.name,xp:y})}}const r=this._manualAwardsToGrants();if(!e.length&&!r.length){(g=ui.notifications)==null||g.info("No XP to award: add enemies and/or manual awards first.");return}const d=async p=>{var f;for(const y of p){const m=(f=game.actors)==null?void 0:f.get(y.id);if(!m)continue;const b=Number(getProperty(m,"system.details.xp.value")??0);await m.update({"system.details.xp.value":b+y.xp})}};e.length&&await d(e),r.length&&await d(r);const i=[];if(game.settings.get("motwm-xp","broadcastChat")){const p=y=>{var m;try{return TextEditor.escapeHTML(String(y??""))}catch{return(m=foundry.utils)!=null&&m.escapeHTML?foundry.utils.escapeHTML(String(y??"")):String(y??"").replace(/[&<>"']/g,b=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[b])}},f=y=>`<ul>${y.map(m=>{const b=p(m.name),E=m.reason?` <em>(${p(m.reason)})</em>`:"";return`<li><b>${b}</b>: +${m.xp.toLocaleString()} XP${E}</li>`}).join("")}</ul>`;if(e.length){const y=`<div><h3>Encounter XP Awards</h3>${f(e)}</div>`,m=await ChatMessage.create({content:y});m!=null&&m.id&&i.push(m.id)}if(r.length){const y=r.map(E=>{var A;return{...E,reason:((A=this.manualAwards.get(E.id))==null?void 0:A.reason)||"Manual award"}}),m=`<div><h3>Manual XP Awards</h3>${f(y)}</div>`,b=await ChatMessage.create({content:m});b!=null&&b.id&&i.push(b.id)}}this.lastAward={enemies:new Map(this.enemies),manualAwards:new Map(this.manualAwards),elDelta:this.elDelta,grants:[...e,...r],chatMessageIds:i},this.enemies.clear(),this.manualAwards.clear(),this.elDelta=0,this.render(!0)}async rollbackXP(){var s,t,n;if(!this.lastAward){(s=ui.notifications)==null||s.warn("No XP award to rollback.");return}for(const a of this.lastAward.chatMessageIds){const o=(t=game.messages)==null?void 0:t.get(a);await(o==null?void 0:o.delete())}await(async a=>{var o;for(const c of a){const r=(o=game.actors)==null?void 0:o.get(c.id);if(!r)continue;const d=Number(getProperty(r,"system.details.xp.value")??0);await r.update({"system.details.xp.value":d-c.xp})}})(this.lastAward.grants),this.enemies=new Map(this.lastAward.enemies),this.manualAwards=new Map(this.lastAward.manualAwards),this.elDelta=this.lastAward.elDelta,this.lastAward=null,(n=ui.notifications)==null||n.info("XP award rolled back."),this.render(!0)}}class U extends Application{constructor(e,s={}){super({popOut:!1,id:"motwmxp-bar",...s});T(this,"actor");T(this,"_dragging",!1);T(this,"_dragOffset",{x:0,y:0});T(this,"_wired",!1);this.actor=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"motwmxp-bar",template:"modules/motwm-xp/templates/xp-bar.hbs"})}_getSavedPos(){const e=game.settings.get("motwm-xp","barPos");if(!e)return null;try{const s=JSON.parse(e);return s&&Number.isFinite(s.left)&&Number.isFinite(s.top)?s:null}catch{return null}}async _savePos(e,s){await game.settings.set("motwm-xp","barPos",JSON.stringify({left:e,top:s}))}_applyPos(){const e=this.element[0];if(!e)return;const s=this._getSavedPos();if(e.style.position="fixed",e.style.zIndex="70000",s)e.style.left=`${s.left}px`,e.style.top=`${s.top}px`;else{const t=e.getBoundingClientRect().width||520,n=e.getBoundingClientRect().height||18,a=Math.round((window.innerWidth-t)/2),o=Math.round(window.innerHeight-n-8);e.style.left=`${a}px`,e.style.top=`${o}px`}}getData(){const e=Number(getProperty(this.actor,"system.details.level.value")??1),s=Number(getProperty(this.actor,"system.details.xp.value")??0),t=getProperty(this.actor,"system.details.xp.max"),n=Number(t??$(e+1)),o=[$(e),n,$(e+2),$(e+3)];let c=Math.max(0,s-o[0]);const r=[];for(let f=0;f<3;f++){const y=Math.max(1,o[f+1]-o[f]),m=Math.max(0,Math.min(1,c/y));r.push({class:`layer${f}`,width:Math.round(m*1e4)/100}),c=Math.max(0,c-y)}const d=[],i=W();for(let f=1;f<=13;f++)d.push({left:f/i*100,class:""});d.push({left:13/i*100,class:"mini"});const g=`Lv ${e} | ${s.toLocaleString()} / ${n.toLocaleString()} XP`,p=`Level: ${e}`;return{layers:r,segments:d,label:g,tooltip:p}}async _render(e,s){if(await super._render(e,s),this._applyPos(),this._wired)return;this._wired=!0;const t=this.element[0];t.addEventListener("pointerdown",n=>{var o,c;n.preventDefault();const a=t.getBoundingClientRect();t.style.left=`${a.left}px`,t.style.top=`${a.top}px`,this._dragging=!0,(c=(o=n.currentTarget).setPointerCapture)==null||c.call(o,n.pointerId),this._dragOffset.x=n.clientX-a.left,this._dragOffset.y=n.clientY-a.top}),window.addEventListener("pointermove",n=>{if(!this._dragging)return;const a=Math.max(0,Math.min(window.innerWidth-50,n.clientX-this._dragOffset.x)),o=Math.max(0,Math.min(window.innerHeight-24,n.clientY-this._dragOffset.y));t.style.left=`${a}px`,t.style.top=`${o}px`}),window.addEventListener("pointerup",async()=>{if(!this._dragging)return;this._dragging=!1;const n=parseInt(t.style.left||"0",10),a=parseInt(t.style.top||"0",10);await this._savePos(n,a)}),window.addEventListener("resize",()=>this._applyPos(),{passive:!0})}render(e,s){return game.settings.get("motwm-xp","showPlayerBar")?super.render(e,s):this}}Hooks.once("init",()=>{console.log("motwm-xp | init"),G(),window.MOTWM_XP=window.MOTWM_XP??{bars:new Map}});Hooks.once("ready",()=>{var e;console.log("motwm-xp | ready");const u=game.settings.get("motwm-xp","showPlayerBar"),l=(e=game.user)==null?void 0:e.character;if(u&&l){const s=window.MOTWM_XP.bars;let t=s.get(l.id);t||(t=new U(l,{top:window.innerHeight-54,left:0}),s.set(l.id,t)),t.render(!0)}Hooks.on("updateActor",(s,t)=>{var o;const n=(o=game.user)==null?void 0:o.character;if(!n||s.id!==n.id)return;const a=window.MOTWM_XP.bars.get(n.id);a==null||a.render(!0)}),Hooks.on("updateSetting",(s,t)=>{var n;if(s.key==="motwm-xp.awardMode"&&((n=window.MOTWM_XP)!=null&&n.calc)){const a=window.MOTWM_XP.calc;a.element&&a.render(!1)}})});Hooks.on("getSceneControlButtons",u=>{var e,s;if(!((e=game.user)!=null&&e.isGM))return;const l=u.find(t=>t.name==="token");(s=l==null?void 0:l.tools)==null||s.push({name:"motwm-xp-calc",title:"Open XP Calculator",icon:"fas fa-calculator",visible:!0,onClick:()=>{var t;(t=window.MOTWM_XP)!=null&&t.calc||(window.MOTWM_XP.calc=new j),window.MOTWM_XP.calc.render(!0)},button:!0})});
//# sourceMappingURL=main.js.map
