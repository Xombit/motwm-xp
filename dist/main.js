var F=Object.defineProperty;var B=(u,l,e)=>l in u?F(u,l,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[l]=e;var T=(u,l,e)=>B(u,typeof l!="symbol"?l+"":l,e);function H(){game.settings.register("motwm-xp","broadcastChat",{name:"Broadcast XP to Chat",scope:"world",config:!0,type:Boolean,default:!1}),game.settings.register("motwm-xp","showPlayerBar",{name:"Show Player XP Bar",scope:"client",config:!0,type:Boolean,default:!0}),game.settings.register("motwm-xp","barPos",{name:"XP Bar Position",scope:"client",config:!1,type:Object,default:null}),game.settings.register("motwm-xp","awardMode",{name:"XP Award Method",hint:"RAW 3.5e = per-PC (Level vs EL). Classic 3.0 = split single pot based on APL.",scope:"world",config:!0,type:String,choices:{raw35:"D&D 3.5e (per-PC)",split30:"D&D 3.0 (split pot)"},default:"raw35"})}class N{static getXP(l){const e=getProperty(l,"system.details.xp.value");return Number(e??0)}static async setXP(l,e){return l.update({"system.details.xp.value":Number(e)})}static getLevel(l){const e=getProperty(l,"system.classes");if(e&&typeof e=="object"){let t=0;for(const n of Object.values(e)){const a=Number(getProperty(n,"level")??0);t+=a}if(t>0)return t}const s=getProperty(l,"system.details.level.value");return Number(s??0)}static getCR(l){const e=getProperty(l,"system.details.cr.value");if(e!=null)return Number(e);const s=this.getLevel(l);return s?Number(s):null}}function O(u,l){if(l<=0)return-1/0;let e=u,s=l;for(;s>=2;)e+=2,s=Math.floor(s/2);return e}function S(u){if(!u.length)return-1/0;let l=u.slice().sort((e,s)=>e-s);for(;l.length>1;){const e=l.pop(),s=l.pop(),t=Math.abs(e-s);let n=e;t===0?n=e+2:t===1||t===2?n=e+1:n=e,l.push(n),l.sort((a,i)=>a-i)}return l[0]}function $(u){var t,n;const l=Math.max(1,Math.floor(u)),e=game.settings.get("D35E","experienceRate"),s=(n=(t=CONFIG==null?void 0:CONFIG.D35E)==null?void 0:t.CHARACTER_EXP_LEVELS)==null?void 0:n[e];return Array.isArray(s)?Number(s[Math.min(l-1,s.length-1)]??0):Math.floor(1e3*((l-1)*l)/2)}function G(){return 13+1/3}function D(u,l){if(u<=0)return 0;const e=75*u,s=l-u,t=Math.floor(s/2),n=Math.pow(2,t);return Math.max(0,Math.round(e*n))}function C(u,l){const e={1:{1:300,2:600,3:900,4:1350,5:1800,6:2700,7:3600,8:5400,9:7200,10:10800},2:{1:300,2:600,3:900,4:1350,5:1800,6:2700,7:3600,8:5400,9:7200,10:10800},3:{1:300,2:600,3:900,4:1350,5:1800,6:2700,7:3600,8:5400,9:7200,10:10800},4:{1:300,2:600,3:800,4:1200,5:1600,6:2400,7:3200,8:4800,9:6400,10:9600,11:12800,12:18e3,13:21600,14:28800},5:{1:300,2:500,3:750,4:1e3,5:1500,6:2250,7:3e3,8:4500,9:6e3,10:9e3,11:12e3,12:18e3,13:21600,14:28800,15:28800},6:{1:300,2:450,3:600,4:900,5:1200,6:1800,7:2400,8:3600,9:4800,10:7200,11:10800,12:14400,13:21600,14:25200,15:28800,16:28800},7:{1:263,2:394,3:525,4:700,5:1050,6:1400,7:2100,8:3150,9:4200,10:6300,11:8400,12:12600,13:16800,14:25200,15:28800},8:{1:200,2:300,3:450,4:600,5:875,6:1200,7:1600,8:2400,9:3600,10:4800,11:6300,12:8400,13:12600,14:16800,15:25200,16:28800},9:{1:0,2:225,3:338,4:506,5:675,6:1013,7:1350,8:2025,9:2700,10:4050,11:5400,12:8100,13:10800,14:16200,15:21600,16:32400,17:36e3,18:39600},10:{3:250,4:375,5:563,6:750,7:1e3,8:1500,9:2e3,10:3e3,11:3600,12:4800,13:6400,14:9600},11:{4:275,5:413,6:619,7:825,8:1238,9:1650,10:2475,11:3300,12:4950,13:6600,14:9900,15:13200,16:17600,17:26400,18:39600},12:{5:300,6:450,7:675,8:900,9:1350,10:1800,11:1950,12:2600,13:3900,14:5850,15:7800,16:11700,17:15600,18:23400,19:31200,20:46800},13:{6:325,7:488,8:731,9:975,10:1463,11:1400,12:2100,13:2800,14:4200,15:6300,16:8400,17:12600,18:18900,19:25200,20:33600},14:{6:350,7:525,8:788,9:1050,10:1575,11:900,12:1200,13:1800,14:2400,15:4200,16:4800,17:7200,18:10800,19:13500,20:18900},15:{7:375,8:563,9:844,10:1125,11:638,12:850,13:1275,14:1900,15:2500,16:4800,17:7200,18:10800,19:13500,20:18900},16:{7:400,8:600,9:900,10:1350,11:900,12:1200,13:1800,14:2400,15:3200,16:4800,17:7200,18:10800,19:14400,20:19200},17:{8:425,9:638,10:956,11:900,12:1200,13:1800,14:2400,15:3200,16:4800,17:7200,18:10800,19:14400,20:19200},18:{8:450,9:675,10:1013,11:638,12:850,13:1275,14:1900,15:2500,16:4800,17:7200,18:10800,19:14400,20:19200},19:{9:475,10:713,11:638,12:850,13:1275,14:1900,15:2500,16:4800,17:7200,18:10800,19:14400,20:19200},20:{10:750,11:900,12:1200,13:1800,14:2400,15:3200,16:4800,17:7200,18:10800,19:14400,20:19200},21:{11:1125,12:1350,13:1800,14:2700,15:3600,16:4800,17:7200,18:10800,19:14400,20:21600,21:28800,22:43200,23:57600,24:76800},22:{12:1688,13:2025,14:2700,15:4050,16:5400,17:7200,18:10800,19:16200,20:21600,21:32400,22:43200,23:64800,24:86400,25:115200},23:{13:2250,14:2700,15:3600,16:5400,17:7200,18:9600,19:14400,20:21600,21:28800,22:43200,23:57600,24:86400,25:115200,26:153600},24:{14:3e3,15:3600,16:4800,17:7200,18:9600,19:12800,20:19200,21:28800,22:38400,23:57600,24:76800,25:115200,26:153600,27:204800},25:{15:4500,16:5400,17:7200,18:10800,19:14400,20:19200,21:28800,22:43200,23:57600,24:86400,25:115200,26:172800,27:230400,28:307200},26:{16:6750,17:8100,18:10800,19:16200,20:21600,21:28800,22:43200,23:64800,24:86400,25:129600,26:172800,27:259200,28:345600,29:460800},27:{17:9e3,18:10800,19:14400,20:21600,21:28800,22:38400,23:57600,24:86400,25:115200,26:172800,27:230400,28:345600,29:460800,30:614400},28:{18:12e3,19:14400,20:19200,21:28800,22:38400,23:51200,24:76800,25:115200,26:153600,27:230400,28:307200,29:460800,30:614400,31:819200},29:{19:18e3,20:21600,21:28800,22:43200,23:57600,24:76800,25:115200,26:172800,27:230400,28:345600,29:460800,30:691200,31:921600,32:1228800},30:{20:27e3,21:32400,22:43200,23:64800,24:86400,25:115200,26:172800,27:259200,28:345600,29:518400,30:691200,31:1036800,32:1382400,33:1843200},31:{21:36e3,22:43200,23:57600,24:86400,25:115200,26:153600,27:230400,28:345600,29:460800,30:691200,31:921600,32:1382400,33:1843200,34:2457600},32:{22:48e3,23:57600,24:76800,25:115200,26:153600,27:204800,28:307200,29:460800,30:614400,31:921600,32:1228800,33:1843200,34:2457600,35:3276800},33:{23:72e3,24:86400,25:115200,26:172800,27:230400,28:307200,29:460800,30:691200,31:921600,32:1382400,33:1843200,34:2764800,35:3686400,36:4915200},34:{24:108e3,25:129600,26:172800,27:259200,28:345600,29:460800,30:691200,31:1036800,32:1382400,33:2073600,34:2764800,35:4147200,36:5529600,37:7372800},35:{25:144e3,26:172800,27:230400,28:345600,29:460800,30:614400,31:921600,32:1382400,33:1843200,34:2764800,35:3686400,36:5529600,37:7372800,38:9830400},36:{26:192e3,27:230400,28:307200,29:460800,30:614400,31:819200,32:1228800,33:1843200,34:2457600,35:3686400,36:4915200,37:7372800,38:9830400,39:13107200},37:{27:288e3,28:345600,29:460800,30:691200,31:921600,32:1228800,33:1843200,34:2764800,35:3686400,36:5529600,37:7372800,38:11059200,39:14745600,40:19660800},38:{28:432e3,29:518400,30:691200,31:1036800,32:1382400,33:1843200,34:2764800,35:4147200,36:5529600,37:8294400,38:11059200,39:16588800,40:22118400},39:{29:576e3,30:691200,31:921600,32:1382400,33:1843200,34:2457600,35:3686400,36:5529600,37:7372800,38:11059200,39:14745600,40:22118400},40:{30:768e3,31:921600,32:1228800,33:1843200,34:2457600,35:3276800,36:4915200,37:7372800,38:9830400,39:14745600,40:19660800}},s=Math.max(1,Math.min(40,Math.floor(u))),t=Math.max(1,Math.floor(l)),n=e[s];if(!n)return 0;const a=n[t];if(a!==void 0)return a;const i=W(s),c=t-s;let o=i;if(c>0)for(let d=0;d<c;d++)o=Math.floor(o*(d%2===0?3/2:4/3));else if(c<0)for(let d=0;d<Math.abs(c);d++)o=Math.floor(o*(d%2===0?2/3:3/4));return Math.max(0,o)}function W(u){if(u<=11)return 300*u;const l={12:2600,13:2800,14:2400,15:2500};if(l[u])return l[u];let e=4800;const s=[1.5,1.5,4/3,4/3];for(let t=17;t<=u;t++){const n=s[(t-17)%4];e=Math.floor(e*n)}return e}function _(u,l,e){return u<=0||e<=0?0:Math.round(u*l/e)}function X(u){var t,n;const l=(t=window.CONFIG)!=null&&t.D35E?CONFIG.D35E.CHARACTER_EXP_LEVELS[game.settings.get("D35E","experienceRate")][Math.max(0,u-1)]:0,e=(n=window.CONFIG)!=null&&n.D35E?CONFIG.D35E.CHARACTER_EXP_LEVELS[game.settings.get("D35E","experienceRate")][Math.max(0,u)]:l+1e3;return Math.max(1,Number(e)-Number(l))/(13+1/3)}class j extends Application{constructor(){super(...arguments);T(this,"party",new Map);T(this,"enemies",new Map);T(this,"manualAwards",new Map);T(this,"elDelta",0);T(this,"showElDetails",!1);T(this,"lastAward",null)}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"motwmxp-calc",title:"MOTWM XP Calculator",width:960,height:660,resizable:!0,template:"modules/motwm-xp/src/ui/templates/xp-calculator.hbs"})}getData(){const e=new Map;for(const h of this.enemies.values()){const x=Math.max(1,Math.floor(Number(h.cr)||0));e.set(x,(e.get(x)??0)+1)}const s=[];for(const[h,x]of e.entries())s.push(O(h,x));const t=s.length?S(s):0,n=Number.isFinite(this.elDelta)?Math.trunc(this.elDelta):0,a=t+n,i=[...this.party.values()].map(h=>h.level),c=i.length,o=i.length>0?Math.round(i.reduce((h,x)=>h+x,0)/i.length*10)/10:0;let d=0;c>=6?d=Math.floor((c-4)/2):c<=3&&(d=-1);const r=o+d,g=a-r;let p="—";o>0&&a>0&&(g<0?p="Easy":g===0?p="Even":g===1?p="Challenging":g===2?p="Very Challenging":p="High Risk");const m=o>0&&a>0?`APL: ${r.toFixed(1)} (${o} base, ${d>=0?"+":""}${d} size) | EL: ${a} | Difficulty: ${p} (${g>=0?"+":""}${g})`:"—";let w="";if(s.length>0){const h=[],x=[...e.entries()].map(([P,v])=>{const M=O(P,v);return{cr:P,count:v,groupEL:M,text:`${v}×CR${P} → EL${M}`}}).sort((P,v)=>v.groupEL-P.groupEL);if(h.push(...x.map(P=>`└─ ${P.text}`)),x.length>1){const P=x.map(b=>b.groupEL).sort((b,A)=>A-b);let v=[],M=[...P];for(;M.length>1;){const b=M.shift(),A=M.shift(),k=Math.abs(b-A);let L=b;k===0?(L=b+2,v.push(`EL${b} + EL${A} (same) → EL${L}`)):k===1||k===2?(L=b+1,v.push(`EL${b} + EL${A} (±${k}) → EL${L}`)):v.push(`EL${b} + EL${A} (±${k}, negligible) → EL${b}`),M.push(L),M.sort((I,R)=>R-I)}h.push(...v.map(b=>`    └─ ${b}`))}this.elDelta!==0&&h.push(`    └─ EL modifier ${this.elDelta>=0?"+":""}${this.elDelta} → EL${a}`),w=h.join(`
`)}const f=game.settings.get("motwm-xp","awardMode"),y=[...this.party.values()].map(h=>{var P,v;const x=((v=(P=this.manualAwards)==null?void 0:P.get)==null?void 0:v.call(P,h.id))??{amount:0,unit:"points",reason:""};return{...h,bubble:Math.round(X(h.level)),manual:x}});let E=[];if(a>0&&y.some(h=>h.earns)){if(f==="raw35")E=y.filter(h=>h.earns).map(h=>({id:h.id,name:h.name,level:h.level,el:a,xp:D(h.level,a)}));else if(f==="split30"){const h=Math.round(y.reduce((M,b)=>M+b.level,0)/Math.max(1,y.length)),x=C(h,a),P=y.filter(M=>M.earns),v=_(x,1,P.length);E=P.map(M=>({id:M.id,name:M.name,level:M.level,el:a,xp:v}))}}return{party:y,enemies:[...this.enemies.values()],el:a,encounterInfo:m,elBreakdown:w,showElDetails:this.showElDetails,elDelta:this.elDelta,preview:E,hasRollback:!!this.lastAward}}activateListeners(e){super.activateListeners(e),e.on("click","[data-action='remove-party']",s=>{const t=s.currentTarget.dataset.id;this.party.delete(t),this.render()}),e.on("click","[data-action='remove-enemy']",s=>{const t=s.currentTarget.dataset.id;this.enemies.delete(t),this.render()}),e.on("change","input[data-action='toggle-earns']",s=>{const t=s.currentTarget.dataset.id,n=this.party.get(t);n&&(n.earns=s.currentTarget.checked,this.render(!1))}),e.on("change blur","[data-action='el-delta']",s=>{const t=s.currentTarget.value.trim();if(t===""||t==="-")return;const n=parseInt(t,10);this.elDelta=Number.isFinite(n)?n:0,this.render(!0)}),e.on("input","[data-action='award-amount']",s=>{const t=s.currentTarget.closest("[data-id]"),n=t==null?void 0:t.dataset.id,a=this.manualAwards.get(n)??{amount:0,unit:"points",reason:""};this.manualAwards.set(n,{...a,amount:Number(s.currentTarget.value)||0})}),e.on("change","[data-action='award-unit']",s=>{const t=s.currentTarget.closest("[data-id]"),n=t==null?void 0:t.dataset.id,a=this.manualAwards.get(n)??{amount:0,unit:"points",reason:""};this.manualAwards.set(n,{...a,unit:s.currentTarget.value})}),e.on("input","[data-action='award-reason']",s=>{const t=s.currentTarget.closest("[data-id]"),n=t==null?void 0:t.dataset.id,a=this.manualAwards.get(n)??{amount:0,unit:"points",reason:""};this.manualAwards.set(n,{...a,reason:s.currentTarget.value??""})}),e.on("click","[data-action='add-online-assigned']",()=>this.addAssignedPlayersToPartyOnlineOnly()),e.on("click","[data-action='add-all-assigned']",()=>this.addAssignedPlayersToPartyAll()),e.on("click","[data-action='add-friendly-scene']",()=>this.addFriendlySceneTokensToParty()),e.on("click","[data-action='add-selected-party']",()=>this.addSelectedToParty()),e.on("click","[data-action='add-selected-enemies']",()=>this.addSelectedToEnemies()),e.on("click","[data-action='add-hostile-scene']",()=>this.addHostileSceneTokensToEnemies()),e.on("click","[data-action='add-neutral-scene']",()=>this.addNeutralSceneTokensToEnemies()),e.on("click","[data-action='clear-party']",()=>{this.party.clear(),this.render(!0)}),e.on("click","[data-action='clear-enemies']",()=>{this.enemies.clear(),this.render(!0)}),e.on("click","[data-action='apply-xp']",()=>this.applyXP()),e.on("click","[data-action='rollback-xp']",()=>this.rollbackXP()),e.on("click","[data-action='toggle-el-details']",()=>{this.showElDetails=!this.showElDetails,this.render(!1)}),e.on("dblclick",".party .row",s=>{var a;const t=s.target;if(t.tagName==="INPUT"||t.tagName==="SELECT"||t.tagName==="BUTTON"||t.closest("button"))return;const n=s.currentTarget.dataset.id;if(n){const i=(a=game.actors)==null?void 0:a.get(n);i!=null&&i.sheet&&i.sheet.render(!0)}}),e.on("dblclick",".enemies .row",s=>{var a;const t=s.target;if(t.tagName==="BUTTON"||t.closest("button"))return;const n=s.currentTarget.dataset.id;if(n){const i=(a=game.actors)==null?void 0:a.get(n);i!=null&&i.sheet&&i.sheet.render(!0)}})}getActorCR(e){const s=["system.details.cr.value","system.details.cr","data.details.cr.value","data.details.cr"];for(const a of s){const i=Number(getProperty(e,a));if(Number.isFinite(i)&&i>0)return Math.round(i)}const t=e.type,n=Number(getProperty(e,"system.details.level.value"))||0;return t==="character"?Math.max(1,Math.floor(n)):Math.max(1,Math.floor(n)||1)}addHostileSceneTokensToEnemies(){var a,i,c,o,d;const e=((a=CONST==null?void 0:CONST.TOKEN_DISPOSITIONS)==null?void 0:a.HOSTILE)??-1,t=(((i=canvas.tokens)==null?void 0:i.placeables)??[]).filter(r=>{var g;return((g=r.document)==null?void 0:g.disposition)===e}).map(r=>r.actor).filter(r=>!!r);let n=0;for(const r of t){if(!(r!=null&&r.id)||this.enemies.has(r.id))continue;const g=r.name??"Unknown",p=r.img??((o=(c=r.prototypeToken)==null?void 0:c.texture)==null?void 0:o.src)??"icons/svg/skull.svg",m=this.getActorCR(r);this.enemies.set(r.id,{id:r.id,name:g,img:p,cr:m}),n++}(d=ui.notifications)==null||d.info(`Added ${n} hostile actor(s) from this scene.`),this.render(!0)}addNeutralSceneTokensToEnemies(){var a,i,c,o,d;const e=((a=CONST==null?void 0:CONST.TOKEN_DISPOSITIONS)==null?void 0:a.NEUTRAL)??0,t=(((i=canvas.tokens)==null?void 0:i.placeables)??[]).filter(r=>{var g;return((g=r.document)==null?void 0:g.disposition)===e}).map(r=>r.actor).filter(r=>!!r);let n=0;for(const r of t){if(!(r!=null&&r.id)||this.enemies.has(r.id))continue;const g=r.name??"Unknown",p=r.img??((o=(c=r.prototypeToken)==null?void 0:c.texture)==null?void 0:o.src)??"icons/svg/eye.svg",m=this.getActorCR(r);this.enemies.set(r.id,{id:r.id,name:g,img:p,cr:m}),n++}(d=ui.notifications)==null||d.info(`Added ${n} neutral actor(s) from this scene.`),this.render(!0)}addActorsToParty(e){var t,n;let s=0;for(const a of e){if(!(a!=null&&a.id)||this.party.has(a.id))continue;const i=a.name??"Unknown",c=a.img??((n=(t=a.prototypeToken)==null?void 0:t.texture)==null?void 0:n.src)??"icons/svg/mystery-man.svg",o=Number(getProperty(a,"system.details.level.value"))||1;this.party.set(a.id,{id:a.id,name:i,img:c,level:o,earns:!0,friend:!1}),s++}return s}addAssignedPlayersToPartyOnlineOnly(){var a,i;const t=(((a=game.users)==null?void 0:a.players)??[]).filter(c=>c.active).map(c=>c.character).filter(c=>!!c),n=this.addActorsToParty(t);(i=ui.notifications)==null||i.info(`Added ${n} online assigned PC(s).`),this.render(!0)}addAssignedPlayersToPartyAll(){var n,a;const s=(((n=game.users)==null?void 0:n.players)??[]).map(i=>i.character).filter(i=>!!i),t=this.addActorsToParty(s);(a=ui.notifications)==null||a.info(`Added ${t} assigned PC(s) (all logins).`),this.render(!0)}addFriendlySceneTokensToParty(){var a,i,c;const e=((a=CONST==null?void 0:CONST.TOKEN_DISPOSITIONS)==null?void 0:a.FRIENDLY)??1,t=(((i=canvas.tokens)==null?void 0:i.placeables)??[]).filter(o=>{var d;return((d=o.document)==null?void 0:d.disposition)===e}).map(o=>o.actor).filter(o=>!!o),n=this.addActorsToParty(t);(c=ui.notifications)==null||c.info(`Added ${n} Friendly token actor(s) from this scene.`),this.render(!0)}populateScenePlayers(){var a,i,c;const e=((a=CONST==null?void 0:CONST.TOKEN_DISPOSITIONS)==null?void 0:a.FRIENDLY)??1,s=((i=canvas.tokens)==null?void 0:i.placeables)??[],t=[];for(const o of s){const d=o.document,r=o.actor??void 0;if(!d||!r)continue;const g=d.disposition===e,p=r.type==="character";g&&p&&t.push(r)}const n=this.addActorsToParty(t);(c=ui.notifications)==null||c.info(`Added ${n} Friendly PC(s) from this scene.`),this.render(!0)}addFoundryParty(){var n,a,i,c;let e=[];const s=game.party;(n=s==null?void 0:s.members)!=null&&n.length&&(e=s.members.map(o=>o==null?void 0:o.actor).filter(o=>!!o)),e.length||(e=(a=game.users)==null?void 0:a.players.map(d=>d.character).filter(d=>!!d)),e.length||(e=(((i=canvas.tokens)==null?void 0:i.placeables)??[]).map(d=>d.actor).filter(d=>!!d&&d.type==="character"));const t=this.addActorsToParty(e);(c=ui.notifications)==null||c.info(`Added ${t} actor(s) from Foundry Party.`),this.render(!0)}_manualAwardsToGrants(){var s,t;const e=[];for(const[n,a]of this.manualAwards){if(!a||!a.amount)continue;const i=(s=game.actors)==null?void 0:s.get(n);if(!i)continue;const c=i.name??n,o=Number(getProperty(i,"system.details.level.value")??1),d=X(o),r=Math.round(a.unit==="bubbles"?a.amount*d:a.amount);r!==0&&e.push({id:n,name:c,xp:r,reason:((t=a.reason)==null?void 0:t.trim())||"Manual award"})}return e}populatePartyPlayers(){var n,a;let e=0,s=0;const t=((n=game.users)==null?void 0:n.players)??[];for(const i of t){const c=i.character;if(!c)continue;if(this.enemies.has(c.id)){s++;continue}const o=N.getLevel(c)||1,d={id:c.id,name:c.name??"Actor",img:c.img??"",level:o,earns:!0,friend:!c.hasPlayerOwner};this.party.has(c.id)?s++:(this.party.set(c.id,d),e++)}(a=ui.notifications)==null||a.info(`Party +${e}${s?`, skipped ${s}`:""}`),this.render()}addSelectedToParty(){var n,a,i;const e=((n=canvas==null?void 0:canvas.tokens)==null?void 0:n.controlled)??[];if(!e.length)return(a=ui.notifications)==null?void 0:a.warn("Select one or more tokens first.");let s=0,t=0;for(const c of e){const o=c.actor;if(!o){t++;continue}if(this.enemies.has(o.id)){t++;continue}const d=N.getLevel(o)||1,r={id:o.id,name:o.name??"Actor",img:o.img??"",level:d,earns:!0,friend:!o.hasPlayerOwner};this.party.has(o.id)?t++:(this.party.set(o.id,r),s++)}(i=ui.notifications)==null||i.info(`Party +${s}${t?`, skipped ${t}`:""}`),this.render()}addSelectedToEnemies(){var n,a,i,c,o;const e=((n=canvas==null?void 0:canvas.tokens)==null?void 0:n.controlled)??[];if(!e.length){(a=ui.notifications)==null||a.warn("Select one or more tokens first.");return}let s=0,t=0;for(const d of e){const r=d.actor;if(!r){t++;continue}if(this.party.has(r.id)||this.enemies.has(r.id)){t++;continue}const g=this.getActorCR(r);if(!Number.isFinite(g)||g<=0){t++;continue}const p=r.img??((c=(i=r.prototypeToken)==null?void 0:i.texture)==null?void 0:c.src)??"icons/svg/skull.svg",m=r.name??"Enemy",w={id:r.id,name:m,img:p,cr:Number(g)};this.enemies.set(r.id,w),s++}(o=ui.notifications)==null||o.info(`Enemies +${s}${t?`, skipped ${t}`:""}`),this.render(!0)}addTargetedToEnemies(){var n,a,i;const e=((n=game.user)==null?void 0:n.targets)??new Set;if(!e.size)return(a=ui.notifications)==null?void 0:a.warn("Target one or more creatures first.");let s=0,t=0;for(const c of e){const o=c.actor;if(!o){t++;continue}if(this.party.has(o.id)){t++;continue}const d=N.getCR(o);if(!d){t++;continue}const r={id:o.id,name:o.name??"Enemy",img:o.img??"",cr:Number(d)};this.enemies.has(o.id)?t++:(this.enemies.set(o.id,r),s++)}(i=ui.notifications)==null||i.info(`Enemies +${s}${t?`, skipped ${t}`:""}`),this.render()}async applyXP(){var g;const e=[],s=[...this.party.values()],t=s.filter(p=>p.earns),n=new Map;for(const p of this.enemies.values()){const m=Math.max(1,Math.floor(Number(p.cr)||0));n.set(m,(n.get(m)??0)+1)}const a=[];for(const[p,m]of n.entries())a.push(O(p,m));let i=a.length?S(a):0;i+=this.elDelta;const c=game.settings.get("motwm-xp","awardMode");if(i>0&&t.length){if(c==="raw35")for(const p of t)e.push({id:p.id,name:p.name,xp:D(p.level,i)});else if(c==="split30"){const p=Math.round(s.reduce((f,y)=>f+y.level,0)/Math.max(1,s.length)),m=C(p,i),w=_(m,1,t.length);for(const f of t)e.push({id:f.id,name:f.name,xp:w})}}const o=this._manualAwardsToGrants();if(!e.length&&!o.length){(g=ui.notifications)==null||g.info("No XP to award: add enemies and/or manual awards first.");return}const d=async p=>{var m;for(const w of p){const f=(m=game.actors)==null?void 0:m.get(w.id);if(!f)continue;const y=Number(getProperty(f,"system.details.xp.value")??0);await f.update({"system.details.xp.value":y+w.xp})}};e.length&&await d(e),o.length&&await d(o);const r=[];if(game.settings.get("motwm-xp","broadcastChat")){const p=w=>{var f;try{return TextEditor.escapeHTML(String(w??""))}catch{return(f=foundry.utils)!=null&&f.escapeHTML?foundry.utils.escapeHTML(String(w??"")):String(w??"").replace(/[&<>"']/g,y=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[y])}},m=w=>`<ul>${w.map(f=>{const y=p(f.name),E=f.reason?` <em>(${p(f.reason)})</em>`:"";return`<li><b>${y}</b>: +${f.xp.toLocaleString()} XP${E}</li>`}).join("")}</ul>`;if(e.length){const w=`<div><h3>Encounter XP Awards</h3>${m(e)}</div>`,f=await ChatMessage.create({content:w});f!=null&&f.id&&r.push(f.id)}if(o.length){const w=o.map(E=>{var h;return{...E,reason:((h=this.manualAwards.get(E.id))==null?void 0:h.reason)||"Manual award"}}),f=`<div><h3>Manual XP Awards</h3>${m(w)}</div>`,y=await ChatMessage.create({content:f});y!=null&&y.id&&r.push(y.id)}}this.lastAward={enemies:new Map(this.enemies),manualAwards:new Map(this.manualAwards),elDelta:this.elDelta,grants:[...e,...o],chatMessageIds:r},this.enemies.clear(),this.manualAwards.clear(),this.elDelta=0,this.render(!0)}async rollbackXP(){var s,t,n;if(!this.lastAward){(s=ui.notifications)==null||s.warn("No XP award to rollback.");return}for(const a of this.lastAward.chatMessageIds){const i=(t=game.messages)==null?void 0:t.get(a);await(i==null?void 0:i.delete())}await(async a=>{var i;for(const c of a){const o=(i=game.actors)==null?void 0:i.get(c.id);if(!o)continue;const d=Number(getProperty(o,"system.details.xp.value")??0);await o.update({"system.details.xp.value":d-c.xp})}})(this.lastAward.grants),this.enemies=new Map(this.lastAward.enemies),this.manualAwards=new Map(this.lastAward.manualAwards),this.elDelta=this.lastAward.elDelta,this.lastAward=null,(n=ui.notifications)==null||n.info("XP award rolled back."),this.render(!0)}}class z extends Application{constructor(e,s={}){super({popOut:!1,id:"motwmxp-bar",...s});T(this,"actor");T(this,"_dragging",!1);T(this,"_dragOffset",{x:0,y:0});T(this,"_wired",!1);this.actor=e}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"motwmxp-bar",template:"modules/motwm-xp/src/ui/templates/xp-bar.hbs"})}_getSavedPos(){const e=game.settings.get("motwm-xp","barPos");return e&&Number.isFinite(e.left)&&Number.isFinite(e.top)?e:null}async _savePos(e,s){await game.settings.set("motwm-xp","barPos",{left:e,top:s})}_applyPos(){const e=this.element[0];if(!e)return;const s=this._getSavedPos();if(e.style.position="fixed",e.style.zIndex="70000",s)e.style.left=`${s.left}px`,e.style.top=`${s.top}px`;else{const t=e.getBoundingClientRect().width||520,n=e.getBoundingClientRect().height||18,a=Math.round((window.innerWidth-t)/2),i=Math.round(window.innerHeight-n-8);e.style.left=`${a}px`,e.style.top=`${i}px`}}getData(){const e=Number(getProperty(this.actor,"system.details.level.value")??1),s=Number(getProperty(this.actor,"system.details.xp.value")??0),t=getProperty(this.actor,"system.details.xp.max"),n=Number(t??$(e+1)),i=[$(e),n,$(e+2),$(e+3)];let c=Math.max(0,s-i[0]);const o=[];for(let m=0;m<3;m++){const w=Math.max(1,i[m+1]-i[m]),f=Math.max(0,Math.min(1,c/w));o.push({class:`layer${m}`,width:Math.round(f*1e4)/100}),c=Math.max(0,c-w)}const d=[],r=G();for(let m=1;m<=13;m++)d.push({left:m/r*100,class:""});d.push({left:13/r*100,class:"mini"});const g=`Lv ${e} | ${s.toLocaleString()} / ${n.toLocaleString()} XP`,p=`Level: ${e}`;return{layers:o,segments:d,label:g,tooltip:p}}async _render(e,s){if(await super._render(e,s),this._applyPos(),this._wired)return;this._wired=!0;const t=this.element[0];t.addEventListener("pointerdown",n=>{var i,c;n.preventDefault();const a=t.getBoundingClientRect();t.style.left=`${a.left}px`,t.style.top=`${a.top}px`,this._dragging=!0,(c=(i=n.currentTarget).setPointerCapture)==null||c.call(i,n.pointerId),this._dragOffset.x=n.clientX-a.left,this._dragOffset.y=n.clientY-a.top}),window.addEventListener("pointermove",n=>{if(!this._dragging)return;const a=Math.max(0,Math.min(window.innerWidth-50,n.clientX-this._dragOffset.x)),i=Math.max(0,Math.min(window.innerHeight-24,n.clientY-this._dragOffset.y));t.style.left=`${a}px`,t.style.top=`${i}px`}),window.addEventListener("pointerup",async()=>{if(!this._dragging)return;this._dragging=!1;const n=parseInt(t.style.left||"0",10),a=parseInt(t.style.top||"0",10);await this._savePos(n,a)}),window.addEventListener("resize",()=>this._applyPos(),{passive:!0})}render(e,s){return game.settings.get("motwm-xp","showPlayerBar")?super.render(e,s):this}}Hooks.once("init",()=>{console.log("motwm-xp | init"),H(),window.MOTWM_XP=window.MOTWM_XP??{bars:new Map}});Hooks.once("ready",()=>{var e;console.log("motwm-xp | ready");const u=game.settings.get("motwm-xp","showPlayerBar"),l=(e=game.user)==null?void 0:e.character;if(u&&l){const s=window.MOTWM_XP.bars;let t=s.get(l.id);t||(t=new z(l,{top:window.innerHeight-54,left:0}),s.set(l.id,t)),t.render(!0)}Hooks.on("updateActor",(s,t)=>{var i;const n=(i=game.user)==null?void 0:i.character;if(!n||s.id!==n.id)return;const a=window.MOTWM_XP.bars.get(n.id);a==null||a.render(!0)}),Hooks.on("updateSetting",(s,t)=>{var n;if(s.key==="motwm-xp.awardMode"&&((n=window.MOTWM_XP)!=null&&n.calc)){const a=window.MOTWM_XP.calc;a.element&&a.render(!1)}})});Hooks.on("getSceneControlButtons",u=>{var e,s;if(!((e=game.user)!=null&&e.isGM))return;const l=u.find(t=>t.name==="token");(s=l==null?void 0:l.tools)==null||s.push({name:"motwm-xp-calc",title:"Open XP Calculator",icon:"fas fa-calculator",visible:!0,onClick:()=>{var t;(t=window.MOTWM_XP)!=null&&t.calc||(window.MOTWM_XP.calc=new j),window.MOTWM_XP.calc.render(!0)},button:!0})});
//# sourceMappingURL=main.js.map
