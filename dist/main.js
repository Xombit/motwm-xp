var W=Object.defineProperty;var U=(p,c,t)=>c in p?W(p,c,{enumerable:!0,configurable:!0,writable:!0,value:t}):p[c]=t;var E=(p,c,t)=>U(p,typeof c!="symbol"?c+"":c,t);function j(){game.settings.register("motwm-xp","broadcastChat",{name:"Broadcast XP to Chat",scope:"world",config:!0,type:Boolean,default:!1}),game.settings.register("motwm-xp","showPlayerBar",{name:"Show Player XP Bar",scope:"client",config:!0,type:Boolean,default:!0}),game.settings.register("motwm-xp","barPos",{name:"XP Bar Position",scope:"client",config:!1,type:String,default:""}),game.settings.register("motwm-xp","awardMode",{name:"XP Award Method",hint:"RAW 3.5e = per-PC (Level vs EL). Classic 3.0 = split single pot based on APL.",scope:"world",config:!0,type:String,choices:{raw35:"D&D 3.5e (per-PC)",split30:"D&D 3.0 (split pot)"},default:"raw35"})}class O{static getXP(c){const t=getProperty(c,"system.details.xp.value");return Number(t??0)}static async setXP(c,t){return c.update({"system.details.xp.value":Number(t)})}static getLevel(c){const t=getProperty(c,"system.classes");if(t&&typeof t=="object"){let s=0;for(const n of Object.values(t)){const a=Number(getProperty(n,"level")??0);s+=a}if(s>0)return s}const e=getProperty(c,"system.details.level.value");return Number(e??0)}static getCR(c){const t=["system.details.totalCr","system.details.cr.total","system.attributes.cr.total","system.details.cr.value","system.details.cr","data.details.totalCr","data.details.cr.total","data.details.cr.value","data.details.cr"];for(const s of t){const n=getProperty(c,s);if(n!=null&&Number.isFinite(Number(n)))return Number(n)}const e=this.getLevel(c);return e?Number(e):null}}function C(p,c){if(c<=0)return-1/0;let t=p,e=c;for(;e>=2;)t+=2,e=Math.floor(e/2);return t}function I(p){if(!p.length)return-1/0;let c=p.slice().sort((t,e)=>t-e);for(;c.length>1;){const t=c.pop(),e=c.pop(),s=Math.abs(t-e);let n=t;s===0?n=t+2:s===1||s===2?n=t+1:n=t,c.push(n),c.sort((a,r)=>a-r)}return c[0]}function $(p){var s,n;const c=Math.max(1,Math.floor(p)),t=game.settings.get("D35E","experienceRate"),e=(n=(s=CONFIG==null?void 0:CONFIG.D35E)==null?void 0:s.CHARACTER_EXP_LEVELS)==null?void 0:n[t];return Array.isArray(e)?Number(e[Math.min(c-1,e.length-1)]??0):Math.floor(1e3*((c-1)*c)/2)}const z=13+1/3;function _(p,c){let t=p,e=c;if(t<=0||e<=0)return 0;let s=0;if(t<3&&(t=3),t<=6&&e<=1)s=300*e;else if(e<1)s=300*e;else{const n=a=>{let r=2*Math.floor(a/2);return a<r?r+=-2:a>r&&(r+=2),r};s=6.25*t*Math.pow(2,n(7-(t-e))/2)*(11-(t-e)-n(7-(t-e)))}return[4,6,8,10,12,14,16,18,20].includes(e)&&(t<=3?s=1350*Math.pow(2,(e-4)/2):t===5&&e>=6?s=2250*Math.pow(2,(e-6)/2):t===7&&e>=8?s=3150*Math.pow(2,(e-8)/2):t===9&&e>=10?s=4050*Math.pow(2,(e-10)/2):t===11&&e>=12?s=4950*Math.pow(2,(e-12)/2):t===13&&e>=14?s=5850*Math.pow(2,(e-14)/2):t===15&&e>=16?s=6750*Math.pow(2,(e-16)/2):t===17&&e>=18?s=7650*Math.pow(2,(e-18)/2):t===19&&e>=20&&(s=8550*Math.pow(2,(e-20)/2))),[7,9,11,13,15,17,19].includes(e)&&(t===6&&(s=2700*Math.pow(2,(e-7)/2)),t===8&&e>=9&&(s=3600*Math.pow(2,(e-9)/2)),t===10&&e>=11&&(s=4500*Math.pow(2,(e-11)/2)),t===12&&e>=13&&(s=5400*Math.pow(2,(e-13)/2)),t===14&&e>=15&&(s=6300*Math.pow(2,(e-15)/2)),t===16&&e>=17&&(s=7200*Math.pow(2,(e-17)/2)),t===18&&e>=19&&(s=8100*Math.pow(2,(e-19)/2))),e>20&&(s=2*_(t,e-2)),(t-e>7||e-t>7)&&(s=0),Math.round(s)}function X(p,c){const t={1:{1:300,2:600,3:900,4:1350,5:1800,6:2700,7:3600,8:5400,9:7200,10:10800},2:{1:300,2:600,3:900,4:1350,5:1800,6:2700,7:3600,8:5400,9:7200,10:10800},3:{1:300,2:600,3:900,4:1350,5:1800,6:2700,7:3600,8:5400,9:7200,10:10800},4:{1:300,2:600,3:800,4:1200,5:1600,6:2400,7:3200,8:4800,9:6400,10:9600,11:12800,12:18e3,13:21600,14:28800},5:{1:300,2:500,3:750,4:1e3,5:1500,6:2250,7:3e3,8:4500,9:6e3,10:9e3,11:12e3,12:18e3,13:21600,14:28800,15:28800},6:{1:300,2:450,3:600,4:900,5:1200,6:1800,7:2400,8:3600,9:4800,10:7200,11:10800,12:14400,13:21600,14:25200,15:28800,16:28800},7:{1:263,2:394,3:525,4:700,5:1050,6:1400,7:2100,8:3150,9:4200,10:6300,11:8400,12:12600,13:16800,14:25200,15:28800},8:{1:200,2:300,3:450,4:600,5:875,6:1200,7:1600,8:2400,9:3600,10:4800,11:6300,12:8400,13:12600,14:16800,15:25200,16:28800},9:{1:0,2:225,3:338,4:506,5:675,6:1013,7:1350,8:2025,9:2700,10:4050,11:5400,12:8100,13:10800,14:16200,15:21600,16:32400,17:36e3,18:39600},10:{3:250,4:375,5:563,6:750,7:1e3,8:1500,9:2e3,10:3e3,11:3600,12:4800,13:6400,14:9600},11:{4:275,5:413,6:619,7:825,8:1238,9:1650,10:2475,11:3300,12:4950,13:6600,14:9900,15:13200,16:17600,17:26400,18:39600},12:{5:300,6:450,7:675,8:900,9:1350,10:1800,11:1950,12:2600,13:3900,14:5850,15:7800,16:11700,17:15600,18:23400,19:31200,20:46800},13:{6:325,7:488,8:731,9:975,10:1463,11:1400,12:2100,13:2800,14:4200,15:6300,16:8400,17:12600,18:18900,19:25200,20:33600},14:{6:350,7:525,8:788,9:1050,10:1575,11:900,12:1200,13:1800,14:2400,15:4200,16:4800,17:7200,18:10800,19:13500,20:18900},15:{7:375,8:563,9:844,10:1125,11:638,12:850,13:1275,14:1900,15:2500,16:4800,17:7200,18:10800,19:13500,20:18900},16:{7:400,8:600,9:900,10:1350,11:900,12:1200,13:1800,14:2400,15:3200,16:4800,17:7200,18:10800,19:14400,20:19200},17:{8:425,9:638,10:956,11:900,12:1200,13:1800,14:2400,15:3200,16:4800,17:7200,18:10800,19:14400,20:19200},18:{8:450,9:675,10:1013,11:638,12:850,13:1275,14:1900,15:2500,16:4800,17:7200,18:10800,19:14400,20:19200},19:{9:475,10:713,11:638,12:850,13:1275,14:1900,15:2500,16:4800,17:7200,18:10800,19:14400,20:19200},20:{10:750,11:900,12:1200,13:1800,14:2400,15:3200,16:4800,17:7200,18:10800,19:14400,20:19200},21:{11:1125,12:1350,13:1800,14:2700,15:3600,16:4800,17:7200,18:10800,19:14400,20:21600,21:28800,22:43200,23:57600,24:76800},22:{12:1688,13:2025,14:2700,15:4050,16:5400,17:7200,18:10800,19:16200,20:21600,21:32400,22:43200,23:64800,24:86400,25:115200},23:{13:2250,14:2700,15:3600,16:5400,17:7200,18:9600,19:14400,20:21600,21:28800,22:43200,23:57600,24:86400,25:115200,26:153600},24:{14:3e3,15:3600,16:4800,17:7200,18:9600,19:12800,20:19200,21:28800,22:38400,23:57600,24:76800,25:115200,26:153600,27:204800},25:{15:4500,16:5400,17:7200,18:10800,19:14400,20:19200,21:28800,22:43200,23:57600,24:86400,25:115200,26:172800,27:230400,28:307200},26:{16:6750,17:8100,18:10800,19:16200,20:21600,21:28800,22:43200,23:64800,24:86400,25:129600,26:172800,27:259200,28:345600,29:460800},27:{17:9e3,18:10800,19:14400,20:21600,21:28800,22:38400,23:57600,24:86400,25:115200,26:172800,27:230400,28:345600,29:460800,30:614400},28:{18:12e3,19:14400,20:19200,21:28800,22:38400,23:51200,24:76800,25:115200,26:153600,27:230400,28:307200,29:460800,30:614400,31:819200},29:{19:18e3,20:21600,21:28800,22:43200,23:57600,24:76800,25:115200,26:172800,27:230400,28:345600,29:460800,30:691200,31:921600,32:1228800},30:{20:27e3,21:32400,22:43200,23:64800,24:86400,25:115200,26:172800,27:259200,28:345600,29:518400,30:691200,31:1036800,32:1382400,33:1843200},31:{21:36e3,22:43200,23:57600,24:86400,25:115200,26:153600,27:230400,28:345600,29:460800,30:691200,31:921600,32:1382400,33:1843200,34:2457600},32:{22:48e3,23:57600,24:76800,25:115200,26:153600,27:204800,28:307200,29:460800,30:614400,31:921600,32:1228800,33:1843200,34:2457600,35:3276800},33:{23:72e3,24:86400,25:115200,26:172800,27:230400,28:307200,29:460800,30:691200,31:921600,32:1382400,33:1843200,34:2764800,35:3686400,36:4915200},34:{24:108e3,25:129600,26:172800,27:259200,28:345600,29:460800,30:691200,31:1036800,32:1382400,33:2073600,34:2764800,35:4147200,36:5529600,37:7372800},35:{25:144e3,26:172800,27:230400,28:345600,29:460800,30:614400,31:921600,32:1382400,33:1843200,34:2764800,35:3686400,36:5529600,37:7372800,38:9830400},36:{26:192e3,27:230400,28:307200,29:460800,30:614400,31:819200,32:1228800,33:1843200,34:2457600,35:3686400,36:4915200,37:7372800,38:9830400,39:13107200},37:{27:288e3,28:345600,29:460800,30:691200,31:921600,32:1228800,33:1843200,34:2764800,35:3686400,36:5529600,37:7372800,38:11059200,39:14745600,40:19660800},38:{28:432e3,29:518400,30:691200,31:1036800,32:1382400,33:1843200,34:2764800,35:4147200,36:5529600,37:8294400,38:11059200,39:16588800,40:22118400},39:{29:576e3,30:691200,31:921600,32:1382400,33:1843200,34:2457600,35:3686400,36:5529600,37:7372800,38:11059200,39:14745600,40:22118400},40:{30:768e3,31:921600,32:1228800,33:1843200,34:2457600,35:3276800,36:4915200,37:7372800,38:9830400,39:14745600,40:19660800}},e=Math.max(1,Math.min(40,Math.floor(p))),s=Math.max(1,Math.floor(c)),n=t[e];if(!n)return 0;const a=n[s];if(a!==void 0)return a;const r=Y(e),i=s-e;let o=r;if(i>0)for(let l=0;l<i;l++)o=Math.floor(o*(l%2===0?3/2:4/3));else if(i<0)for(let l=0;l<Math.abs(i);l++)o=Math.floor(o*(l%2===0?2/3:3/4));return Math.max(0,o)}function Y(p){if(p<=11)return 300*p;const c={12:2600,13:2800,14:2400,15:2500};if(c[p])return c[p];let t=4800;const e=[1.5,1.5,4/3,4/3];for(let s=17;s<=p;s++){const n=e[(s-17)%4];t=Math.floor(t*n)}return t}function R(p,c,t){return p<=0||t<=0?0:Math.round(p*c/t)}function F(p){const c={.125:"⅛",.25:"¼",.33:"⅓",.333:"⅓",.5:"½",.66:"⅔",.667:"⅔",.75:"¾"};for(const[t,e]of Object.entries(c))if(Math.abs(p-parseFloat(t))<.01)return e;return Number.isInteger(p)?p.toString():p.toFixed(2)}function D(p){var s,n;const c=(s=window.CONFIG)!=null&&s.D35E?CONFIG.D35E.CHARACTER_EXP_LEVELS[game.settings.get("D35E","experienceRate")][Math.max(0,p-1)]:0,t=(n=window.CONFIG)!=null&&n.D35E?CONFIG.D35E.CHARACTER_EXP_LEVELS[game.settings.get("D35E","experienceRate")][Math.max(0,p)]:c+1e3;return Math.max(1,Number(t)-Number(c))/(13+1/3)}class V extends Application{constructor(){super(...arguments);E(this,"party",new Map);E(this,"enemies",new Map);E(this,"manualAwards",new Map);E(this,"elDelta",0);E(this,"showElDetails",!1);E(this,"lastAward",null)}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"motwmxp-calc",title:"MOTWM XP Calculator",width:960,height:660,resizable:!0,template:"modules/motwm-xp/templates/xp-calculator.hbs"})}getData(){const t=new Map;for(const f of this.enemies.values()){const M=Math.max(.125,Number(f.cr)||1);t.set(M,(t.get(M)??0)+1)}const e=[];for(const[f,M]of t.entries())e.push(C(f,M));const s=e.length?I(e):0,n=Number.isFinite(this.elDelta)?Math.trunc(this.elDelta):0,a=s+n,r=[...this.party.values()].map(f=>f.level),i=r.length,o=f=>f<2?f:Math.pow(2,f/2),l=f=>f<2?f:2*Math.log2(f),h=r.length>0?r.reduce((f,M)=>f+M,0)/r.length:0;let d=0;if(r.length>0){const M=r.reduce((y,b)=>y+o(b),0)/4;d=l(M)}const u=a-d;let m="—";d>0&&a>0&&(u<-9?m="Trivial":u<-4?m="Very Easy":u<0?m="Easy":u===0?m="Challenging":u<=4?m="Very Difficult":u<=7?m="Overpowering":m="Unbeatable");const w=d>0&&a>0?`Party: ${i} PCs, Avg Lvl ${h.toFixed(1)}, Party Level ${d.toFixed(1)} | EL: ${a} | Difficulty: ${m} (${u>=0?"+":""}${u.toFixed(1)})`:"—";let g="";if(e.length>0){const f=[],M=[...t.entries()].map(([y,b])=>{const v=C(y,b);return{cr:y,count:b,groupEL:v,text:`${b}×CR${F(y)} → EL${v}`}}).sort((y,b)=>b.groupEL-y.groupEL);if(f.push(...M.map(y=>`└─ ${y.text}`)),M.length>1){const y=M.map(P=>P.groupEL).sort((P,k)=>k-P);let b=[],v=[...y];for(;v.length>1;){const P=v.shift(),k=v.shift(),L=Math.abs(P-k);let N=P;L===0?(N=P+2,b.push(`EL${P} + EL${k} (same) → EL${N}`)):L===1||L===2?(N=P+1,b.push(`EL${P} + EL${k} (±${L}) → EL${N}`)):b.push(`EL${P} + EL${k} (±${L}, negligible) → EL${P}`),v.push(N),v.sort((H,G)=>G-H)}f.push(...b.map(P=>`    └─ ${P}`))}this.elDelta!==0&&f.push(`    └─ EL modifier ${this.elDelta>=0?"+":""}${this.elDelta} → EL${a}`),g=f.join(`
`)}const T=game.settings.get("motwm-xp","awardMode"),x=[...this.party.values()].map(f=>{var y,b;const M=((b=(y=this.manualAwards)==null?void 0:y.get)==null?void 0:b.call(y,f.id))??{amount:0,unit:"points",reason:""};return{...f,bubble:Math.round(D(f.level)),manual:M}});let A=[];const S=new Map;if(a>0&&x.some(f=>f.earns)){if(T==="raw35")x.filter(f=>f.earns).forEach(f=>{S.set(f.id,_(f.level,a))});else if(T==="split30"){const f=Math.round(x.reduce((v,P)=>v+P.level,0)/Math.max(1,x.length)),M=X(f,a),y=x.filter(v=>v.earns),b=R(M,1,y.length);y.forEach(v=>{S.set(v.id,b)})}}x.forEach(f=>{const M=S.get(f.id)||0,y=this.manualAwards.get(f.id);let b=0;if(y&&y.amount){const P=D(f.level);b=Math.round(y.unit==="bubbles"?y.amount*P:y.amount)}const v=M+b;v>0&&A.push({id:f.id,name:f.name,level:f.level,el:a||"—",xp:v})});const B=[...this.enemies.entries()].map(([f,M])=>({...M,mapKey:f,cr:F(Number(M.cr)||0)}));return{party:x,enemies:B,el:a,encounterInfo:w,elBreakdown:g,showElDetails:this.showElDetails,elDelta:this.elDelta,preview:A,hasRollback:!!this.lastAward}}activateListeners(t){super.activateListeners(t),t.on("click","[data-action='remove-party']",e=>{const s=e.currentTarget.dataset.id;this.party.delete(s),this.render()}),t.on("click","[data-action='remove-enemy']",e=>{const s=e.currentTarget.dataset.id;this.enemies.delete(s),this.render()}),t.on("change","input[data-action='toggle-earns']",e=>{const s=e.currentTarget.dataset.id,n=this.party.get(s);n&&(n.earns=e.currentTarget.checked,this.render(!1))}),t.on("change blur","[data-action='el-delta']",e=>{const s=e.currentTarget.value.trim();if(s===""||s==="-")return;const n=parseInt(s,10);this.elDelta=Number.isFinite(n)?n:0,this.render(!0)}),t.on("change blur","[data-action='award-amount']",e=>{const s=e.currentTarget.closest("[data-id]"),n=s==null?void 0:s.dataset.id,a=this.manualAwards.get(n)??{amount:0,unit:"points",reason:""};this.manualAwards.set(n,{...a,amount:Number(e.currentTarget.value)||0}),this.render(!1)}),t.on("change","[data-action='award-unit']",e=>{const s=e.currentTarget.closest("[data-id]"),n=s==null?void 0:s.dataset.id,a=this.manualAwards.get(n)??{amount:0,unit:"points",reason:""};this.manualAwards.set(n,{...a,unit:e.currentTarget.value}),this.render(!1)}),t.on("input","[data-action='award-reason']",e=>{const s=e.currentTarget.closest("[data-id]"),n=s==null?void 0:s.dataset.id,a=this.manualAwards.get(n)??{amount:0,unit:"points",reason:""};this.manualAwards.set(n,{...a,reason:e.currentTarget.value??""})}),t.on("click","[data-action='add-online-assigned']",()=>this.addAssignedPlayersToPartyOnlineOnly()),t.on("click","[data-action='add-all-assigned']",()=>this.addAssignedPlayersToPartyAll()),t.on("click","[data-action='add-friendly-scene']",()=>this.addFriendlySceneTokensToParty()),t.on("click","[data-action='add-selected-party']",()=>this.addSelectedToParty()),t.on("click","[data-action='add-selected-enemies']",()=>this.addSelectedToEnemies()),t.on("click","[data-action='add-hostile-scene']",()=>this.addHostileSceneTokensToEnemies()),t.on("click","[data-action='add-neutral-scene']",()=>this.addNeutralSceneTokensToEnemies()),t.on("click","[data-action='clear-party']",()=>{this.party.clear(),this.render(!0)}),t.on("click","[data-action='clear-enemies']",()=>{this.enemies.clear(),this.render(!0)}),t.on("click","[data-action='apply-xp']",()=>this.applyXP()),t.on("click","[data-action='rollback-xp']",()=>this.rollbackXP()),t.on("click","[data-action='toggle-el-details']",()=>{this.showElDetails=!this.showElDetails,this.render(!1)}),t.on("dblclick",".party .row",e=>{var a;const s=e.target;if(s.tagName==="INPUT"||s.tagName==="SELECT"||s.tagName==="BUTTON"||s.closest("button"))return;const n=e.currentTarget.dataset.id;if(n){const r=(a=game.actors)==null?void 0:a.get(n);r!=null&&r.sheet&&r.sheet.render(!0)}}),t.on("dblclick",".enemies .row",e=>{var a;const s=e.target;if(s.tagName==="BUTTON"||s.closest("button"))return;const n=e.currentTarget.dataset.actorId;if(n){const r=(a=game.actors)==null?void 0:a.get(n);r!=null&&r.sheet&&r.sheet.render(!0)}})}getActorCR(t){const e=["system.details.totalCr","system.details.cr.total","system.attributes.cr.total","system.details.cr.value","system.details.cr","data.details.totalCr","data.details.cr.total","data.details.cr.value","data.details.cr"];for(const a of e){const r=Number(getProperty(t,a));if(Number.isFinite(r)&&r>0)return r}const s=t.type,n=Number(getProperty(t,"system.details.level.value"))||0;return s==="character"?Math.max(1,Math.floor(n)):Math.max(1,Math.floor(n)||1)}addHostileSceneTokensToEnemies(){var a,r,i,o,l;const t=((a=CONST==null?void 0:CONST.TOKEN_DISPOSITIONS)==null?void 0:a.HOSTILE)??-1,s=(((r=canvas.tokens)==null?void 0:r.placeables)??[]).filter(h=>{var d;return((d=h.document)==null?void 0:d.disposition)===t});let n=0;for(const h of s){const d=h.actor,u=h.id;if(!(d!=null&&d.id)||!u||this.enemies.has(u))continue;const m=d.name??"Unknown",w=d.img??((o=(i=d.prototypeToken)==null?void 0:i.texture)==null?void 0:o.src)??"icons/svg/skull.svg",g=this.getActorCR(d);this.enemies.set(u,{id:d.id,tokenId:u,name:m,img:w,cr:g}),n++}(l=ui.notifications)==null||l.info(`Added ${n} hostile token(s) from this scene.`),this.render(!0)}addNeutralSceneTokensToEnemies(){var a,r,i,o,l;const t=((a=CONST==null?void 0:CONST.TOKEN_DISPOSITIONS)==null?void 0:a.NEUTRAL)??0,s=(((r=canvas.tokens)==null?void 0:r.placeables)??[]).filter(h=>{var d;return((d=h.document)==null?void 0:d.disposition)===t});let n=0;for(const h of s){const d=h.actor,u=h.id;if(!(d!=null&&d.id)||!u||this.enemies.has(u))continue;const m=d.name??"Unknown",w=d.img??((o=(i=d.prototypeToken)==null?void 0:i.texture)==null?void 0:o.src)??"icons/svg/eye.svg",g=this.getActorCR(d);this.enemies.set(u,{id:d.id,tokenId:u,name:m,img:w,cr:g}),n++}(l=ui.notifications)==null||l.info(`Added ${n} neutral token(s) from this scene.`),this.render(!0)}addActorsToParty(t){var s,n;let e=0;for(const a of t){if(!(a!=null&&a.id)||this.party.has(a.id))continue;const r=a.name??"Unknown",i=a.img??((n=(s=a.prototypeToken)==null?void 0:s.texture)==null?void 0:n.src)??"icons/svg/mystery-man.svg",o=Number(getProperty(a,"system.details.level.value"))||1;this.party.set(a.id,{id:a.id,name:r,img:i,level:o,earns:!0,friend:!1}),e++}return e}addAssignedPlayersToPartyOnlineOnly(){var a,r;const s=(((a=game.users)==null?void 0:a.players)??[]).filter(i=>i.active).map(i=>i.character).filter(i=>!!i),n=this.addActorsToParty(s);(r=ui.notifications)==null||r.info(`Added ${n} online assigned PC(s).`),this.render(!0)}addAssignedPlayersToPartyAll(){var n,a;const e=(((n=game.users)==null?void 0:n.players)??[]).map(r=>r.character).filter(r=>!!r),s=this.addActorsToParty(e);(a=ui.notifications)==null||a.info(`Added ${s} assigned PC(s) (all logins).`),this.render(!0)}addFriendlySceneTokensToParty(){var a,r,i;const t=((a=CONST==null?void 0:CONST.TOKEN_DISPOSITIONS)==null?void 0:a.FRIENDLY)??1,s=(((r=canvas.tokens)==null?void 0:r.placeables)??[]).filter(o=>{var l;return((l=o.document)==null?void 0:l.disposition)===t}).map(o=>o.actor).filter(o=>!!o),n=this.addActorsToParty(s);(i=ui.notifications)==null||i.info(`Added ${n} Friendly token actor(s) from this scene.`),this.render(!0)}populateScenePlayers(){var a,r,i;const t=((a=CONST==null?void 0:CONST.TOKEN_DISPOSITIONS)==null?void 0:a.FRIENDLY)??1,e=((r=canvas.tokens)==null?void 0:r.placeables)??[],s=[];for(const o of e){const l=o.document,h=o.actor??void 0;if(!l||!h)continue;const d=l.disposition===t,u=h.type==="character";d&&u&&s.push(h)}const n=this.addActorsToParty(s);(i=ui.notifications)==null||i.info(`Added ${n} Friendly PC(s) from this scene.`),this.render(!0)}addFoundryParty(){var n,a,r,i;let t=[];const e=game.party;(n=e==null?void 0:e.members)!=null&&n.length&&(t=e.members.map(o=>o==null?void 0:o.actor).filter(o=>!!o)),t.length||(t=(a=game.users)==null?void 0:a.players.map(l=>l.character).filter(l=>!!l)),t.length||(t=(((r=canvas.tokens)==null?void 0:r.placeables)??[]).map(l=>l.actor).filter(l=>!!l&&l.type==="character"));const s=this.addActorsToParty(t);(i=ui.notifications)==null||i.info(`Added ${s} actor(s) from Foundry Party.`),this.render(!0)}_manualAwardsToGrants(){var e,s;const t=[];for(const[n,a]of this.manualAwards){if(!a||!a.amount)continue;const r=(e=game.actors)==null?void 0:e.get(n);if(!r)continue;const i=r.name??n,o=Number(getProperty(r,"system.details.level.value")??1),l=D(o),h=Math.round(a.unit==="bubbles"?a.amount*l:a.amount);h!==0&&t.push({id:n,name:i,xp:h,reason:((s=a.reason)==null?void 0:s.trim())||"Manual award"})}return t}populatePartyPlayers(){var n,a;let t=0,e=0;const s=((n=game.users)==null?void 0:n.players)??[];for(const r of s){const i=r.character;if(!i)continue;if(this.enemies.has(i.id)){e++;continue}const o=O.getLevel(i)||1,l={id:i.id,name:i.name??"Actor",img:i.img??"",level:o,earns:!0,friend:!i.hasPlayerOwner};this.party.has(i.id)?e++:(this.party.set(i.id,l),t++)}(a=ui.notifications)==null||a.info(`Party +${t}${e?`, skipped ${e}`:""}`),this.render()}addSelectedToParty(){var n,a,r;const t=((n=canvas==null?void 0:canvas.tokens)==null?void 0:n.controlled)??[];if(!t.length)return(a=ui.notifications)==null?void 0:a.warn("Select one or more tokens first.");let e=0,s=0;for(const i of t){const o=i.actor;if(!o){s++;continue}if(this.enemies.has(o.id)){s++;continue}const l=O.getLevel(o)||1,h={id:o.id,name:o.name??"Actor",img:o.img??"",level:l,earns:!0,friend:!o.hasPlayerOwner};this.party.has(o.id)?s++:(this.party.set(o.id,h),e++)}(r=ui.notifications)==null||r.info(`Party +${e}${s?`, skipped ${s}`:""}`),this.render()}addSelectedToEnemies(){var n,a,r,i,o;const t=((n=canvas==null?void 0:canvas.tokens)==null?void 0:n.controlled)??[];if(!t.length){(a=ui.notifications)==null||a.warn("Select one or more tokens first.");return}let e=0,s=0;for(const l of t){const h=l.actor,d=l.id;if(!h||!d){s++;continue}if(this.party.has(h.id)||this.enemies.has(d)){s++;continue}const u=this.getActorCR(h);if(!Number.isFinite(u)||u<=0){s++;continue}const m=h.img??((i=(r=h.prototypeToken)==null?void 0:r.texture)==null?void 0:i.src)??"icons/svg/skull.svg",w=h.name??"Enemy",g={id:h.id,tokenId:d,name:w,img:m,cr:Number(u)};this.enemies.set(d,g),e++}(o=ui.notifications)==null||o.info(`Enemies +${e}${s?`, skipped ${s}`:""}`),this.render(!0)}addTargetedToEnemies(){var n,a,r;const t=((n=game.user)==null?void 0:n.targets)??new Set;if(!t.size)return(a=ui.notifications)==null?void 0:a.warn("Target one or more creatures first.");let e=0,s=0;for(const i of t){const o=i.actor,l=i.id;if(!o||!l){s++;continue}if(this.party.has(o.id)){s++;continue}const h=O.getCR(o);if(!h){s++;continue}const d={id:o.id,tokenId:l,name:o.name??"Enemy",img:o.img??"",cr:Number(h)};this.enemies.has(l)?s++:(this.enemies.set(l,d),e++)}(r=ui.notifications)==null||r.info(`Enemies +${e}${s?`, skipped ${s}`:""}`),this.render()}async applyXP(){var d;const t=[],e=[...this.party.values()],s=e.filter(u=>u.earns),n=new Map;for(const u of this.enemies.values()){const m=Math.max(.125,Number(u.cr)||1);n.set(m,(n.get(m)??0)+1)}const a=[];for(const[u,m]of n.entries())a.push(C(u,m));let r=a.length?I(a):0;r+=this.elDelta;const i=game.settings.get("motwm-xp","awardMode");if(r>0&&s.length){if(i==="raw35")for(const u of s)t.push({id:u.id,name:u.name,xp:_(u.level,r)});else if(i==="split30"){const u=Math.round(e.reduce((g,T)=>g+T.level,0)/Math.max(1,e.length)),m=X(u,r),w=R(m,1,s.length);for(const g of s)t.push({id:g.id,name:g.name,xp:w})}}const o=this._manualAwardsToGrants();if(!t.length&&!o.length){(d=ui.notifications)==null||d.info("No XP to award: add enemies and/or manual awards first.");return}const l=async u=>{var m;for(const w of u){const g=(m=game.actors)==null?void 0:m.get(w.id);if(!g)continue;const T=Number(getProperty(g,"system.details.xp.value")??0);await g.update({"system.details.xp.value":T+w.xp})}};t.length&&await l(t),o.length&&await l(o);const h=[];if(game.settings.get("motwm-xp","broadcastChat")){const u=w=>{var g;try{return TextEditor.escapeHTML(String(w??""))}catch{return(g=foundry.utils)!=null&&g.escapeHTML?foundry.utils.escapeHTML(String(w??"")):String(w??"").replace(/[&<>"']/g,T=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[T])}},m=w=>`<ul>${w.map(g=>{const T=u(g.name),x=g.reason?` <em>(${u(g.reason)})</em>`:"";return`<li><b>${T}</b>: +${g.xp.toLocaleString()} XP${x}</li>`}).join("")}</ul>`;if(t.length){const w=`<div><h3>Encounter XP Awards</h3>${m(t)}</div>`,g=await ChatMessage.create({content:w});g!=null&&g.id&&h.push(g.id)}if(o.length){const w=o.map(x=>{var A;return{...x,reason:((A=this.manualAwards.get(x.id))==null?void 0:A.reason)||"Manual award"}}),g=`<div><h3>Manual XP Awards</h3>${m(w)}</div>`,T=await ChatMessage.create({content:g});T!=null&&T.id&&h.push(T.id)}}this.lastAward={enemies:new Map(this.enemies),manualAwards:new Map(this.manualAwards),elDelta:this.elDelta,grants:[...t,...o],chatMessageIds:h},this.enemies.clear(),this.manualAwards.clear(),this.elDelta=0,this.render(!0)}async rollbackXP(){var e,s,n;if(!this.lastAward){(e=ui.notifications)==null||e.warn("No XP award to rollback.");return}for(const a of this.lastAward.chatMessageIds){const r=(s=game.messages)==null?void 0:s.get(a);await(r==null?void 0:r.delete())}await(async a=>{var r;for(const i of a){const o=(r=game.actors)==null?void 0:r.get(i.id);if(!o)continue;const l=Number(getProperty(o,"system.details.xp.value")??0);await o.update({"system.details.xp.value":l-i.xp})}})(this.lastAward.grants),this.enemies=new Map(this.lastAward.enemies),this.manualAwards=new Map(this.lastAward.manualAwards),this.elDelta=this.lastAward.elDelta,this.lastAward=null,(n=ui.notifications)==null||n.info("XP award rolled back."),this.render(!0)}}class K extends Application{constructor(t,e={}){super({popOut:!1,id:"motwmxp-bar",...e});E(this,"actor");E(this,"_dragging",!1);E(this,"_dragOffset",{x:0,y:0});E(this,"_wired",!1);this.actor=t}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"motwmxp-bar",template:"modules/motwm-xp/templates/xp-bar.hbs"})}_getSavedPos(){const t=game.settings.get("motwm-xp","barPos");if(!t)return null;try{const e=JSON.parse(t);return e&&Number.isFinite(e.left)&&Number.isFinite(e.top)?e:null}catch{return null}}async _savePos(t,e){await game.settings.set("motwm-xp","barPos",JSON.stringify({left:t,top:e}))}_applyPos(){const t=this.element[0];if(!t)return;const e=this._getSavedPos();if(t.style.position="fixed",t.style.zIndex="70000",e)t.style.left=`${e.left}px`,t.style.top=`${e.top}px`;else{const s=t.getBoundingClientRect().width||520,n=t.getBoundingClientRect().height||18,a=Math.round((window.innerWidth-s)/2),r=Math.round(window.innerHeight-n-8);t.style.left=`${a}px`,t.style.top=`${r}px`}}getData(){const t=Number(getProperty(this.actor,"system.details.level.value")??1),e=Number(getProperty(this.actor,"system.details.xp.value")??0),s=getProperty(this.actor,"system.details.xp.max"),n=Number(s??$(t+1)),r=[$(t),n,$(t+2),$(t+3)];let i=Math.max(0,e-r[0]);const o=[];for(let m=0;m<3;m++){const w=Math.max(1,r[m+1]-r[m]),g=Math.max(0,Math.min(1,i/w));o.push({class:`layer${m}`,width:Math.round(g*1e4)/100}),i=Math.max(0,i-w)}const l=[],h=z;for(let m=1;m<=13;m++)l.push({left:m/h*100,class:""});l.push({left:13/h*100,class:"mini"});const d=`Lv ${t} | ${e.toLocaleString()} / ${n.toLocaleString()} XP`,u=`Level: ${t}`;return{layers:o,segments:l,label:d,tooltip:u}}async _render(t,e){await super._render(t,e),this._applyPos();const s=this.element[0];s&&(s.addEventListener("pointerdown",n=>{var r,i;n.preventDefault();const a=s.getBoundingClientRect();s.style.left=`${a.left}px`,s.style.top=`${a.top}px`,this._dragging=!0,(i=(r=n.currentTarget).setPointerCapture)==null||i.call(r,n.pointerId),this._dragOffset.x=n.clientX-a.left,this._dragOffset.y=n.clientY-a.top}),!this._wired&&(this._wired=!0,window.addEventListener("pointermove",n=>{if(!this._dragging)return;const a=this.element[0];if(!a)return;const r=Math.max(0,Math.min(window.innerWidth-50,n.clientX-this._dragOffset.x)),i=Math.max(0,Math.min(window.innerHeight-24,n.clientY-this._dragOffset.y));a.style.left=`${r}px`,a.style.top=`${i}px`}),window.addEventListener("pointerup",async()=>{if(!this._dragging)return;this._dragging=!1;const n=this.element[0];if(!n)return;const a=parseInt(n.style.left||"0",10),r=parseInt(n.style.top||"0",10);await this._savePos(a,r)}),window.addEventListener("resize",()=>this._applyPos(),{passive:!0})))}render(t,e){return game.settings.get("motwm-xp","showPlayerBar")?super.render(t,e):this}}Hooks.once("init",()=>{console.log("motwm-xp | init"),j(),window.MOTWM_XP=window.MOTWM_XP??{bars:new Map}});Hooks.once("ready",()=>{var t;console.log("motwm-xp | ready");const p=game.settings.get("motwm-xp","showPlayerBar"),c=(t=game.user)==null?void 0:t.character;if(p&&c){const e=window.MOTWM_XP.bars;let s=e.get(c.id);s||(s=new K(c,{top:window.innerHeight-54,left:0}),e.set(c.id,s)),s.render(!0)}Hooks.on("updateActor",(e,s)=>{var r;const n=(r=game.user)==null?void 0:r.character;if(!n||e.id!==n.id)return;const a=window.MOTWM_XP.bars.get(n.id);a==null||a.render(!0)}),Hooks.on("updateSetting",(e,s)=>{var n;if(e.key==="motwm-xp.awardMode"&&((n=window.MOTWM_XP)!=null&&n.calc)){const a=window.MOTWM_XP.calc;a.element&&a.render(!1)}})});Hooks.on("getSceneControlButtons",p=>{var t,e;if(!((t=game.user)!=null&&t.isGM))return;const c=p.find(s=>s.name==="token");(e=c==null?void 0:c.tools)==null||e.push({name:"motwm-xp-calc",title:"Open XP Calculator",icon:"fas fa-calculator",visible:!0,onClick:()=>{var s;(s=window.MOTWM_XP)!=null&&s.calc||(window.MOTWM_XP.calc=new V),window.MOTWM_XP.calc.render(!0)},button:!0})});
//# sourceMappingURL=main.js.map
