{"version":3,"file":"main.js","sources":["../src/settings.ts","../src/d35e-adapter.ts","../src/calc/el.ts","../src/calc/xp.ts","../src/ui/XpCalculatorApp.ts","../src/ui/XpBarApp.ts","../src/main.ts"],"sourcesContent":["export function registerSettings() {\n  // Chat toggle\n  game.settings.register(\"motwm-xp\", \"broadcastChat\", {\n    name: \"Broadcast XP to Chat\",\n    hint: \"When enabled, XP awards are posted as chat messages visible to all players.\",\n    scope: \"world\",\n    config: true,\n    type: Boolean,\n    default: false\n  });\n\n  // Player XP bar visible\n  game.settings.register(\"motwm-xp\", \"showPlayerBar\", {\n    name: \"Show Player XP Bar\",\n    hint: \"Display a draggable XP progress bar on your screen for your assigned character.\",\n    scope: \"client\",\n    config: true,\n    type: Boolean,\n    default: true,\n    onChange: (value: boolean) => {\n      // Show/hide the XP bar immediately when the setting changes\n      const myActor = game.user?.character;\n      if (!myActor) return;\n      \n      const bars = (window as any).MOTWM_XP?.bars;\n      if (!bars) return;\n      \n      let app = bars.get(myActor.id);\n      \n      if (value) {\n        // Show the bar\n        if (!app) {\n          // XpBarApp class is stored in window.MOTWM_XP.XpBarApp by main.ts\n          const XpBarApp = (window as any).MOTWM_XP?.XpBarApp;\n          if (!XpBarApp) return;\n          app = new XpBarApp(myActor, { top: window.innerHeight - 54, left: 0 });\n          bars.set(myActor.id, app);\n        }\n        app.render(true);\n      } else {\n        // Hide the bar\n        if (app) {\n          (app as any).close();\n        }\n      }\n    }\n  });\n\n  // Player XP bar position (hidden, per-client)\n  game.settings.register(\"motwm-xp\", \"barPos\", {\n    name: \"XP Bar Position\",\n    scope: \"client\",\n    config: false,\n    type: String,\n    default: \"\"\n  });\n\n  // Calculator award mode (the calculator reads this)\n  game.settings.register(\"motwm-xp\", \"awardMode\", {\n    name: \"XP Award Method\",\n    hint: \"DMG 3.5e: Official per-monster method using Table 2-6 (each PC's level vs each monster's CR). D&D 3.0: Split-pot method (total party XP divided equally).\",\n    scope: \"world\",\n    config: true,\n    type: String,\n    choices: {\n      dmg35: \"D&D 3.5e (Individual XP)\",\n      split30: \"D&D 3.0 (split pot by APL)\"\n    },\n    default: \"dmg35\"\n  });\n}\n","export class D35EAdapter {\n  static getXP(actor: Actor): number {\n    // @ts-ignore\n    const v = getProperty(actor, \"system.details.xp.value\");\n    return Number(v ?? 0);\n  }\n  static async setXP(actor: Actor, value: number) {\n    return actor.update({ \"system.details.xp.value\": Number(value) });\n  }\n  static getLevel(actor: Actor): number {\n    // Prefer summed classes for characters\n    // @ts-ignore\n    const classes = getProperty(actor, \"system.classes\");\n    if (classes && typeof classes === \"object\") {\n      let total = 0;\n      for (const cls of Object.values(classes) as any[]) {\n        const lv = Number(getProperty(cls, \"level\") ?? 0);\n        total += lv;\n      }\n      if (total > 0) return total;\n    }\n    // Fallback (NPCs/monsters often have this)\n    // @ts-ignore\n    const fallback = getProperty(actor, \"system.details.level.value\");\n    return Number(fallback ?? 0);\n  }\n  static getCR(actor: Actor): number | null {\n    // D35E system stores CR in different ways:\n    // - system.details.totalCr = adjusted CR with templates (PRIORITY!)\n    // - system.details.cr = base CR without templates\n    const crPaths = [\n      \"system.details.totalCr\",     // D35E: adjusted CR (includes templates!) - CHECK THIS FIRST\n      \"system.details.cr.total\",    // alternative adjusted CR format\n      \"system.attributes.cr.total\", // yet another alternative\n      \"system.details.cr.value\",    // structured base CR\n      \"system.details.cr\",          // flat base CR number\n      \"data.details.totalCr\",       // legacy adjusted\n      \"data.details.cr.total\",      // legacy adjusted\n      \"data.details.cr.value\",      // legacy base CR\n      \"data.details.cr\"             // legacy flat number\n    ];\n    \n    for (const path of crPaths) {\n      // @ts-ignore\n      const cr = getProperty(actor, path);\n      if (cr != null && Number.isFinite(Number(cr))) return Number(cr);\n    }\n    \n    // fallback: treat level as CR (PC-sheet BBEG)\n    const lvl = this.getLevel(actor);\n    return lvl ? Number(lvl) : null;\n  }\n}\n","/** EL engine: combine same-CR (+2 per doubling), mixed-EL pairwise */\nexport function groupToEL(cr: number, count: number): number {\n  if (count <= 0) return -Infinity;\n  let el = cr;\n  let k = count;\n  while (k >= 2) {\n    el += 2;\n    k = Math.floor(k / 2);\n  }\n  return el;\n}\n\nexport function combineELs(els: number[]): number {\n  if (!els.length) return -Infinity;\n  let arr = els.slice().sort((a,b)=>a-b);\n  while (arr.length > 1) {\n    const a = arr.pop()!; // largest\n    const b = arr.pop()!; // second largest\n    const diff = Math.abs(a-b);\n    let combined = a;\n    \n    // DMG 3.5e rules (p. 49):\n    // - Same EL (diff 0): +2\n    // - 1-2 below: +1\n    // - 3-7 below: +1 (weaker but still contributes)\n    // - 8+ below: +0 (too weak to matter)\n    if (diff === 0) combined = a + 2;\n    else if (diff >= 1 && diff <= 7) combined = a + 1;\n    else combined = a; // diff 8+: too weak to matter\n    \n    arr.push(combined);\n    arr.sort((x,y)=>x-y);\n  }\n  return arr[0];\n}\n","/** ===== D35E progression helpers (single source of truth) ===== */\n\nexport function systemTotalXPForLevel(level: number): number {\n  const L = Math.max(1, Math.floor(level));\n  const rate = game.settings.get(\"D35E\", \"experienceRate\") as string; // \"fast\" | \"medium\" | \"slow\" (or others)\n  const table = (CONFIG as any)?.D35E?.CHARACTER_EXP_LEVELS?.[rate];\n  if (Array.isArray(table)) {\n    return Number(table[Math.min(L - 1, table.length - 1)] ?? 0);\n  }\n  // ultra-safe fallback: 3.5e classic quadratic\n  return Math.floor(1000 * ((L - 1) * L) / 2);\n}\n\n/** Total number of bubble segments in the XP bar UI */\nexport const TOTAL_BUBBLE_SEGMENTS = 13 + 1/3;\n\n/** ===== Award methods ===== */\n\n/** \n * D&D 3.5 XP Table\n */\nfunction getBaseXPForSingleMonster(pcLevel: number, monsterCR: number): number {\n  const TABLE_2_6: Record<number, Record<number, number>> = {\n    1: { 1: 300, 2: 600, 3: 900, 4: 1350, 5: 1800, 6: 2700, 7: 3600, 8: 5400, 9: 7200, 10: 10800 },\n    2: { 1: 300, 2: 600, 3: 900, 4: 1350, 5: 1800, 6: 2700, 7: 3600, 8: 5400, 9: 7200, 10: 10800 },\n    3: { 1: 300, 2: 600, 3: 900, 4: 1350, 5: 1800, 6: 2700, 7: 3600, 8: 5400, 9: 7200, 10: 10800 },\n    4: { 1: 300, 2: 600, 3: 800, 4: 1200, 5: 1600, 6: 2400, 7: 3200, 8: 4800, 9: 6400, 10: 9600, 11: 12800 },\n    5: { 1: 300, 2: 500, 3: 750, 4: 1000, 5: 1500, 6: 2250, 7: 3000, 8: 4500, 9: 6000, 10: 9000, 11: 12000, 12: 18000 },\n    6: { 1: 300, 2: 450, 3: 600, 4: 900, 5: 1200, 6: 1800, 7: 2700, 8: 3600, 9: 5400, 10: 7200, 11: 10800, 12: 14400, 13: 21600 },\n    7: { 1: 263, 2: 350, 3: 525, 4: 700, 5: 1050, 6: 1400, 7: 2100, 8: 3150, 9: 4200, 10: 6300, 11: 8400, 12: 12600, 13: 16800, 14: 25200 },\n    8: { 1: 200, 2: 300, 3: 400, 4: 600, 5: 800, 6: 1200, 7: 1600, 8: 2400, 9: 3600, 10: 4800, 11: 7200, 12: 9600, 13: 14400, 14: 19200, 15: 28800 },\n    9: { 1: 0, 2: 225, 3: 338, 4: 450, 5: 675, 6: 900, 7: 1350, 8: 1800, 9: 2700, 10: 4050, 11: 5400, 12: 8100, 13: 10800, 14: 16200, 15: 21600, 16: 32400 },\n    10: { 1: 0, 2: 0, 3: 250, 4: 375, 5: 500, 6: 750, 7: 1000, 8: 1500, 9: 2000, 10: 3000, 11: 4500, 12: 6000, 13: 9000, 14: 12000, 15: 18000, 16: 24000, 17: 36000 },\n    11: { 1: 0, 2: 0, 3: 0, 4: 275, 5: 413, 6: 550, 7: 825, 8: 1100, 9: 1650, 10: 2200, 11: 3300, 12: 4950, 13: 6600, 14: 9900, 15: 13200, 16: 19800, 17: 26400, 18: 39600 },\n    12: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 300, 6: 450, 7: 600, 8: 900, 9: 1200, 10: 1800, 11: 2400, 12: 3600, 13: 5400, 14: 7200, 15: 10800, 16: 14400, 17: 21600, 18: 28800, 19: 43200 },\n    13: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 325, 7: 488, 8: 650, 9: 975, 10: 1300, 11: 1950, 12: 2600, 13: 3900, 14: 5850, 15: 7800, 16: 11700, 17: 15600, 18: 23400, 19: 31200, 20: 46800 },\n    14: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 350, 8: 525, 9: 700, 10: 1050, 11: 1400, 12: 2100, 13: 2800, 14: 4200, 15: 6300, 16: 8400, 17: 12600, 18: 16800, 19: 25200, 20: 33600 },\n    15: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 375, 9: 563, 10: 750, 11: 1125, 12: 1500, 13: 2250, 14: 3000, 15: 4500, 16: 6750, 17: 9000, 18: 13500, 19: 18000, 20: 27000 },\n    16: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 400, 10: 600, 11: 800, 12: 1200, 13: 1600, 14: 2400, 15: 3200, 16: 4800, 17: 7200, 18: 9600, 19: 14400, 20: 19200 },\n    17: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 425, 11: 638, 12: 850, 13: 1275, 14: 1700, 15: 2550, 16: 3400, 17: 5100, 18: 7650, 19: 10200, 20: 15300 },\n    18: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 450, 12: 675, 13: 900, 14: 1350, 15: 1800, 16: 2700, 17: 3600, 18: 5400, 19: 8100, 20: 10800 },\n    19: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 475, 13: 713, 14: 950, 15: 1425, 16: 1900, 17: 2850, 18: 3800, 19: 5700, 20: 8550 },\n    20: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 500, 14: 750, 15: 1000, 16: 1500, 17: 2000, 18: 3000, 19: 4000, 20: 6000, 21: 11400, 22: 12000, 23: 22800, 24: 24000, 25: 36000, 26: 48000, 27: 72000, 28: 96000 },\n    21: { 13: 0, 14: 0, 15: 525, 16: 788, 17: 1050, 18: 1575, 19: 2100, 20: 3150, 21: 4200, 22: 6300, 23: 8400, 24: 12600, 25: 16800, 26: 25200, 27: 33600, 28: 50400, 29: 67200, 30: 100800 },\n    22: { 14: 0, 15: 0, 16: 550, 17: 825, 18: 1100, 19: 1650, 20: 2200, 21: 3300, 22: 4400, 23: 6600, 24: 8800, 25: 13200, 26: 17600, 27: 26400, 28: 35200, 29: 52800, 30: 70400, 31: 105600 },\n    23: { 15: 0, 16: 0, 17: 575, 18: 863, 19: 1150, 20: 1725, 21: 2300, 22: 3450, 23: 4600, 24: 6900, 25: 9200, 26: 13800, 27: 18400, 28: 27600, 29: 36800, 30: 55200, 31: 73600, 32: 110400 },\n    24: { 16: 0, 17: 0, 18: 600, 19: 900, 20: 1200, 21: 1800, 22: 2400, 23: 3600, 24: 4800, 25: 7200, 26: 9600, 27: 14400, 28: 19200, 29: 28800, 30: 38400, 31: 57600, 32: 76800, 33: 115200 },\n    25: { 17: 0, 18: 0, 19: 625, 20: 938, 21: 1250, 22: 1875, 23: 2500, 24: 3750, 25: 5000, 26: 7500, 27: 10000, 28: 15000, 29: 20000, 30: 30000, 31: 40000, 32: 60000, 33: 80000, 34: 120000 },\n    26: { 18: 0, 19: 0, 20: 650, 21: 975, 22: 1300, 23: 1950, 24: 2600, 25: 3900, 26: 5200, 27: 7800, 28: 10400, 29: 15600, 30: 20800, 31: 31200, 32: 41600, 33: 62400, 34: 83200, 35: 124800 },\n    27: { 19: 0, 20: 0, 21: 675, 22: 1013, 23: 1350, 24: 2025, 25: 2700, 26: 4050, 27: 5400, 28: 8100, 29: 10800, 30: 16200, 31: 21600, 32: 32400, 33: 43200, 34: 64800, 35: 86400, 36: 129600 },\n    28: { 20: 0, 21: 0, 22: 700, 23: 1050, 24: 1400, 25: 2100, 26: 2800, 27: 4200, 28: 5600, 29: 8400, 30: 11200, 31: 16800, 32: 22400, 33: 33600, 34: 44800, 35: 67200, 36: 89600, 37: 134400 },\n    29: { 21: 0, 22: 0, 23: 725, 24: 1088, 25: 1450, 26: 2175, 27: 2900, 28: 4350, 29: 5800, 30: 8700, 31: 11600, 32: 17400, 33: 23200, 34: 34800, 35: 46400, 36: 69600, 37: 92800, 38: 139200 },\n    30: { 22: 0, 23: 0, 24: 750, 25: 1125, 26: 1500, 27: 2250, 28: 3000, 29: 4500, 30: 6000, 31: 9000, 32: 12000, 33: 18000, 34: 24000, 35: 36000, 36: 48000, 37: 72000, 38: 96000, 39: 144000 },\n    31: { 23: 0, 24: 0, 25: 775, 26: 1163, 27: 1550, 28: 2325, 29: 3100, 30: 4650, 31: 6200, 32: 9300, 33: 12400, 34: 18600, 35: 24800, 36: 37200, 37: 49600, 38: 74400, 39: 99200, 40: 148800 },\n    32: { 24: 0, 25: 0, 26: 800, 27: 1200, 28: 1600, 29: 2400, 30: 3200, 31: 4800, 32: 6400, 33: 9600, 34: 12800, 35: 19200, 36: 25600, 37: 38400, 38: 51200, 39: 76800, 40: 102400 },\n    33: { 25: 0, 26: 0, 27: 825, 28: 1238, 29: 1650, 30: 2475, 31: 3300, 32: 4950, 33: 6600, 34: 9900, 35: 13200, 36: 19800, 37: 26400, 38: 39600, 39: 52800, 40: 79200 },\n    34: { 26: 0, 27: 0, 28: 850, 29: 1275, 30: 1700, 31: 2550, 32: 3400, 33: 5100, 34: 6800, 35: 10200, 36: 13600, 37: 20400, 38: 27200, 39: 40800, 40: 54400 },\n    35: { 27: 0, 28: 0, 29: 875, 30: 1313, 31: 1750, 32: 2625, 33: 3500, 34: 5250, 35: 7000, 36: 10500, 37: 14000, 38: 21000, 39: 28000, 40: 42000 },\n    36: { 28: 0, 29: 0, 30: 900, 31: 1350, 32: 1800, 33: 2700, 34: 3600, 35: 5400, 36: 7200, 37: 10800, 38: 14400, 39: 21600, 40: 28800 },\n    37: { 29: 0, 30: 0, 31: 925, 32: 1388, 33: 1850, 34: 2775, 35: 3700, 36: 5550, 37: 7400, 38: 11100, 39: 14800, 40: 22200 },\n    38: { 30: 0, 31: 0, 32: 950, 33: 1425, 34: 1900, 35: 2850, 36: 3800, 37: 5700, 38: 7600, 39: 11400, 40: 15200 },\n    39: { 31: 0, 32: 0, 33: 975, 34: 1463, 35: 1950, 36: 2925, 37: 3900, 38: 5850, 39: 7800, 40: 11700 },\n    40: { 32: 0, 33: 0, 34: 1000, 35: 1500, 36: 2000, 37: 3000, 38: 4000, 39: 6000, 40: 8000 }\n  };\n\n  const level = Math.max(1, Math.min(40, Math.floor(pcLevel)));\n  const cr = Math.max(0.125, monsterCR);\n  \n  // Handle fractional CRs (below CR 1)\n  if (cr < 1) {\n    // Fractional CRs scale proportionally from the CR 1 value\n    const cr1XP = TABLE_2_6[level]?.[1] ?? 0;\n    return Math.round(cr1XP * cr);\n  }\n  \n  const crInt = Math.floor(cr);\n  const row = TABLE_2_6[level];\n  \n  if (!row) return 0;\n  \n  // Direct table lookup\n  if (row[crInt] !== undefined) {\n    return row[crInt];\n  }\n  \n  // For CRs above the table, use DMG rule: double XP for every +2 CR\n  // Find the highest CR in this level's row\n  const maxCRInRow = Math.max(...Object.keys(row).map(k => parseInt(k)).filter(k => row[k] > 0));\n  if (crInt > maxCRInRow) {\n    // Calculate how many doubling steps above the max CR\n    const stepsAbove = Math.floor((crInt - maxCRInRow) / 2);\n    const baseXP = row[maxCRInRow] ?? 0;\n    return Math.round(baseXP * Math.pow(2, stepsAbove));\n  }\n  \n  return 0;\n}\n\n/**\n * Get XP for a monster with a fractional CR adjustment applied.\n * For whole number adjustments, just adds to CR.\n * For fractional adjustments (e.g., +1.5), interpolates between whole CR values.\n * \n * @param pcLevel - PC level\n * @param baseCR - Monster's base CR\n * @param crAdjustment - CR adjustment (can be fractional, e.g., 1.5, -0.3)\n * @param partySize - Number of PCs for division\n * @returns XP award for one PC\n */\nexport function getAdjustedMonsterXP(pcLevel: number, baseCR: number, crAdjustment: number, partySize: number): number {\n  if (partySize <= 0) return 0;\n  \n  // Apply the adjustment\n  const adjustedCR = Math.max(0.125, baseCR + crAdjustment);\n  \n  // If the adjustment is a whole number (or very close), just use direct lookup\n  const fractionalPart = adjustedCR - Math.floor(adjustedCR);\n  if (fractionalPart < 0.001) {\n    return Math.round(getBaseXPForSingleMonster(pcLevel, adjustedCR) / partySize);\n  }\n  \n  // For fractional CRs, interpolate between floor and ceiling\n  const floorCR = Math.floor(adjustedCR);\n  const ceilCR = Math.ceil(adjustedCR);\n  \n  const floorXP = getBaseXPForSingleMonster(pcLevel, floorCR);\n  const ceilXP = getBaseXPForSingleMonster(pcLevel, ceilCR);\n  \n  // Linear interpolation\n  const interpolatedXP = floorXP + (ceilXP - floorXP) * fractionalPart;\n  \n  return Math.round(interpolatedXP / partySize);\n}\n\n/** \n * D&D 3.0 XP Table: Returns the total party XP pot for a given APL and CR.\n * Supports decimal CR adjustments via linear interpolation.\n */\nexport function getPot30(apl: number, cr: number): number {\n  const TABLE_30: Record<number, Record<number, number>> = {\n    1:  { 1:300, 2:600, 3:900, 4:1350, 5:1800, 6:2700, 7:3600, 8:5400, 9:7200, 10:10800 },\n    2:  { 1:300, 2:600, 3:900, 4:1350, 5:1800, 6:2700, 7:3600, 8:5400, 9:7200, 10:10800 },\n    3:  { 1:300, 2:600, 3:900, 4:1350, 5:1800, 6:2700, 7:3600, 8:5400, 9:7200, 10:10800 },\n    4:  { 1:300, 2:600, 3:800, 4:1200, 5:1600, 6:2400, 7:3200, 8:4800, 9:6400, 10:9600, 11:12800, 12:18000, 13:21600, 14:28800 },\n    5:  { 1:300, 2:500, 3:750, 4:1000, 5:1500, 6:2250, 7:3000, 8:4500, 9:6000, 10:9000, 11:12000, 12:18000, 13:21600, 14:28800, 15:28800 },\n    6:  { 1:300, 2:450, 3:600, 4:900, 5:1200, 6:1800, 7:2400, 8:3600, 9:4800, 10:7200, 11:10800, 12:14400, 13:21600, 14:25200, 15:28800, 16:28800 },\n    7:  { 1:263, 2:394, 3:525, 4:700, 5:1050, 6:1400, 7:2100, 8:3150, 9:4200, 10:6300, 11:8400, 12:12600, 13:16800, 14:25200, 15:28800 },\n    8:  { 1:200, 2:300, 3:450, 4:600, 5:875, 6:1200, 7:1600, 8:2400, 9:3600, 10:4800, 11:6300, 12:8400, 13:12600, 14:16800, 15:25200, 16:28800 },\n    9:  { 1:0, 2:225, 3:338, 4:506, 5:675, 6:1013, 7:1350, 8:2025, 9:2700, 10:4050, 11:5400, 12:8100, 13:10800, 14:16200, 15:21600, 16:32400, 17:36000, 18:39600 },\n    10: { 3:250, 4:375, 5:563, 6:750, 7:1000, 8:1500, 9:2000, 10:3000, 11:3600, 12:4800, 13:6400, 14:9600 },\n    11: { 4:275, 5:413, 6:619, 7:825, 8:1238, 9:1650, 10:2475, 11:3300, 12:4950, 13:6600, 14:9900, 15:13200, 16:17600, 17:26400, 18:39600 },\n    12: { 5:300, 6:450, 7:675, 8:900, 9:1350, 10:1800, 11:1950, 12:2600, 13:3900, 14:5850, 15:7800, 16:11700, 17:15600, 18:23400, 19:31200, 20:46800 },\n    13: { 6:325, 7:488, 8:731, 9:975, 10:1463, 11:1400, 12:2100, 13:2800, 14:4200, 15:6300, 16:8400, 17:12600, 18:18900, 19:25200, 20:33600 },\n    14: { 6:350, 7:525, 8:788, 9:1050, 10:1575, 11:900, 12:1200, 13:1800, 14:2400, 15:4200, 16:4800, 17:7200, 18:10800, 19:13500, 20:18900 },\n    15: { 7:375, 8:563, 9:844, 10:1125, 11:638, 12:850, 13:1275, 14:1900, 15:2500, 16:4800, 17:7200, 18:10800, 19:13500, 20:18900 },\n    16: { 7:400, 8:600, 9:900, 10:1350, 11:900, 12:1200, 13:1800, 14:2400, 15:3200, 16:4800, 17:7200, 18:10800, 19:14400, 20:19200 },\n    17: { 8:425, 9:638, 10:956, 11:900, 12:1200, 13:1800, 14:2400, 15:3200, 16:4800, 17:7200, 18:10800, 19:14400, 20:19200 },\n    18: { 8:450, 9:675, 10:1013, 11:638, 12:850, 13:1275, 14:1900, 15:2500, 16:4800, 17:7200, 18:10800, 19:14400, 20:19200 },\n    19: { 9:475, 10:713, 11:638, 12:850, 13:1275, 14:1900, 15:2500, 16:4800, 17:7200, 18:10800, 19:14400, 20:19200 },\n    20: { 10:750, 11:900, 12:1200, 13:1800, 14:2400, 15:3200, 16:4800, 17:7200, 18:10800, 19:14400, 20:19200 },\n    21: { 11:1125, 12:1350, 13:1800, 14:2700, 15:3600, 16:4800, 17:7200, 18:10800, 19:14400, 20:21600, 21:28800, 22:43200, 23:57600, 24:76800 },\n    22: { 12:1688, 13:2025, 14:2700, 15:4050, 16:5400, 17:7200, 18:10800, 19:16200, 20:21600, 21:32400, 22:43200, 23:64800, 24:86400, 25:115200 },\n    23: { 13:2250, 14:2700, 15:3600, 16:5400, 17:7200, 18:9600, 19:14400, 20:21600, 21:28800, 22:43200, 23:57600, 24:86400, 25:115200, 26:153600 },\n    24: { 14:3000, 15:3600, 16:4800, 17:7200, 18:9600, 19:12800, 20:19200, 21:28800, 22:38400, 23:57600, 24:76800, 25:115200, 26:153600, 27:204800 },\n    25: { 15:4500, 16:5400, 17:7200, 18:10800, 19:14400, 20:19200, 21:28800, 22:43200, 23:57600, 24:86400, 25:115200, 26:172800, 27:230400, 28:307200 },\n    26: { 16:6750, 17:8100, 18:10800, 19:16200, 20:21600, 21:28800, 22:43200, 23:64800, 24:86400, 25:129600, 26:172800, 27:259200, 28:345600, 29:460800 },\n    27: { 17:9000, 18:10800, 19:14400, 20:21600, 21:28800, 22:38400, 23:57600, 24:86400, 25:115200, 26:172800, 27:230400, 28:345600, 29:460800, 30:614400 },\n    28: { 18:12000, 19:14400, 20:19200, 21:28800, 22:38400, 23:51200, 24:76800, 25:115200, 26:153600, 27:230400, 28:307200, 29:460800, 30:614400, 31:819200 },\n    29: { 19:18000, 20:21600, 21:28800, 22:43200, 23:57600, 24:76800, 25:115200, 26:172800, 27:230400, 28:345600, 29:460800, 30:691200, 31:921600, 32:1228800 },\n    30: { 20:27000, 21:32400, 22:43200, 23:64800, 24:86400, 25:115200, 26:172800, 27:259200, 28:345600, 29:518400, 30:691200, 31:1036800, 32:1382400, 33:1843200 },\n    31: { 21:36000, 22:43200, 23:57600, 24:86400, 25:115200, 26:153600, 27:230400, 28:345600, 29:460800, 30:691200, 31:921600, 32:1382400, 33:1843200, 34:2457600 },\n    32: { 22:48000, 23:57600, 24:76800, 25:115200, 26:153600, 27:204800, 28:307200, 29:460800, 30:614400, 31:921600, 32:1228800, 33:1843200, 34:2457600, 35:3276800 },\n    33: { 23:72000, 24:86400, 25:115200, 26:172800, 27:230400, 28:307200, 29:460800, 30:691200, 31:921600, 32:1382400, 33:1843200, 34:2764800, 35:3686400, 36:4915200 },\n    34: { 24:108000, 25:129600, 26:172800, 27:259200, 28:345600, 29:460800, 30:691200, 31:1036800, 32:1382400, 33:2073600, 34:2764800, 35:4147200, 36:5529600, 37:7372800 },\n    35: { 25:144000, 26:172800, 27:230400, 28:345600, 29:460800, 30:614400, 31:921600, 32:1382400, 33:1843200, 34:2764800, 35:3686400, 36:5529600, 37:7372800, 38:9830400 },\n    36: { 26:192000, 27:230400, 28:307200, 29:460800, 30:614400, 31:819200, 32:1228800, 33:1843200, 34:2457600, 35:3686400, 36:4915200, 37:7372800, 38:9830400, 39:13107200 },\n    37: { 27:288000, 28:345600, 29:460800, 30:691200, 31:921600, 32:1228800, 33:1843200, 34:2764800, 35:3686400, 36:5529600, 37:7372800, 38:11059200, 39:14745600, 40:19660800 },\n    38: { 28:432000, 29:518400, 30:691200, 31:1036800, 32:1382400, 33:1843200, 34:2764800, 35:4147200, 36:5529600, 37:8294400, 38:11059200, 39:16588800, 40:22118400 },\n    39: { 29:576000, 30:691200, 31:921600, 32:1382400, 33:1843200, 34:2457600, 35:3686400, 36:5529600, 37:7372800, 38:11059200, 39:14745600, 40:22118400 },\n    40: { 30:768000, 31:921600, 32:1228800, 33:1843200, 34:2457600, 35:3276800, 36:4915200, 37:7372800, 38:9830400, 39:14745600, 40:19660800 }\n  };\n\n  // Helper function to get XP for integer CR\n  const getIntegerPot = (aplInt: number, crInt: number): number => {\n    const levelRow = TABLE_30[aplInt];\n    if (!levelRow) return 0;\n    \n    const xp = levelRow[crInt];\n    if (xp !== undefined) return xp;\n    \n    // If CR not in table, use the baseline for that APL and apply the standard scaling\n    const baseXP = getBasePot30(aplInt);\n    const diff = crInt - aplInt;\n    \n    // Apply the alternating ×3/2, ×4/3 pattern for higher CRs\n    // Or ×2/3, ×3/4 pattern for lower CRs\n    let result = baseXP;\n    if (diff > 0) {\n      // Higher CR: alternating ×3/2 and ×4/3\n      for (let step = 0; step < diff; step++) {\n        result = Math.floor(result * (step % 2 === 0 ? 3/2 : 4/3));\n      }\n    } else if (diff < 0) {\n      // Lower CR: alternating ×2/3 and ×3/4\n      for (let step = 0; step < Math.abs(diff); step++) {\n        result = Math.floor(result * (step % 2 === 0 ? 2/3 : 3/4));\n      }\n    }\n    \n    return Math.max(0, result);\n  };\n\n  const aplInt = Math.max(1, Math.min(40, Math.floor(apl)));\n  const crFloor = Math.max(1, Math.floor(cr));\n  \n  // If CR is an integer, return directly\n  if (cr === crFloor) {\n    return getIntegerPot(aplInt, crFloor);\n  }\n  \n  // Decimal CR: interpolate between floor and ceiling\n  const crCeil = crFloor + 1;\n  const floorXP = getIntegerPot(aplInt, crFloor);\n  const ceilXP = getIntegerPot(aplInt, crCeil);\n  \n  // Linear interpolation\n  const fractionalPart = cr - crFloor;\n  const interpolatedXP = floorXP + (ceilXP - floorXP) * fractionalPart;\n  \n  return Math.round(interpolatedXP);\n}\n\n/** Helper: Get the baseline XP for a party level when CR = APL */\nfunction getBasePot30(apl: number): number {\n  // Levels 1-11: simple 300 × level\n  if (apl <= 11) return 300 * apl;\n  \n  // Irregular levels 12-15 (from actual table)\n  const irregular: Record<number, number> = { 12: 2600, 13: 2800, 14: 2400, 15: 2500 };\n  if (irregular[apl]) return irregular[apl];\n  \n  // Levels 16+: use the geometric progression pattern\n  // Starting from level 16 = 4800, apply ×1.5, ×1.5, ×4/3, ×4/3 pattern\n  let xp = 4800;\n  const pattern = [1.5, 1.5, 4/3, 4/3];\n  for (let level = 17; level <= apl; level++) {\n    const mult = pattern[(level - 17) % 4];\n    xp = Math.floor(xp * mult);\n  }\n  return xp;\n}\n\n/** Classic 3.0 Split: pass a total pot (you compute from APL vs EL) and return each share (weighted elsewhere) */\nexport function split30(pot: number, weight: number, totalWeight: number): number {\n  if (pot <= 0 || totalWeight <= 0) return 0;\n  return Math.round((pot * weight) / totalWeight);\n}\n","import { D35EAdapter } from \"../d35e-adapter\";\nimport { groupToEL, combineELs } from \"../calc/el\";\nimport { split30, getPot30, getAdjustedMonsterXP } from \"../calc/xp\";\n\ntype ManualAward = {\n  amount: number;                    // user-entered value\n  unit: \"points\" | \"bubbles\";        // how to interpret amount\n  reason: string;                    // chat reason\n};\n\n/** Format CR with Unicode fraction characters for common fractional CRs */\nfunction formatCR(cr: number): string {\n  // Common D&D fractional CRs with Unicode fractions\n  const fractions: Record<number, string> = {\n    0.125: \"⅛\",\n    0.25: \"¼\",\n    0.33: \"⅓\",\n    0.333: \"⅓\",\n    0.5: \"½\",\n    0.66: \"⅔\",\n    0.667: \"⅔\",\n    0.75: \"¾\"\n  };\n  \n  // Check if it's a known fraction (with small tolerance for floating point)\n  for (const [value, symbol] of Object.entries(fractions)) {\n    if (Math.abs(cr - parseFloat(value)) < 0.01) {\n      return symbol;\n    }\n  }\n  \n  // For whole numbers, just return the number\n  if (Number.isInteger(cr)) return cr.toString();\n  \n  // For other decimals, format to 2 decimal places\n  return cr.toFixed(2);\n}\n\nfunction bubbleSizeForLevel(level: number): number {\n  // per-level span divided by 13⅓\n  const start = (window as any).CONFIG?.D35E\n    ? (CONFIG as any).D35E.CHARACTER_EXP_LEVELS[game.settings.get(\"D35E\",\"experienceRate\") as string][Math.max(0, level-1)]\n    : 0;\n  const next  = (window as any).CONFIG?.D35E\n    ? (CONFIG as any).D35E.CHARACTER_EXP_LEVELS[game.settings.get(\"D35E\",\"experienceRate\") as string][Math.max(0, level)]\n    : start + 1000; // harmless fallback\n  const span = Math.max(1, Number(next) - Number(start));\n  return span / (13 + 1/3);\n}\n\nfunction getModSetting<T = any>(key: string, fallback: T): T {\n  try { return game.settings.get(\"motwm-xp\", key) as T; }\n  catch { return fallback; }\n}\n\ntype PartyEntry = { id: string; name: string; img: string; level: number; earns: boolean; friend: boolean; };\ntype EnemyEntry = { id: string; tokenId?: string; name: string; img: string; cr: number; };\n\nexport class XpCalculatorApp extends Application {\n  private party: Map<string, PartyEntry> = new Map();\n  private enemies: Map<string, EnemyEntry> = new Map();\n  private manualAwards: Map<string, ManualAward> = new Map(); // key: actorId\n  private elDelta: number = 0;\n  private showElDetails: boolean = false;\n  private isProcessing: boolean = false; // Prevent double-apply\n  private lastAward: {\n    enemies: Map<string, EnemyEntry>;\n    manualAwards: Map<string, ManualAward>;\n    elDelta: number;\n    grants: { id: string; name: string; xp: number }[];\n    chatMessageIds: string[];\n  } | null = null;\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      id: \"motwmxp-calc\",\n      title: \"MOTWM XP Calculator\",\n      width: 960,\n      height: 660,\n      resizable: true,\n      template: \"modules/motwm-xp/templates/xp-calculator.hbs\"\n    });\n  }\n\n/* ---------- DATA ---------- */\ngetData(): any {\n  // Build EL from enemies (group by CR)\n  const crMap = new Map<number, number>();\n  for (const e of this.enemies.values()) {\n    // Preserve fractional CRs (0.125, 0.25, 0.33, 0.5, etc.)\n    const cr = Math.max(0.125, Number(e.cr) || 1);\n    crMap.set(cr, (crMap.get(cr) ?? 0) + 1);\n  }\n  const groupELs: number[] = [];\n  for (const [cr, count] of crMap.entries()) groupELs.push(groupToEL(cr, count));\n\n  // EL with decimal modifier support for granular control\n  const baseEL = groupELs.length ? combineELs(groupELs) : 0;\n  const delta = Number.isFinite(this.elDelta) ? this.elDelta : 0;\n  const elInt = baseEL + delta; // use this for UI and award math\n\n  // Calculate party level for encounter difficulty (d20srd.org method)\n  // Uses power-based formula: always divides by 4 (assumes 4-PC baseline)\n  const partyLevels = [...this.party.values()].map(p => p.level);\n  const partySize = partyLevels.length;\n  \n  // Helper: Convert CR/level to \"power\" (exponential scale)\n  const crToPower = (level: number): number => {\n    if (level < 2) return level;\n    return Math.pow(2, level / 2);\n  };\n  \n  // Helper: Convert power back to level\n  const powerToLevel = (power: number): number => {\n    if (power < 2) return power;\n    return 2 * Math.log2(power);\n  };\n  \n  // Calculate average level (for XP awards - not affected by party size)\n  const averageLevel = partyLevels.length > 0 \n    ? partyLevels.reduce((sum, lvl) => sum + lvl, 0) / partyLevels.length \n    : 0;\n  \n  // Calculate party level (for difficulty - affected by party size via ÷4 baseline)\n  let partyLevel = 0;\n  if (partyLevels.length > 0) {\n    const totalPower = partyLevels.reduce((sum, lvl) => sum + crToPower(lvl), 0);\n    // Official calculator always divides by 4 (hardcoded baseline for 4-person party)\n    const partyPower = totalPower / 4;\n    partyLevel = powerToLevel(partyPower);\n  }\n  \n  const elDiff = elInt - partyLevel;\n  \n  let difficulty = \"—\";\n  if (partyLevel > 0 && elInt > 0) {\n    if (elDiff < -9) difficulty = \"Trivial\";\n    else if (elDiff < -4) difficulty = \"Very Easy\";\n    else if (elDiff < 0) difficulty = \"Easy\";\n    else if (elDiff === 0) difficulty = \"Challenging\";\n    else if (elDiff <= 4) difficulty = \"Very Difficult\";\n    else if (elDiff <= 7) difficulty = \"Overpowering\";\n    else difficulty = \"Unbeatable\";\n  }\n  \n  const encounterInfo = partyLevel > 0 && elInt > 0 \n    ? `Party: ${partySize} PCs, Avg Lvl ${averageLevel.toFixed(1)}, Party Level ${partyLevel.toFixed(1)} | EL: ${elInt} | Difficulty: ${difficulty} (${elDiff >= 0 ? '+' : ''}${elDiff.toFixed(1)})`\n    : \"—\";\n\n  // Detailed EL breakdown for toggle view with step-by-step tree format\n  let elBreakdown = \"\";\n  if (groupELs.length > 0) {\n    const lines: string[] = [];\n    \n    // Step 1: Show individual CR group conversions\n    const crGroups = [...crMap.entries()].map(([cr, count]) => {\n      const groupEL = groupToEL(cr, count);\n      return { cr, count, groupEL, text: `${count}×CR${formatCR(cr)} → EL${groupEL}` };\n    }).sort((a, b) => b.groupEL - a.groupEL); // Sort by EL descending\n    \n    lines.push(...crGroups.map(g => `└─ ${g.text}`));\n    \n    // Step 2: Show combination process if multiple groups\n    if (crGroups.length > 1) {\n      const sortedELs = crGroups.map(g => g.groupEL).sort((a, b) => b - a);\n      let combineSteps: string[] = [];\n      let remaining = [...sortedELs];\n      \n      while (remaining.length > 1) {\n        const highest = remaining.shift()!;\n        const second = remaining.shift()!;\n        const diff = Math.abs(highest - second);\n        let combined = highest;\n        \n        // DMG 3.5e combination rules (p. 49)\n        if (diff === 0) {\n          combined = highest + 2;\n          combineSteps.push(`EL${highest} + EL${second} (same level) → EL${combined}`);\n        } else if (diff >= 1 && diff <= 2) {\n          combined = highest + 1;\n          combineSteps.push(`EL${highest} + EL${second} (−${diff}) → EL${combined}`);\n        } else if (diff >= 3 && diff <= 7) {\n          combined = highest + 1;\n          combineSteps.push(`EL${highest} + EL${second} (−${diff}, weak but helps) → EL${combined}`);\n        } else {\n          // diff >= 8: too weak to contribute\n          combineSteps.push(`EL${highest} + EL${second} (−${diff}, too weak) → EL${highest}`);\n        }\n        \n        remaining.push(combined);\n        remaining.sort((a, b) => b - a);\n      }\n      \n      lines.push(...combineSteps.map(step => `    └─ ${step}`));\n    }\n    \n    // Step 3: Show EL modifier if any\n    if (this.elDelta !== 0) {\n      lines.push(`    └─ EL modifier ${this.elDelta >= 0 ? '+' : ''}${this.elDelta} → EL${elInt}`);\n    }\n    \n    elBreakdown = lines.join('\\n');\n  }\n\n  // Settings\n  const awardMode = game.settings.get(\"motwm-xp\", \"awardMode\") as string;\n\n  // Party array + display bubble size + current manual award values\n  const partyArr = [...this.party.values()].map(p => {\n    const m = this.manualAwards?.get?.(p.id) ?? { amount: 0, unit: \"points\", reason: \"\" };\n    return {\n      ...p,\n      bubble: Math.round(bubbleSizeForLevel(p.level)),\n      manual: m\n    };\n  });\n\n  // Live preview - calculate encounter XP + manual awards\n  let preview: any[] = [];\n\n  // First, get encounter XP for earners\n  const encounterXpMap = new Map<string, number>();\n  if (partyArr.some(p => p.earns)) {\n    if (awardMode === \"dmg35\") {\n      // DMG 3.5e per-monster method (Table 2-6, p.38)\n      // Apply EL modifier with decimal interpolation\n      const earners = partyArr.filter(p => p.earns);\n      const partySize = earners.length;\n      \n      // Apply CR adjustment from EL modifier (supports decimals via interpolation)\n      const crAdjustment = delta;\n      \n      earners.forEach(p => {\n        let totalXP = 0;\n        for (const e of this.enemies.values()) {\n          const baseCR = Number(e.cr) || 1;\n          totalXP += getAdjustedMonsterXP(p.level, baseCR, crAdjustment, partySize);\n        }\n        encounterXpMap.set(p.id, totalXP);\n      });\n    } else if (awardMode === \"split30\" && elInt > 0) {\n      // D&D 3.0 split pot (using actual DMG table)\n      const apl = Math.round(partyArr.reduce((a, p) => a + p.level, 0) / Math.max(1, partyArr.length));\n      const pot = getPot30(apl, elInt);\n      const earners = partyArr.filter(p => p.earns);\n      const slice = split30(pot, 1, earners.length);\n      earners.forEach(p => {\n        encounterXpMap.set(p.id, slice);\n      });\n    }\n  }\n\n  // Now build preview including manual awards for ALL party members who have either\n  partyArr.forEach(p => {\n    const encounterXp = encounterXpMap.get(p.id) || 0;\n    const manualAward = this.manualAwards.get(p.id);\n    let manualXp = 0;\n    \n    if (manualAward && manualAward.amount) {\n      const bubbleSize = bubbleSizeForLevel(p.level);\n      manualXp = Math.round(manualAward.unit === \"bubbles\" ? manualAward.amount * bubbleSize : manualAward.amount);\n    }\n    \n    const totalXp = encounterXp + manualXp;\n    \n    // Only show in preview if they're getting XP from either source\n    if (totalXp > 0) {\n      preview.push({\n        id: p.id,\n        name: p.name,\n        level: p.level,\n        el: elInt || \"—\",\n        xp: totalXp\n      });\n    }\n  });\n\n  // Transform enemies to include the Map key (tokenId if available, else actor id)\n  const enemiesArr = [...this.enemies.entries()].map(([mapKey, enemy]) => ({\n    ...enemy,\n    mapKey, // Add the actual Map key so the template can use it for removal\n    cr: formatCR(Number(enemy.cr) || 0) // Format CR with Unicode fractions\n  }));\n\n  return {\n    party: partyArr,\n    enemies: enemiesArr,\n    el: elInt,               // EL for UI (includes decimal modifier)\n    encounterInfo: encounterInfo,\n    elBreakdown: elBreakdown,\n    showElDetails: this.showElDetails,\n    elDelta: this.elDelta,   // bind input directly to this value\n    preview,\n    hasRollback: !!this.lastAward\n  };\n}\n\n/* ---------- LISTENERS ---------- */\nactivateListeners(html: JQuery) {\n  super.activateListeners(html);\n\n  // --- Row actions ---\n  html.on(\"click\", \"[data-action='remove-party']\", ev => {\n    const id = (ev.currentTarget as HTMLElement).dataset.id!;\n    this.party.delete(id);\n    this.render();\n  });\n\n  html.on(\"click\", \"[data-action='remove-enemy']\", ev => {\n    const id = (ev.currentTarget as HTMLElement).dataset.id!;\n    this.enemies.delete(id);\n    this.render();\n  });\n\n  html.on(\"change\", \"input[data-action='toggle-earns']\", ev => {\n    const id = (ev.currentTarget as HTMLInputElement).dataset.id!;\n    const p = this.party.get(id);\n    if (p) {\n      p.earns = (ev.currentTarget as HTMLInputElement).checked;\n      this.render(false);\n    }\n  });\n\n  // --- EL modifier: allow decimals for granular control, allow negatives ---\n  html.on(\"change blur\", \"[data-action='el-delta']\", ev => {\n    const s = (ev.currentTarget as HTMLInputElement).value.trim();\n    \n    // Empty field = 0\n    if (s === \"\") {\n      this.elDelta = 0;\n      this.render(true);\n      return;\n    }\n    \n    // Ignore incomplete input during typing\n    if (s === \"-\" || s === \".\") {\n      return;\n    }\n    \n    const n = parseFloat(s);\n    this.elDelta = Number.isFinite(n) ? n : 0;         // commit decimal value\n    this.render(true);                                  // refresh preview\n  });\n\n  // --- Manual Award inputs (per-party row) ---\n  html.on(\"change blur\", \"[data-action='award-amount']\", ev => {\n    const row = (ev.currentTarget as HTMLElement).closest(\"[data-id]\") as HTMLElement;\n    const id = row?.dataset.id!;\n    const prev = this.manualAwards.get(id) ?? { amount: 0, unit: \"points\", reason: \"\" };\n    this.manualAwards.set(id, { ...prev, amount: Number((ev.currentTarget as HTMLInputElement).value) || 0 });\n    this.render(false); // Update preview\n  });\n\n  html.on(\"change\", \"[data-action='award-unit']\", ev => {\n    const row = (ev.currentTarget as HTMLElement).closest(\"[data-id]\") as HTMLElement;\n    const id = row?.dataset.id!;\n    const prev = this.manualAwards.get(id) ?? { amount: 0, unit: \"points\", reason: \"\" };\n    this.manualAwards.set(id, { ...prev, unit: ((ev.currentTarget as HTMLSelectElement).value as \"points\" | \"bubbles\") });\n    this.render(false); // Update preview\n  });\n\n  html.on(\"input\", \"[data-action='award-reason']\", ev => {\n    const row = (ev.currentTarget as HTMLElement).closest(\"[data-id]\") as HTMLElement;\n    const id = row?.dataset.id!;\n    const prev = this.manualAwards.get(id) ?? { amount: 0, unit: \"points\", reason: \"\" };\n    this.manualAwards.set(id, { ...prev, reason: (ev.currentTarget as HTMLInputElement).value ?? \"\" });\n    // No render needed for reason - it's just for chat message\n  });\n\n  // --- Party / setup sources (NEW canonical set) ---\n  html.on(\"click\", \"[data-action='add-online-assigned']\", () => this.addAssignedPlayersToPartyOnlineOnly());\n  html.on(\"click\", \"[data-action='add-all-assigned']\",   () => this.addAssignedPlayersToPartyAll());\n  html.on(\"click\", \"[data-action='add-friendly-scene']\", () => this.addFriendlySceneTokensToParty());\n  html.on(\"click\", \"[data-action='add-selected-party']\", () => this.addSelectedToParty());\n\n  // --- Enemies sources ---\n  html.on(\"click\", \"[data-action='add-selected-enemies']\", () => this.addSelectedToEnemies());\n  html.on(\"click\", \"[data-action='add-hostile-scene']\",    () => this.addHostileSceneTokensToEnemies());\n  html.on(\"click\", \"[data-action='add-neutral-scene']\",    () => this.addNeutralSceneTokensToEnemies());\n\n  // --- Clearers ---\n  html.on(\"click\", \"[data-action='clear-party']\",   () => { this.party.clear();   this.render(true); });\n  html.on(\"click\", \"[data-action='clear-enemies']\", () => { this.enemies.clear(); this.render(true); });\n\n  // --- Apply & Rollback ---\n  html.on(\"click\", \"[data-action='apply-xp']\", () => this.applyXP());\n  html.on(\"click\", \"[data-action='rollback-xp']\", () => this.rollbackXP());\n\n  // --- EL Details Toggle ---\n  html.on(\"click\", \"[data-action='toggle-el-details']\", () => {\n    this.showElDetails = !this.showElDetails;\n    (this as any).render(false);\n  });\n\n  // --- Double-click to open character sheets ---\n  html.on(\"dblclick\", \".party .row\", ev => {\n    // Don't open sheet if user double-clicked on interactive elements\n    const target = ev.target as HTMLElement;\n    if (target.tagName === 'INPUT' || target.tagName === 'SELECT' || target.tagName === 'BUTTON' || target.closest('button')) {\n      return;\n    }\n    \n    const id = (ev.currentTarget as HTMLElement).dataset.id;\n    if (id) {\n      const actor = (game as any).actors?.get(id);\n      if (actor?.sheet) {\n        (actor.sheet as any).render(true);\n      }\n    }\n  });\n\n  html.on(\"dblclick\", \".enemies .row\", ev => {\n    // Don't open sheet if user double-clicked on interactive elements\n    const target = ev.target as HTMLElement;\n    if (target.tagName === 'BUTTON' || target.closest('button')) {\n      return;\n    }\n    \n    // Use data-actor-id to get the actor (not the token ID from data-id)\n    const actorId = (ev.currentTarget as HTMLElement).dataset.actorId;\n    if (actorId) {\n      const actor = (game as any).actors?.get(actorId);\n      if (actor?.sheet) {\n        (actor.sheet as any).render(true);\n      }\n    }\n  });\n  }\n  \n/** --- CR extraction used for enemies (unified across all adders) --- */\nprivate getActorCR(a: Actor): number {\n  // D35E system stores CR in different ways:\n  // - system.details.totalCr = adjusted CR with templates (PRIORITY - this is what we want!)\n  // - system.details.cr = base CR without templates\n  // - system.details.cr.total or system.details.cr.value = alternative structures\n  \n  const crPaths = [\n    \"system.details.totalCr\",     // D35E: adjusted CR (includes templates!) - CHECK THIS FIRST\n    \"system.details.cr.total\",    // alternative adjusted CR format\n    \"system.attributes.cr.total\", // yet another alternative\n    \"system.details.cr.value\",    // structured base CR\n    \"system.details.cr\",          // flat base CR number\n    \"data.details.totalCr\",       // legacy adjusted\n    \"data.details.cr.total\",      // legacy adjusted\n    \"data.details.cr.value\",      // legacy base CR\n    \"data.details.cr\"             // legacy flat number\n  ];\n\n  for (const p of crPaths) {\n    // @ts-ignore\n    const v = Number(getProperty(a, p));\n    // Preserve fractional CRs (0.125, 0.25, 0.33, 0.5, etc.) - don't round them to 0!\n    if (Number.isFinite(v) && v > 0) return v;\n  }\n\n  // Derive from level if no explicit CR present\n  // @ts-ignore\n  const type  = (a as any).type;\n  // @ts-ignore\n  const level = Number(getProperty(a, \"system.details.level.value\")) || 0;\n\n  if (type === \"character\") {\n    // RAW quick heuristic: PC CR ≈ Character Level\n    return Math.max(1, Math.floor(level));\n  }\n\n  // Monsters/NPCs with no CR: fall back to level if present, else 1\n  return Math.max(1, Math.floor(level) || 1);\n}\n\n\n/** Add all hostile tokens on the current scene to the enemies list (with proper CR). */\nprivate addHostileSceneTokensToEnemies(): void {\n  const HOSTILE = (CONST as any)?.TOKEN_DISPOSITIONS?.HOSTILE ?? -1;\n  const tokens = canvas.tokens?.placeables ?? [];\n  const hostileTokens = tokens.filter(t => (t as any).document?.disposition === HOSTILE);\n\n  let added = 0;\n  for (const t of hostileTokens) {\n    const a = t.actor;\n    const tokenId = (t as any).id;\n    if (!a?.id || !tokenId || this.enemies.has(tokenId)) continue;\n\n    const name = a.name ?? \"Unknown\";\n    // @ts-ignore\n    const img  = a.img ?? a.prototypeToken?.texture?.src ?? \"icons/svg/skull.svg\";\n    const cr   = this.getActorCR(a); // <-- unified CR conversion\n\n    this.enemies.set(tokenId, { id: a.id, tokenId, name, img, cr });\n    added++;\n  }\n  ui.notifications?.info(`Added ${added} hostile token(s) from this scene.`);\n  this.render(true);\n}\n\n/** Add all neutral tokens on the current scene to the enemies list (with proper CR). */\nprivate addNeutralSceneTokensToEnemies(): void {\n  const NEUTRAL = (CONST as any)?.TOKEN_DISPOSITIONS?.NEUTRAL ?? 0;\n  const tokens = canvas.tokens?.placeables ?? [];\n  const neutralTokens = tokens.filter(t => (t as any).document?.disposition === NEUTRAL);\n\n  let added = 0;\n  for (const t of neutralTokens) {\n    const a = t.actor;\n    const tokenId = (t as any).id;\n    if (!a?.id || !tokenId || this.enemies.has(tokenId)) continue;\n\n    const name = a.name ?? \"Unknown\";\n    // @ts-ignore\n    const img  = a.img ?? a.prototypeToken?.texture?.src ?? \"icons/svg/eye.svg\";\n    const cr   = this.getActorCR(a); // <-- unified CR conversion\n\n    this.enemies.set(tokenId, { id: a.id, tokenId, name, img, cr });\n    added++;\n  }\n  ui.notifications?.info(`Added ${added} neutral token(s) from this scene.`);\n  this.render(true);\n}\n\n/** Add a batch of actors into the calculator \"party\" list (dedup by actor id). */\nprivate addActorsToParty(actors: Actor[]): number {\n  let added = 0;\n  for (const a of actors) {\n    if (!a?.id || this.party.has(a.id)) continue;\n\n    const name  = a.name ?? \"Unknown\";\n    // @ts-ignore\n    const img   = a.img ?? a.prototypeToken?.texture?.src ?? \"icons/svg/mystery-man.svg\";\n    // @ts-ignore\n    const level = Number(getProperty(a, \"system.details.level.value\")) || 1;\n\n    this.party.set(a.id, { id: a.id, name, img, level, earns: true, friend: false });\n    added++;\n  }\n  return added;\n}\n\n\n/** (1) Online users with assigned characters (simulate party addon). */\nprivate addAssignedPlayersToPartyOnlineOnly(): void {\n  const users = game.users?.players ?? [];\n  const online = users.filter(u => u.active);\n  const actors = online.map(u => u.character).filter((a): a is Actor => !!a);\n  const added = this.addActorsToParty(actors);\n  ui.notifications?.info(`Added ${added} online assigned PC(s).`);\n  this.render(true);\n}\n\n/** (2) All users with assigned characters (online or not). */\nprivate addAssignedPlayersToPartyAll(): void {\n  const users = game.users?.players ?? [];\n  const actors = users.map(u => u.character).filter((a): a is Actor => !!a);\n  const added = this.addActorsToParty(actors);\n  ui.notifications?.info(`Added ${added} assigned PC(s) (all logins).`);\n  this.render(true);\n}\n\n/** (3) All tokens marked Friendly on current scene (any actor behind them). */\nprivate addFriendlySceneTokensToParty(): void {\n  const FRIENDLY = (CONST as any)?.TOKEN_DISPOSITIONS?.FRIENDLY ?? 1;\n  const tokens = canvas.tokens?.placeables ?? [];\n  const actors = tokens\n    .filter(t => (t as any).document?.disposition === FRIENDLY)\n    .map(t => t.actor)\n    .filter((a): a is Actor => !!a);\n\n  const added = this.addActorsToParty(actors);\n  ui.notifications?.info(`Added ${added} Friendly token actor(s) from this scene.`);\n  this.render(true);\n}\n\n/** Populate from the CURRENT SCENE: only Friendly PC tokens (actor.type === \"character\"). */\nprivate populateScenePlayers(): void {\n  const FRIENDLY = (CONST as any)?.TOKEN_DISPOSITIONS?.FRIENDLY ?? 1;\n\n  const tokens = canvas.tokens?.placeables ?? [];\n  const actors: Actor[] = [];\n\n  for (const t of tokens) {\n    const doc = (t as any).document;           // TokenDocument\n    const a: Actor | undefined = t.actor ?? undefined;\n    if (!doc || !a) continue;\n\n    const isFriendly = doc.disposition === FRIENDLY;\n    const isPC = (a as any).type === \"character\";  // D35E PCs\n\n    if (isFriendly && isPC) actors.push(a);\n  }\n\n  const added = this.addActorsToParty(actors);\n  ui.notifications?.info(`Added ${added} Friendly PC(s) from this scene.`);\n  this.render(true);\n}\n\n/** Add members from Foundry's built-in Party (game.party.members). */\nprivate addFoundryParty(): void {\n  let actors: Actor[] = [];\n\n  // Primary: Core Party (v11+)\n  const coreParty: any = (game as any).party;\n  if (coreParty?.members?.length) {\n    actors = coreParty.members\n      .map((m: any) => m?.actor)\n      .filter((a: Actor | undefined) => !!a);\n  }\n\n  // OPTIONAL fallback: if you want strictly \"Party only\", comment these two blocks out\n  if (!actors.length) {\n    // Fallback #1: users' assigned characters\n    const pcs = game.users?.players\n      .map(u => u.character)\n      .filter((a: Actor | undefined) => !!a) as Actor[];\n    actors = pcs;\n  }\n  if (!actors.length) {\n    // Fallback #2: any PC actors on scene (not restricted to Friendly)\n    const tokens = canvas.tokens?.placeables ?? [];\n    actors = tokens\n      .map(t => t.actor)\n      .filter((a): a is Actor => !!a && ((a as any).type === \"character\"));\n  }\n  // END fallbacks\n\n  const added = this.addActorsToParty(actors);\n  ui.notifications?.info(`Added ${added} actor(s) from Foundry Party.`);\n  this.render(true);\n}\n  /* ---------- ACTIONS ---------- */\n\n  private _manualAwardsToGrants(): { id: string; name: string; xp: number; reason: string }[] {\n  const out: { id: string; name: string; xp: number; reason: string }[] = [];\n  for (const [id, award] of this.manualAwards) {\n    if (!award || !award.amount) continue;\n    const actor = game.actors?.get(id);\n    if (!actor) continue;\n    const name = actor.name ?? id;\n    // @ts-ignore\n    const lvl = Number(getProperty(actor, \"system.details.level.value\") ?? 1);\n    const perBubble = bubbleSizeForLevel(lvl);\n    const xp = Math.round(award.unit === \"bubbles\" ? award.amount * perBubble : award.amount);\n    if (xp !== 0) out.push({ id, name, xp, reason: award.reason?.trim() || \"Manual award\" });\n  }\n  return out;\n}\n\n  private populatePartyPlayers() {\n    let added = 0, skipped = 0;\n    const players = game.users?.players ?? [];\n    for (const u of players) {\n      const a = u.character as Actor | undefined;\n      if (!a) continue;\n      if (this.enemies.has(a.id)) { skipped++; continue; }\n      const level = D35EAdapter.getLevel(a) || 1;\n      const entry: PartyEntry = {\n        id: a.id, name: a.name ?? \"Actor\", img: a.img ?? \"\",\n        level, earns: true, friend: !a.hasPlayerOwner\n      };\n      if (!this.party.has(a.id)) { this.party.set(a.id, entry); added++; } else skipped++;\n    }\n    ui.notifications?.info(`Party +${added}${skipped ? `, skipped ${skipped}` : \"\"}`);\n    this.render();\n  }\n\n  private addSelectedToParty() {\n    const selected = canvas?.tokens?.controlled ?? [];\n    if (!selected.length) return ui.notifications?.warn(\"Select one or more tokens first.\");\n    let added = 0, skipped = 0;\n    for (const t of selected) {\n      const a = (t as any).actor as Actor | null;\n      if (!a) { skipped++; continue; }\n      if (this.enemies.has(a.id)) { skipped++; continue; }\n      const level = D35EAdapter.getLevel(a) || 1;\n      const entry: PartyEntry = {\n        id: a.id, name: a.name ?? \"Actor\", img: a.img ?? \"\",\n        level, earns: true, friend: !a.hasPlayerOwner\n      };\n      if (!this.party.has(a.id)) { this.party.set(a.id, entry); added++; } else skipped++;\n    }\n    ui.notifications?.info(`Party +${added}${skipped ? `, skipped ${skipped}` : \"\"}`);\n    this.render();\n  }\n\n/** Add currently selected canvas tokens as enemies (uses unified CR logic). */\nprivate addSelectedToEnemies(): void {\n  const selected = canvas?.tokens?.controlled ?? [];\n  if (!selected.length) {\n    ui.notifications?.warn(\"Select one or more tokens first.\");\n    return;\n  }\n\n  let added = 0, skipped = 0;\n\n  for (const t of selected) {\n    const a: Actor | undefined = (t as any).actor;\n    const tokenId = (t as any).id;\n    if (!a || !tokenId) { skipped++; continue; }\n\n    // Don't duplicate party members or existing enemies (use token ID for enemies now)\n    if (this.party.has(a.id) || this.enemies.has(tokenId)) { skipped++; continue; }\n\n    // Unified CR extraction (matches hostile/neutral adders)\n    const cr = this.getActorCR(a);\n    if (!Number.isFinite(cr) || cr <= 0) { skipped++; continue; }\n\n    // Safe image fallbacks\n    // @ts-ignore\n    const img = a.img ?? a.prototypeToken?.texture?.src ?? \"icons/svg/skull.svg\";\n    const name = a.name ?? \"Enemy\";\n\n    const entry: EnemyEntry = { id: a.id, tokenId, name, img, cr: Number(cr) };\n    this.enemies.set(tokenId, entry);\n    added++;\n  }\n\n  ui.notifications?.info(`Enemies +${added}${skipped ? `, skipped ${skipped}` : \"\"}`);\n  this.render(true); // refresh preview with updated enemies\n}\n\n\n  private addTargetedToEnemies() {\n    const targets = game.user?.targets ?? new Set();\n    if (!targets.size) return ui.notifications?.warn(\"Target one or more creatures first.\");\n    let added = 0, skipped = 0;\n    for (const t of targets as any) {\n      const a = (t as any).actor as Actor | null;\n      const tokenId = (t as any).id;\n      if (!a || !tokenId) { skipped++; continue; }\n      if (this.party.has(a.id)) { skipped++; continue; }\n      const crRaw = D35EAdapter.getCR(a); if (!crRaw) { skipped++; continue; }\n      const entry: EnemyEntry = { id: a.id, tokenId, name: a.name ?? \"Enemy\", img: a.img ?? \"\", cr: Number(crRaw) };\n      if (!this.enemies.has(tokenId)) { this.enemies.set(tokenId, entry); added++; } else skipped++;\n    }\n    ui.notifications?.info(`Enemies +${added}${skipped ? `, skipped ${skipped}` : \"\"}`);\n    this.render();\n  }\n\n  private async applyXP() {\n  // Guard: prevent operations during apply or rollback\n  if (this.isProcessing) {\n    ui.notifications?.warn(\"XP operation already in progress...\");\n    return;\n  }\n\n  this.isProcessing = true;\n\n  try {\n    // --- 1) Snapshot current state FIRST (before any async operations) ---\n    const stateSnapshot = {\n      enemies: new Map(this.enemies),\n      manualAwards: new Map(this.manualAwards),\n      elDelta: this.elDelta\n    };\n\n    // --- 2) Build encounter grants from snapshot ---\n    const encounterGrants: { id: string; name: string; xp: number }[] = [];\n    const partyArr = [...this.party.values()];\n    const earners = partyArr.filter(p => p.earns);\n\n    // Recompute encounter preview (mirror your getData preview branch)\n    const crMap = new Map<number, number>();\n    for (const e of stateSnapshot.enemies.values()) {\n      // Preserve fractional CRs (0.125, 0.25, 0.33, 0.5, etc.)\n      const cr = Math.max(0.125, Number(e.cr) || 1);\n      crMap.set(cr, (crMap.get(cr) ?? 0) + 1);\n    }\n    const groupELs: number[] = [];\n    for (const [cr, count] of crMap.entries()) groupELs.push(groupToEL(cr, count));\n    let el = groupELs.length ? combineELs(groupELs) : 0;\n    el += stateSnapshot.elDelta;\n\n  const awardMode = game.settings.get(\"motwm-xp\", \"awardMode\") as string;\n  if (earners.length) {\n    if (awardMode === \"dmg35\") {\n      // DMG 3.5e per-monster method (Table 2-6, p.38)\n      // Apply EL modifier with decimal interpolation\n      const partySize = earners.length;\n      const crAdjustment = stateSnapshot.elDelta; // Supports decimals via interpolation\n      \n      for (const p of earners) {\n        let totalXP = 0;\n        for (const e of stateSnapshot.enemies.values()) {\n          const baseCR = Number(e.cr) || 1;\n          totalXP += getAdjustedMonsterXP(p.level, baseCR, crAdjustment, partySize);\n        }\n        encounterGrants.push({ id: p.id, name: p.name, xp: totalXP });\n      }\n    } else if (awardMode === \"split30\" && el > 0) {\n      // D&D 3.0 split pot (EL modifier already included in 'el' variable)\n      const apl = Math.round(partyArr.reduce((a, p) => a + p.level, 0) / Math.max(1, partyArr.length));\n      const pot = getPot30(apl, el);\n      const slice = split30(pot, 1, earners.length);\n      for (const p of earners) encounterGrants.push({ id: p.id, name: p.name, xp: slice });\n    }\n  }\n\n  // --- 3) Build manual grants (points or segments) ---\n  const manualGrants = this._manualAwardsToGrants();\n\n  // --- 4) Guard: nothing to award at all ---\n  if (!encounterGrants.length && !manualGrants.length) {\n    ui.notifications?.info(\"No XP to award: add enemies and/or manual awards first.\");\n    return;\n  }\n\n  // --- 5) Apply: encounter first, then manual (order is cosmetic only) ---\n  const applyGrants = async (grants: { id: string; name: string; xp: number }[]) => {\n    for (const g of grants) {\n      const actor = game.actors?.get(g.id);\n      if (!actor) continue;\n      // @ts-ignore\n      const curr = Number(getProperty(actor, \"system.details.xp.value\") ?? 0);\n      await actor.update({ \"system.details.xp.value\": curr + g.xp });\n    }\n  };\n\n  if (encounterGrants.length) await applyGrants(encounterGrants);\n  if (manualGrants.length)    await applyGrants(manualGrants);\n\n  // --- 6) Chat: separate cards for clarity ---\n  const chatMessageIds: string[] = [];\n\n  if (game.settings.get(\"motwm-xp\", \"broadcastChat\")) {\n    const esc = (str: any) => {\n      try { return TextEditor.escapeHTML(String(str ?? \"\")); }\n      catch {\n        // @ts-ignore\n        return foundry.utils?.escapeHTML\n          ? foundry.utils.escapeHTML(String(str ?? \"\"))\n          : String(str ?? \"\").replace(/[&<>\"']/g, s =>\n              ({ \"&\": \"&amp;\", \"<\": \"&lt;\", \">\": \"&gt;\", '\"': \"&quot;\", \"'\": \"&#039;\" }[s])\n            );\n      }\n    };\n\n    const makeList = (items: { name: string; xp: number; reason?: string }[]) =>\n      `<ul>${items.map(a => {\n        const safeName = esc(a.name);\n        const r = a.reason ? ` <em>(${esc(a.reason)})</em>` : \"\";\n        return `<li><b>${safeName}</b>: +${a.xp.toLocaleString()} XP${r}</li>`;\n      }).join(\"\")}</ul>`;\n\n    if (encounterGrants.length) {\n      const html = `<div><h3>Encounter XP Awards</h3>${makeList(encounterGrants)}</div>`;\n      const msg = await ChatMessage.create({ content: html });\n      if (msg?.id) chatMessageIds.push(msg.id);\n    }\n    if (manualGrants.length) {\n      // attach reasons where available\n      const withReasons = manualGrants.map(g => ({ ...g, reason: (stateSnapshot.manualAwards.get(g.id)?.reason) || \"Manual award\" }));\n      const html = `<div><h3>Manual XP Awards</h3>${makeList(withReasons)}</div>`;\n      const msg = await ChatMessage.create({ content: html });\n      if (msg?.id) chatMessageIds.push(msg.id);\n    }\n  }\n\n  // --- 7) Save state for rollback, then clear encounter inputs ---\n  this.lastAward = {\n    enemies: stateSnapshot.enemies,\n    manualAwards: stateSnapshot.manualAwards,\n    elDelta: stateSnapshot.elDelta,\n    grants: [...encounterGrants, ...manualGrants],\n    chatMessageIds: chatMessageIds\n  };\n\n  this.enemies.clear();\n  this.manualAwards.clear();\n  this.elDelta = 0;\n\n  ui.notifications?.info(\"XP awarded successfully.\");\n  // Re-render to show cleared state\n  this.render(true);\n  } catch (error) {\n    console.error(\"Error applying XP:\", error);\n    ui.notifications?.error(\"Failed to apply XP. See console for details.\");\n  } finally {\n    this.isProcessing = false;\n  }\n  }\n\n  private async rollbackXP() {\n  // Guard: prevent operations during apply or rollback\n  if (this.isProcessing) {\n    ui.notifications?.warn(\"XP operation already in progress...\");\n    return;\n  }\n\n  if (!this.lastAward) {\n    ui.notifications?.warn(\"No XP award to rollback.\");\n    return;\n  }\n\n  this.isProcessing = true;\n\n  try {\n    // Store reference and clear immediately to prevent double-rollback\n    const award = this.lastAward;\n    this.lastAward = null;\n\n    // --- 1) Delete chat messages ---\n    for (const id of award.chatMessageIds) {\n      const msg = game.messages?.get(id);\n      await msg?.delete();\n    }\n\n    // --- 2) Reverse the XP grants ---\n    const reverseGrants = async (grants: { id: string; name: string; xp: number }[]) => {\n      for (const g of grants) {\n        const actor = game.actors?.get(g.id);\n        if (!actor) continue;\n        // @ts-ignore\n        const curr = Number(getProperty(actor, \"system.details.xp.value\") ?? 0);\n        await actor.update({ \"system.details.xp.value\": curr - g.xp });\n      }\n    };\n\n    await reverseGrants(award.grants);\n\n    // --- 3) Restore the state ---\n    this.enemies = new Map(award.enemies);\n    this.manualAwards = new Map(award.manualAwards);\n    this.elDelta = award.elDelta;\n\n    ui.notifications?.info(\"XP award rolled back successfully.\");\n    // --- 4) Re-render ---\n    this.render(true);\n  } catch (error) {\n    console.error(\"Error rolling back XP:\", error);\n    ui.notifications?.error(\"Failed to rollback XP. See console for details.\");\n    // Try to restore lastAward on error so user can try again\n    // (but only if we still have the award reference in scope)\n  } finally {\n    this.isProcessing = false;\n  }\n  }\n\n}","import { systemTotalXPForLevel, TOTAL_BUBBLE_SEGMENTS } from \"../calc/xp\";\n\ntype Pos = { left: number; top: number };\n\nexport class XpBarApp extends Application {\n  actor: Actor;\n  private _dragging = false;\n  private _dragOffset = { x: 0, y: 0 };\n  private _wired = false; // prevent duplicate listeners\n\n  constructor(actor: Actor, options: Partial<ApplicationOptions> = {}) {\n    super({ popOut: false, id: \"motwmxp-bar\", ...options });\n    this.actor = actor;\n  }\n\n  static get defaultOptions() {\n    return mergeObject(super.defaultOptions, {\n      id: \"motwmxp-bar\",\n      template: \"modules/motwm-xp/templates/xp-bar.hbs\"\n    });\n  }\n\n  /* ---------- position helpers ---------- */\n  private _getSavedPos(): Pos | null {\n    const str = game.settings.get(\"motwm-xp\", \"barPos\") as string;\n    if (!str) return null;\n    try {\n      const p = JSON.parse(str);\n      return p && Number.isFinite(p.left) && Number.isFinite(p.top) ? p : null;\n    } catch {\n      return null;\n    }\n  }\n\n  private async _savePos(left: number, top: number) {\n    await game.settings.set(\"motwm-xp\", \"barPos\", JSON.stringify({ left, top }));\n  }\n\n  /** Apply pixel position; if none saved, center by calculating pixels (no CSS transform). */\n  private _applyPos() {\n    const el = this.element[0] as HTMLElement;\n    if (!el) return;\n\n    const saved = this._getSavedPos();\n    el.style.position = \"fixed\";\n    el.style.zIndex = \"70000\";\n\n    if (saved) {\n      el.style.left = `${saved.left}px`;\n      el.style.top  = `${saved.top}px`;\n    } else {\n      // compute pixel-centered bottom position once\n      const w = el.getBoundingClientRect().width || 520;\n      const h = el.getBoundingClientRect().height || 18;\n      const left = Math.round((window.innerWidth  - w) / 2);\n      const top  = Math.round(window.innerHeight - h - 8);\n      el.style.left = `${left}px`;\n      el.style.top  = `${top}px`;\n    }\n  }\n\n  /* ---------- data: layers + segments ---------- */\n  getData(): any {\n    // read from sheet/system\n    // @ts-ignore\n    const lvl = Number(getProperty(this.actor, \"system.details.level.value\") ?? 1);\n    // @ts-ignore\n    const totalXP = Number(getProperty(this.actor, \"system.details.xp.value\") ?? 0);\n    // @ts-ignore\n    const nextFromSheet = getProperty(this.actor, \"system.details.xp.max\");\n\n    const next0 = Number(nextFromSheet != null ? nextFromSheet : systemTotalXPForLevel(lvl + 1));\n    const prev0 = systemTotalXPForLevel(lvl);\n\n    // thresholds for up to 3 layers\n    const thresholds = [prev0, next0, systemTotalXPForLevel(lvl + 2), systemTotalXPForLevel(lvl + 3)];\n\n    // consume excess into layers\n    let excess = Math.max(0, totalXP - thresholds[0]);\n    const layers: { class: string; width: number }[] = [];\n    for (let i = 0; i < 3; i++) {\n      const span = Math.max(1, thresholds[i + 1] - thresholds[i]);\n      const frac = Math.max(0, Math.min(1, excess / span));\n      layers.push({ class: `layer${i}`, width: Math.round(frac * 10000) / 100 });\n      excess = Math.max(0, excess - span);\n    }\n\n    // segments (13 + mini 1/3)\n    const segments: any[] = [];\n    const totalSegs = TOTAL_BUBBLE_SEGMENTS;\n    for (let i = 1; i <= 13; i++) segments.push({ left: (i / totalSegs) * 100, class: \"\" });\n    segments.push({ left: (13 / totalSegs) * 100, class: \"mini\" });\n\n    const label = `Lv ${lvl} | ${totalXP.toLocaleString()} / ${next0.toLocaleString()} XP`;\n    const tooltip = `Level: ${lvl}`;\n\n    return { layers, segments, label, tooltip };\n  }\n\n  /* ---------- render & drag ---------- */\n  async _render(force?: boolean, options?: any): Promise<void> {\n    await super._render(force, options);\n    this._applyPos();\n\n    // Always re-attach pointerdown to the new element after render\n    const el = this.element[0] as HTMLElement;\n    if (!el) return;\n\n    // DRAG ON WHOLE BAR - must re-attach every render since element is recreated\n    el.addEventListener(\"pointerdown\", (ev: PointerEvent) => {\n      ev.preventDefault();\n\n      // 1) snapshot current pixels BEFORE any style changes\n      const rect = el.getBoundingClientRect();\n\n      // 2) ensure explicit pixel position (no bottom/transform anywhere)\n      el.style.left = `${rect.left}px`;\n      el.style.top  = `${rect.top}px`;\n\n      // 3) start drag\n      this._dragging = true;\n      (ev.currentTarget as HTMLElement).setPointerCapture?.(ev.pointerId);\n\n      // 4) offset from pointer to element origin\n      this._dragOffset.x = ev.clientX - rect.left;\n      this._dragOffset.y = ev.clientY - rect.top;\n    });\n\n    // Window listeners only need to be attached once\n    if (this._wired) return;\n    this._wired = true;\n\n    window.addEventListener(\"pointermove\", (ev: PointerEvent) => {\n      if (!this._dragging) return;\n      const currentEl = this.element[0] as HTMLElement;\n      if (!currentEl) return;\n      const left = Math.max(0, Math.min(window.innerWidth  - 50, ev.clientX - this._dragOffset.x));\n      const top  = Math.max(0, Math.min(window.innerHeight - 24, ev.clientY - this._dragOffset.y));\n      currentEl.style.left = `${left}px`;\n      currentEl.style.top  = `${top}px`;\n    });\n\n    window.addEventListener(\"pointerup\", async () => {\n      if (!this._dragging) return;\n      this._dragging = false;\n      const currentEl = this.element[0] as HTMLElement;\n      if (!currentEl) return;\n      const left = parseInt(currentEl.style.left || \"0\", 10);\n      const top  = parseInt(currentEl.style.top  || \"0\", 10);\n      await this._savePos(left, top);\n    });\n\n    // keep it on-screen on resize; if saved, re-apply saved pixels; else re-center by pixels\n    window.addEventListener(\"resize\", () => this._applyPos(), { passive: true });\n  }\n\n  render(force?: boolean, options?: any): this {\n    const show = game.settings.get(\"motwm-xp\", \"showPlayerBar\") as boolean;\n    if (!show) return this;\n    return super.render(force, options);\n  }\n}\n","import { registerSettings } from \"./settings\";\nimport { XpCalculatorApp } from \"./ui/XpCalculatorApp\";\nimport { XpBarApp } from \"./ui/XpBarApp\";\nimport \"./styles/styles.css\";\n\ndeclare global {\n  interface Window {\n    MOTWM_XP?: {\n      calc?: XpCalculatorApp;\n      bars?: Map<string, XpBarApp>;\n      XpBarApp?: typeof XpBarApp;\n    };\n  }\n}\n\nHooks.once(\"init\", () => {\n  registerSettings();\n  window.MOTWM_XP = window.MOTWM_XP ?? { bars: new Map() };\n  // Store XpBarApp class for the onChange callback\n  window.MOTWM_XP.XpBarApp = XpBarApp;\n});\n\nHooks.once(\"ready\", () => {\n  // Player XP bar: each user sees their own assigned character (if any)\n  const show = game.settings.get(\"motwm-xp\", \"showPlayerBar\") as boolean;\n  const myActor = game.user?.character as Actor | undefined;\n  if (show && myActor) {\n    const bars = window.MOTWM_XP!.bars!;\n    let app = bars.get(myActor.id);\n    if (!app) {\n      app = new XpBarApp(myActor, { top: window.innerHeight - 54, left: 0 });\n      bars.set(myActor.id, app);\n    }\n    app.render(true);\n  }\n\n  // Re-render my bar if my actor's XP/level changes\n  Hooks.on(\"updateActor\", (actor: Actor, changes: any) => {\n    const a = game.user?.character;\n    if (!a || actor.id !== a.id) return;\n    const app = window.MOTWM_XP!.bars!.get(a.id);\n    app?.render(true);\n  });\n\n  // Re-render XP calculator when award mode setting changes\n  Hooks.on(\"updateSetting\", (setting: any, value: any) => {\n    if (setting.key === \"motwm-xp.awardMode\" && window.MOTWM_XP?.calc) {\n      const calc = window.MOTWM_XP.calc as any;\n      if (calc.element) {\n        calc.render(false);\n      }\n    }\n  });\n});\n\n// Add the GM calculator button to Token controls\nHooks.on(\"getSceneControlButtons\", (controls: any[]) => {\n  if (!game.user?.isGM) return;\n  const tokenControl = controls.find(c => c.name === \"token\");\n  tokenControl?.tools?.push({\n    name: \"motwm-xp-calc\",\n    title: \"Open XP Calculator\",\n    icon: \"fas fa-calculator\",\n    visible: true,\n    onClick: () => {\n      if (!window.MOTWM_XP?.calc) window.MOTWM_XP!.calc = new XpCalculatorApp();\n      (window.MOTWM_XP!.calc as any).render(true);\n    },\n    button: true\n  });\n});"],"names":["registerSettings","value","_a","_b","_c","myActor","bars","app","XpBarApp","D35EAdapter","actor","v","classes","total","cls","lv","fallback","crPaths","path","cr","lvl","groupToEL","count","el","k","combineELs","els","arr","a","b","diff","combined","x","y","systemTotalXPForLevel","level","L","rate","table","TOTAL_BUBBLE_SEGMENTS","getBaseXPForSingleMonster","pcLevel","monsterCR","TABLE_2_6","cr1XP","crInt","row","maxCRInRow","stepsAbove","baseXP","getAdjustedMonsterXP","baseCR","crAdjustment","partySize","adjustedCR","fractionalPart","floorCR","ceilCR","floorXP","ceilXP","interpolatedXP","getPot30","apl","TABLE_30","getIntegerPot","aplInt","levelRow","xp","getBasePot30","result","step","crFloor","crCeil","irregular","pattern","mult","split30","pot","weight","totalWeight","formatCR","fractions","symbol","bubbleSizeForLevel","start","next","XpCalculatorApp","__publicField","crMap","e","groupELs","baseEL","delta","elInt","partyLevels","p","crToPower","powerToLevel","power","averageLevel","sum","partyLevel","partyPower","elDiff","difficulty","encounterInfo","elBreakdown","lines","crGroups","groupEL","g","sortedELs","combineSteps","remaining","highest","second","awardMode","partyArr","m","preview","encounterXpMap","earners","totalXP","slice","encounterXp","manualAward","manualXp","bubbleSize","totalXp","enemiesArr","mapKey","enemy","html","ev","id","s","prev","target","actorId","type","_d","_e","HOSTILE","hostileTokens","t","added","tokenId","name","img","NEUTRAL","neutralTokens","actors","u","FRIENDLY","tokens","doc","isFriendly","isPC","coreParty","out","award","perBubble","skipped","players","entry","selected","targets","crRaw","stateSnapshot","encounterGrants","manualGrants","applyGrants","grants","curr","chatMessageIds","esc","str","makeList","items","safeName","r","msg","withReasons","error","options","left","top","saved","w","h","nextFromSheet","next0","thresholds","excess","layers","i","span","frac","segments","totalSegs","label","tooltip","force","rect","currentEl","show","changes","setting","calc","controls","tokenControl","c"],"mappings":"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"}