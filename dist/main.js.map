{"version":3,"file":"main.js","sources":["../src/settings.ts","../src/d35e-adapter.ts","../src/calc/el.ts","../src/calc/xp.ts","../src/ui/XpCalculatorApp.ts","../src/ui/XpBarApp.ts","../src/main.ts"],"sourcesContent":["export function registerSettings() {\r\n  // Chat toggle\r\n  game.settings.register(\"motwm-xp\", \"broadcastChat\", {\r\n    name: \"Broadcast XP to Chat\",\r\n    scope: \"world\",\r\n    config: true,\r\n    type: Boolean,\r\n    default: false\r\n  });\r\n\r\n  // Player XP bar visible\r\n  game.settings.register(\"motwm-xp\", \"showPlayerBar\", {\r\n    name: \"Show Player XP Bar\",\r\n    scope: \"client\",\r\n    config: true,\r\n    type: Boolean,\r\n    default: true\r\n  });\r\n\r\n  // Player XP bar position (hidden, per-client)\r\n  game.settings.register(\"motwm-xp\", \"barPos\", {\r\n    name: \"XP Bar Position\",\r\n    scope: \"client\",\r\n    config: false,\r\n    type: String,\r\n    default: \"\"\r\n  });\r\n\r\n  // Calculator award mode (the calculator reads this)\r\n  game.settings.register(\"motwm-xp\", \"awardMode\", {\r\n    name: \"XP Award Method\",\r\n    hint: \"RAW 3.5e = per-PC (Level vs EL). Classic 3.0 = split single pot based on APL.\",\r\n    scope: \"world\",\r\n    config: true,\r\n    type: String,\r\n    choices: {\r\n      raw35: \"D&D 3.5e (per-PC)\",\r\n      split30: \"D&D 3.0 (split pot)\"\r\n    },\r\n    default: \"raw35\"\r\n  });\r\n}\r\n","export class D35EAdapter {\r\n  static getXP(actor: Actor): number {\r\n    // @ts-ignore\r\n    const v = getProperty(actor, \"system.details.xp.value\");\r\n    return Number(v ?? 0);\r\n  }\r\n  static async setXP(actor: Actor, value: number) {\r\n    return actor.update({ \"system.details.xp.value\": Number(value) });\r\n  }\r\n  static getLevel(actor: Actor): number {\r\n    // Prefer summed classes for characters\r\n    // @ts-ignore\r\n    const classes = getProperty(actor, \"system.classes\");\r\n    if (classes && typeof classes === \"object\") {\r\n      let total = 0;\r\n      for (const cls of Object.values(classes) as any[]) {\r\n        const lv = Number(getProperty(cls, \"level\") ?? 0);\r\n        total += lv;\r\n      }\r\n      if (total > 0) return total;\r\n    }\r\n    // Fallback (NPCs/monsters often have this)\r\n    // @ts-ignore\r\n    const fallback = getProperty(actor, \"system.details.level.value\");\r\n    return Number(fallback ?? 0);\r\n  }\r\n  static getCR(actor: Actor): number | null {\r\n    // D35E system stores CR in different ways:\r\n    // - system.details.totalCr = adjusted CR with templates (PRIORITY!)\r\n    // - system.details.cr = base CR without templates\r\n    const crPaths = [\r\n      \"system.details.totalCr\",     // D35E: adjusted CR (includes templates!) - CHECK THIS FIRST\r\n      \"system.details.cr.total\",    // alternative adjusted CR format\r\n      \"system.attributes.cr.total\", // yet another alternative\r\n      \"system.details.cr.value\",    // structured base CR\r\n      \"system.details.cr\",          // flat base CR number\r\n      \"data.details.totalCr\",       // legacy adjusted\r\n      \"data.details.cr.total\",      // legacy adjusted\r\n      \"data.details.cr.value\",      // legacy base CR\r\n      \"data.details.cr\"             // legacy flat number\r\n    ];\r\n    \r\n    for (const path of crPaths) {\r\n      // @ts-ignore\r\n      const cr = getProperty(actor, path);\r\n      if (cr != null && Number.isFinite(Number(cr))) return Number(cr);\r\n    }\r\n    \r\n    // fallback: treat level as CR (PC-sheet BBEG)\r\n    const lvl = this.getLevel(actor);\r\n    return lvl ? Number(lvl) : null;\r\n  }\r\n}\r\n","/** EL engine: combine same-CR (+2 per doubling), mixed-EL pairwise */\r\nexport function groupToEL(cr: number, count: number): number {\r\n  if (count <= 0) return -Infinity;\r\n  let el = cr;\r\n  let k = count;\r\n  while (k >= 2) {\r\n    el += 2;\r\n    k = Math.floor(k / 2);\r\n  }\r\n  return el;\r\n}\r\n\r\nexport function combineELs(els: number[]): number {\r\n  if (!els.length) return -Infinity;\r\n  let arr = els.slice().sort((a,b)=>a-b);\r\n  while (arr.length > 1) {\r\n    const a = arr.pop()!; // largest\r\n    const b = arr.pop()!; // second largest\r\n    const diff = Math.abs(a-b);\r\n    let combined = a;\r\n    if (diff === 0) combined = a + 2;\r\n    else if (diff === 1 || diff === 2) combined = a + 1;\r\n    else combined = a; // smaller negligible\r\n    arr.push(combined);\r\n    arr.sort((x,y)=>x-y);\r\n  }\r\n  return arr[0];\r\n}\r\n","/** ===== D35E progression helpers (single source of truth) ===== */\r\n\r\nexport function systemTotalXPForLevel(level: number): number {\r\n  const L = Math.max(1, Math.floor(level));\r\n  const rate = game.settings.get(\"D35E\", \"experienceRate\") as string; // \"fast\" | \"medium\" | \"slow\" (or others)\r\n  const table = (CONFIG as any)?.D35E?.CHARACTER_EXP_LEVELS?.[rate];\r\n  if (Array.isArray(table)) {\r\n    return Number(table[Math.min(L - 1, table.length - 1)] ?? 0);\r\n  }\r\n  // ultra-safe fallback: 3.5e classic quadratic\r\n  return Math.floor(1000 * ((L - 1) * L) / 2);\r\n}\r\n\r\n/** Total number of bubble segments in the XP bar UI */\r\nexport const TOTAL_BUBBLE_SEGMENTS = 13 + 1/3;\r\n\r\n/** ===== Award methods (we'll wire exact tables shortly) ===== */\r\n\r\n/** \r\n * RAW 3.5e per-PC award: PC Level vs Encounter Level\r\n * Based on the official d20srd.org encounter calculator\r\n * (https://www.d20srd.org/extras/d20encountercalculator/)\r\n * \r\n * This matches the community-standard calculator which uses the DMG formulas\r\n * with special case adjustments for specific level/EL combinations.\r\n * \r\n * Key rules:\r\n * - Encounters 8+ levels below party: 0 XP (too trivial)\r\n * - Encounters 8+ levels above party: 0 XP (too dangerous)\r\n * - Low level PCs (1-3) have special handling\r\n * - Specific adjustments for even/odd ELs at certain PC levels\r\n */\r\nexport function awardRaw35(pcLevel: number, encounterLevel: number): number {\r\n  let x = pcLevel;\r\n  let y = encounterLevel;\r\n  \r\n  // Invalid inputs\r\n  if (x <= 0 || y <= 0) return 0;\r\n  \r\n  let iReturn = 0;\r\n  \r\n  // Clamp low-level PCs to level 3 for calculation purposes\r\n  if (x < 3) x = 3;\r\n  \r\n  // Special case for very low level encounters (including fractional CRs)\r\n  // For fractional CRs (0.125, 0.25, 0.33, 0.5), use proportional XP\r\n  if ((x <= 6) && (y <= 1)) {\r\n    iReturn = 300 * y;\r\n  } else if (y < 1) {\r\n    // Fractional EL for higher-level PCs: scale from base 300\r\n    iReturn = 300 * y;\r\n  } else {\r\n    // General formula for 3.5 (attempts to follow DMG pattern)\r\n    // This is a best-fit formula that gets corrected by special cases below\r\n    const mEven = (val: number): number => {\r\n      let result = 2 * Math.floor(val / 2);\r\n      if (val < result) result += -2;\r\n      else if (val > result) result += 2;\r\n      return result;\r\n    };\r\n    \r\n    iReturn = 6.25 * x * Math.pow(2, mEven(7 - (x - y)) / 2) * (11 - (x - y) - mEven(7 - (x - y)));\r\n  }\r\n  \r\n  // Special corrections for even ELs (4, 6, 8, 10, 12, 14, 16, 18, 20)\r\n  // These override the general formula for specific PC level ranges\r\n  if ([4, 6, 8, 10, 12, 14, 16, 18, 20].includes(y)) {\r\n    if (x <= 3) {\r\n      iReturn = 1350 * Math.pow(2, (y - 4) / 2);\r\n    } else if (x === 5 && y >= 6) {\r\n      iReturn = 2250 * Math.pow(2, (y - 6) / 2);\r\n    } else if (x === 7 && y >= 8) {\r\n      iReturn = 3150 * Math.pow(2, (y - 8) / 2);\r\n    } else if (x === 9 && y >= 10) {\r\n      iReturn = 4050 * Math.pow(2, (y - 10) / 2);\r\n    } else if (x === 11 && y >= 12) {\r\n      iReturn = 4950 * Math.pow(2, (y - 12) / 2);\r\n    } else if (x === 13 && y >= 14) {\r\n      iReturn = 5850 * Math.pow(2, (y - 14) / 2);\r\n    } else if (x === 15 && y >= 16) {\r\n      iReturn = 6750 * Math.pow(2, (y - 16) / 2);\r\n    } else if (x === 17 && y >= 18) {\r\n      iReturn = 7650 * Math.pow(2, (y - 18) / 2);\r\n    } else if (x === 19 && y >= 20) {\r\n      iReturn = 8550 * Math.pow(2, (y - 20) / 2);\r\n    }\r\n  }\r\n  \r\n  // Special corrections for odd ELs (7, 9, 11, 13, 15, 17, 19)\r\n  // These also override the general formula for specific PC level ranges\r\n  if ([7, 9, 11, 13, 15, 17, 19].includes(y)) {\r\n    if (x === 6) {\r\n      iReturn = 2700 * Math.pow(2, (y - 7) / 2);\r\n    }\r\n    if (x === 8 && y >= 9) {\r\n      iReturn = 3600 * Math.pow(2, (y - 9) / 2);\r\n    }\r\n    if (x === 10 && y >= 11) {\r\n      iReturn = 4500 * Math.pow(2, (y - 11) / 2);\r\n    }\r\n    if (x === 12 && y >= 13) {\r\n      iReturn = 5400 * Math.pow(2, (y - 13) / 2);\r\n    }\r\n    if (x === 14 && y >= 15) {\r\n      iReturn = 6300 * Math.pow(2, (y - 15) / 2);\r\n    }\r\n    if (x === 16 && y >= 17) {\r\n      iReturn = 7200 * Math.pow(2, (y - 17) / 2);\r\n    }\r\n    if (x === 18 && y >= 19) {\r\n      iReturn = 8100 * Math.pow(2, (y - 19) / 2);\r\n    }\r\n  }\r\n  \r\n  // Recursively handle very high ELs (above 20)\r\n  if (y > 20) {\r\n    iReturn = 2 * awardRaw35(x, y - 2);\r\n  }\r\n  \r\n  // Final bounds checks: no XP for encounters too far from party level\r\n  // More than 7 levels below: too trivial\r\n  if (x - y > 7) iReturn = 0;\r\n  // More than 7 levels above: too dangerous (party likely TPK'd)\r\n  else if (y - x > 7) iReturn = 0;\r\n  \r\n  return Math.round(iReturn);\r\n}\r\n\r\n/** \r\n * D&D 3.0 XP Table: Returns the total party XP pot for a given APL and CR\r\n */\r\nexport function getPot30(apl: number, cr: number): number {\r\n  const TABLE_30: Record<number, Record<number, number>> = {\r\n    1:  { 1:300, 2:600, 3:900, 4:1350, 5:1800, 6:2700, 7:3600, 8:5400, 9:7200, 10:10800 },\r\n    2:  { 1:300, 2:600, 3:900, 4:1350, 5:1800, 6:2700, 7:3600, 8:5400, 9:7200, 10:10800 },\r\n    3:  { 1:300, 2:600, 3:900, 4:1350, 5:1800, 6:2700, 7:3600, 8:5400, 9:7200, 10:10800 },\r\n    4:  { 1:300, 2:600, 3:800, 4:1200, 5:1600, 6:2400, 7:3200, 8:4800, 9:6400, 10:9600, 11:12800, 12:18000, 13:21600, 14:28800 },\r\n    5:  { 1:300, 2:500, 3:750, 4:1000, 5:1500, 6:2250, 7:3000, 8:4500, 9:6000, 10:9000, 11:12000, 12:18000, 13:21600, 14:28800, 15:28800 },\r\n    6:  { 1:300, 2:450, 3:600, 4:900, 5:1200, 6:1800, 7:2400, 8:3600, 9:4800, 10:7200, 11:10800, 12:14400, 13:21600, 14:25200, 15:28800, 16:28800 },\r\n    7:  { 1:263, 2:394, 3:525, 4:700, 5:1050, 6:1400, 7:2100, 8:3150, 9:4200, 10:6300, 11:8400, 12:12600, 13:16800, 14:25200, 15:28800 },\r\n    8:  { 1:200, 2:300, 3:450, 4:600, 5:875, 6:1200, 7:1600, 8:2400, 9:3600, 10:4800, 11:6300, 12:8400, 13:12600, 14:16800, 15:25200, 16:28800 },\r\n    9:  { 1:0, 2:225, 3:338, 4:506, 5:675, 6:1013, 7:1350, 8:2025, 9:2700, 10:4050, 11:5400, 12:8100, 13:10800, 14:16200, 15:21600, 16:32400, 17:36000, 18:39600 },\r\n    10: { 3:250, 4:375, 5:563, 6:750, 7:1000, 8:1500, 9:2000, 10:3000, 11:3600, 12:4800, 13:6400, 14:9600 },\r\n    11: { 4:275, 5:413, 6:619, 7:825, 8:1238, 9:1650, 10:2475, 11:3300, 12:4950, 13:6600, 14:9900, 15:13200, 16:17600, 17:26400, 18:39600 },\r\n    12: { 5:300, 6:450, 7:675, 8:900, 9:1350, 10:1800, 11:1950, 12:2600, 13:3900, 14:5850, 15:7800, 16:11700, 17:15600, 18:23400, 19:31200, 20:46800 },\r\n    13: { 6:325, 7:488, 8:731, 9:975, 10:1463, 11:1400, 12:2100, 13:2800, 14:4200, 15:6300, 16:8400, 17:12600, 18:18900, 19:25200, 20:33600 },\r\n    14: { 6:350, 7:525, 8:788, 9:1050, 10:1575, 11:900, 12:1200, 13:1800, 14:2400, 15:4200, 16:4800, 17:7200, 18:10800, 19:13500, 20:18900 },\r\n    15: { 7:375, 8:563, 9:844, 10:1125, 11:638, 12:850, 13:1275, 14:1900, 15:2500, 16:4800, 17:7200, 18:10800, 19:13500, 20:18900 },\r\n    16: { 7:400, 8:600, 9:900, 10:1350, 11:900, 12:1200, 13:1800, 14:2400, 15:3200, 16:4800, 17:7200, 18:10800, 19:14400, 20:19200 },\r\n    17: { 8:425, 9:638, 10:956, 11:900, 12:1200, 13:1800, 14:2400, 15:3200, 16:4800, 17:7200, 18:10800, 19:14400, 20:19200 },\r\n    18: { 8:450, 9:675, 10:1013, 11:638, 12:850, 13:1275, 14:1900, 15:2500, 16:4800, 17:7200, 18:10800, 19:14400, 20:19200 },\r\n    19: { 9:475, 10:713, 11:638, 12:850, 13:1275, 14:1900, 15:2500, 16:4800, 17:7200, 18:10800, 19:14400, 20:19200 },\r\n    20: { 10:750, 11:900, 12:1200, 13:1800, 14:2400, 15:3200, 16:4800, 17:7200, 18:10800, 19:14400, 20:19200 },\r\n    21: { 11:1125, 12:1350, 13:1800, 14:2700, 15:3600, 16:4800, 17:7200, 18:10800, 19:14400, 20:21600, 21:28800, 22:43200, 23:57600, 24:76800 },\r\n    22: { 12:1688, 13:2025, 14:2700, 15:4050, 16:5400, 17:7200, 18:10800, 19:16200, 20:21600, 21:32400, 22:43200, 23:64800, 24:86400, 25:115200 },\r\n    23: { 13:2250, 14:2700, 15:3600, 16:5400, 17:7200, 18:9600, 19:14400, 20:21600, 21:28800, 22:43200, 23:57600, 24:86400, 25:115200, 26:153600 },\r\n    24: { 14:3000, 15:3600, 16:4800, 17:7200, 18:9600, 19:12800, 20:19200, 21:28800, 22:38400, 23:57600, 24:76800, 25:115200, 26:153600, 27:204800 },\r\n    25: { 15:4500, 16:5400, 17:7200, 18:10800, 19:14400, 20:19200, 21:28800, 22:43200, 23:57600, 24:86400, 25:115200, 26:172800, 27:230400, 28:307200 },\r\n    26: { 16:6750, 17:8100, 18:10800, 19:16200, 20:21600, 21:28800, 22:43200, 23:64800, 24:86400, 25:129600, 26:172800, 27:259200, 28:345600, 29:460800 },\r\n    27: { 17:9000, 18:10800, 19:14400, 20:21600, 21:28800, 22:38400, 23:57600, 24:86400, 25:115200, 26:172800, 27:230400, 28:345600, 29:460800, 30:614400 },\r\n    28: { 18:12000, 19:14400, 20:19200, 21:28800, 22:38400, 23:51200, 24:76800, 25:115200, 26:153600, 27:230400, 28:307200, 29:460800, 30:614400, 31:819200 },\r\n    29: { 19:18000, 20:21600, 21:28800, 22:43200, 23:57600, 24:76800, 25:115200, 26:172800, 27:230400, 28:345600, 29:460800, 30:691200, 31:921600, 32:1228800 },\r\n    30: { 20:27000, 21:32400, 22:43200, 23:64800, 24:86400, 25:115200, 26:172800, 27:259200, 28:345600, 29:518400, 30:691200, 31:1036800, 32:1382400, 33:1843200 },\r\n    31: { 21:36000, 22:43200, 23:57600, 24:86400, 25:115200, 26:153600, 27:230400, 28:345600, 29:460800, 30:691200, 31:921600, 32:1382400, 33:1843200, 34:2457600 },\r\n    32: { 22:48000, 23:57600, 24:76800, 25:115200, 26:153600, 27:204800, 28:307200, 29:460800, 30:614400, 31:921600, 32:1228800, 33:1843200, 34:2457600, 35:3276800 },\r\n    33: { 23:72000, 24:86400, 25:115200, 26:172800, 27:230400, 28:307200, 29:460800, 30:691200, 31:921600, 32:1382400, 33:1843200, 34:2764800, 35:3686400, 36:4915200 },\r\n    34: { 24:108000, 25:129600, 26:172800, 27:259200, 28:345600, 29:460800, 30:691200, 31:1036800, 32:1382400, 33:2073600, 34:2764800, 35:4147200, 36:5529600, 37:7372800 },\r\n    35: { 25:144000, 26:172800, 27:230400, 28:345600, 29:460800, 30:614400, 31:921600, 32:1382400, 33:1843200, 34:2764800, 35:3686400, 36:5529600, 37:7372800, 38:9830400 },\r\n    36: { 26:192000, 27:230400, 28:307200, 29:460800, 30:614400, 31:819200, 32:1228800, 33:1843200, 34:2457600, 35:3686400, 36:4915200, 37:7372800, 38:9830400, 39:13107200 },\r\n    37: { 27:288000, 28:345600, 29:460800, 30:691200, 31:921600, 32:1228800, 33:1843200, 34:2764800, 35:3686400, 36:5529600, 37:7372800, 38:11059200, 39:14745600, 40:19660800 },\r\n    38: { 28:432000, 29:518400, 30:691200, 31:1036800, 32:1382400, 33:1843200, 34:2764800, 35:4147200, 36:5529600, 37:8294400, 38:11059200, 39:16588800, 40:22118400 },\r\n    39: { 29:576000, 30:691200, 31:921600, 32:1382400, 33:1843200, 34:2457600, 35:3686400, 36:5529600, 37:7372800, 38:11059200, 39:14745600, 40:22118400 },\r\n    40: { 30:768000, 31:921600, 32:1228800, 33:1843200, 34:2457600, 35:3276800, 36:4915200, 37:7372800, 38:9830400, 39:14745600, 40:19660800 }\r\n  };\r\n\r\n  const aplInt = Math.max(1, Math.min(40, Math.floor(apl)));\r\n  const crInt = Math.max(1, Math.floor(cr));\r\n  \r\n  // Look up the value in the table\r\n  const levelRow = TABLE_30[aplInt];\r\n  if (!levelRow) return 0;\r\n  \r\n  const xp = levelRow[crInt];\r\n  if (xp !== undefined) return xp;\r\n  \r\n  // If CR not in table, use the baseline for that APL and apply the standard scaling\r\n  const baseXP = getBasePot30(aplInt);\r\n  const diff = crInt - aplInt;\r\n  \r\n  // Apply the alternating ×3/2, ×4/3 pattern for higher CRs\r\n  // Or ×2/3, ×3/4 pattern for lower CRs\r\n  let result = baseXP;\r\n  if (diff > 0) {\r\n    // Higher CR: alternating ×3/2 and ×4/3\r\n    for (let step = 0; step < diff; step++) {\r\n      result = Math.floor(result * (step % 2 === 0 ? 3/2 : 4/3));\r\n    }\r\n  } else if (diff < 0) {\r\n    // Lower CR: alternating ×2/3 and ×3/4\r\n    for (let step = 0; step < Math.abs(diff); step++) {\r\n      result = Math.floor(result * (step % 2 === 0 ? 2/3 : 3/4));\r\n    }\r\n  }\r\n  \r\n  return Math.max(0, result);\r\n}\r\n\r\n/** Helper: Get the baseline XP for a party level when CR = APL */\r\nfunction getBasePot30(apl: number): number {\r\n  // Levels 1-11: simple 300 × level\r\n  if (apl <= 11) return 300 * apl;\r\n  \r\n  // Irregular levels 12-15 (from actual table)\r\n  const irregular: Record<number, number> = { 12: 2600, 13: 2800, 14: 2400, 15: 2500 };\r\n  if (irregular[apl]) return irregular[apl];\r\n  \r\n  // Levels 16+: use the geometric progression pattern\r\n  // Starting from level 16 = 4800, apply ×1.5, ×1.5, ×4/3, ×4/3 pattern\r\n  let xp = 4800;\r\n  const pattern = [1.5, 1.5, 4/3, 4/3];\r\n  for (let level = 17; level <= apl; level++) {\r\n    const mult = pattern[(level - 17) % 4];\r\n    xp = Math.floor(xp * mult);\r\n  }\r\n  return xp;\r\n}\r\n\r\n/** Classic 3.0 Split: pass a total pot (you compute from APL vs EL) and return each share (weighted elsewhere) */\r\nexport function split30(pot: number, weight: number, totalWeight: number): number {\r\n  if (pot <= 0 || totalWeight <= 0) return 0;\r\n  return Math.round((pot * weight) / totalWeight);\r\n}\r\n","import { D35EAdapter } from \"../d35e-adapter\";\r\nimport { groupToEL, combineELs } from \"../calc/el\";\r\nimport { awardRaw35, split30, getPot30 } from \"../calc/xp\";\r\n\r\ntype ManualAward = {\r\n  amount: number;                    // user-entered value\r\n  unit: \"points\" | \"bubbles\";        // how to interpret amount\r\n  reason: string;                    // chat reason\r\n};\r\n\r\n/** Format CR with Unicode fraction characters for common fractional CRs */\r\nfunction formatCR(cr: number): string {\r\n  // Common D&D fractional CRs with Unicode fractions\r\n  const fractions: Record<number, string> = {\r\n    0.125: \"⅛\",\r\n    0.25: \"¼\",\r\n    0.33: \"⅓\",\r\n    0.333: \"⅓\",\r\n    0.5: \"½\",\r\n    0.66: \"⅔\",\r\n    0.667: \"⅔\",\r\n    0.75: \"¾\"\r\n  };\r\n  \r\n  // Check if it's a known fraction (with small tolerance for floating point)\r\n  for (const [value, symbol] of Object.entries(fractions)) {\r\n    if (Math.abs(cr - parseFloat(value)) < 0.01) {\r\n      return symbol;\r\n    }\r\n  }\r\n  \r\n  // For whole numbers, just return the number\r\n  if (Number.isInteger(cr)) return cr.toString();\r\n  \r\n  // For other decimals, format to 2 decimal places\r\n  return cr.toFixed(2);\r\n}\r\n\r\nfunction bubbleSizeForLevel(level: number): number {\r\n  // per-level span divided by 13⅓\r\n  const start = (window as any).CONFIG?.D35E\r\n    ? (CONFIG as any).D35E.CHARACTER_EXP_LEVELS[game.settings.get(\"D35E\",\"experienceRate\") as string][Math.max(0, level-1)]\r\n    : 0;\r\n  const next  = (window as any).CONFIG?.D35E\r\n    ? (CONFIG as any).D35E.CHARACTER_EXP_LEVELS[game.settings.get(\"D35E\",\"experienceRate\") as string][Math.max(0, level)]\r\n    : start + 1000; // harmless fallback\r\n  const span = Math.max(1, Number(next) - Number(start));\r\n  return span / (13 + 1/3);\r\n}\r\n\r\nfunction getModSetting<T = any>(key: string, fallback: T): T {\r\n  try { return game.settings.get(\"motwm-xp\", key) as T; }\r\n  catch { return fallback; }\r\n}\r\n\r\ntype PartyEntry = { id: string; name: string; img: string; level: number; earns: boolean; friend: boolean; };\r\ntype EnemyEntry = { id: string; tokenId?: string; name: string; img: string; cr: number; };\r\n\r\nexport class XpCalculatorApp extends Application {\r\n  private party: Map<string, PartyEntry> = new Map();\r\n  private enemies: Map<string, EnemyEntry> = new Map();\r\n  private manualAwards: Map<string, ManualAward> = new Map(); // key: actorId\r\n  private elDelta: number = 0;\r\n  private showElDetails: boolean = false;\r\n  private lastAward: {\r\n    enemies: Map<string, EnemyEntry>;\r\n    manualAwards: Map<string, ManualAward>;\r\n    elDelta: number;\r\n    grants: { id: string; name: string; xp: number }[];\r\n    chatMessageIds: string[];\r\n  } | null = null;\r\n\r\n  static get defaultOptions() {\r\n    return mergeObject(super.defaultOptions, {\r\n      id: \"motwmxp-calc\",\r\n      title: \"MOTWM XP Calculator\",\r\n      width: 960,\r\n      height: 660,\r\n      resizable: true,\r\n      template: \"modules/motwm-xp/templates/xp-calculator.hbs\"\r\n    });\r\n  }\r\n\r\n/* ---------- DATA ---------- */\r\ngetData(): any {\r\n  // Build EL from enemies (group by CR)\r\n  const crMap = new Map<number, number>();\r\n  for (const e of this.enemies.values()) {\r\n    // Preserve fractional CRs (0.125, 0.25, 0.33, 0.5, etc.)\r\n    const cr = Math.max(0.125, Number(e.cr) || 1);\r\n    crMap.set(cr, (crMap.get(cr) ?? 0) + 1);\r\n  }\r\n  const groupELs: number[] = [];\r\n  for (const [cr, count] of crMap.entries()) groupELs.push(groupToEL(cr, count));\r\n\r\n  // Integer-only EL (allow negative integer modifier)\r\n  const baseEL = groupELs.length ? combineELs(groupELs) : 0;\r\n  const delta = Number.isFinite(this.elDelta) ? Math.trunc(this.elDelta) : 0;\r\n  const elInt = baseEL + delta; // use this for UI and award math\r\n\r\n  // Calculate party level for encounter difficulty (d20srd.org method)\r\n  // Uses power-based formula: always divides by 4 (assumes 4-PC baseline)\r\n  const partyLevels = [...this.party.values()].map(p => p.level);\r\n  const partySize = partyLevels.length;\r\n  \r\n  // Helper: Convert CR/level to \"power\" (exponential scale)\r\n  const crToPower = (level: number): number => {\r\n    if (level < 2) return level;\r\n    return Math.pow(2, level / 2);\r\n  };\r\n  \r\n  // Helper: Convert power back to level\r\n  const powerToLevel = (power: number): number => {\r\n    if (power < 2) return power;\r\n    return 2 * Math.log2(power);\r\n  };\r\n  \r\n  // Calculate average level (for XP awards - not affected by party size)\r\n  const averageLevel = partyLevels.length > 0 \r\n    ? partyLevels.reduce((sum, lvl) => sum + lvl, 0) / partyLevels.length \r\n    : 0;\r\n  \r\n  // Calculate party level (for difficulty - affected by party size via ÷4 baseline)\r\n  let partyLevel = 0;\r\n  if (partyLevels.length > 0) {\r\n    const totalPower = partyLevels.reduce((sum, lvl) => sum + crToPower(lvl), 0);\r\n    // Official calculator always divides by 4 (hardcoded baseline for 4-person party)\r\n    const partyPower = totalPower / 4;\r\n    partyLevel = powerToLevel(partyPower);\r\n  }\r\n  \r\n  const elDiff = elInt - partyLevel;\r\n  \r\n  let difficulty = \"—\";\r\n  if (partyLevel > 0 && elInt > 0) {\r\n    if (elDiff < -9) difficulty = \"Trivial\";\r\n    else if (elDiff < -4) difficulty = \"Very Easy\";\r\n    else if (elDiff < 0) difficulty = \"Easy\";\r\n    else if (elDiff === 0) difficulty = \"Challenging\";\r\n    else if (elDiff <= 4) difficulty = \"Very Difficult\";\r\n    else if (elDiff <= 7) difficulty = \"Overpowering\";\r\n    else difficulty = \"Unbeatable\";\r\n  }\r\n  \r\n  const encounterInfo = partyLevel > 0 && elInt > 0 \r\n    ? `Party: ${partySize} PCs, Avg Lvl ${averageLevel.toFixed(1)}, Party Level ${partyLevel.toFixed(1)} | EL: ${elInt} | Difficulty: ${difficulty} (${elDiff >= 0 ? '+' : ''}${elDiff.toFixed(1)})`\r\n    : \"—\";\r\n\r\n  // Detailed EL breakdown for toggle view with step-by-step tree format\r\n  let elBreakdown = \"\";\r\n  if (groupELs.length > 0) {\r\n    const lines: string[] = [];\r\n    \r\n    // Step 1: Show individual CR group conversions\r\n    const crGroups = [...crMap.entries()].map(([cr, count]) => {\r\n      const groupEL = groupToEL(cr, count);\r\n      return { cr, count, groupEL, text: `${count}×CR${formatCR(cr)} → EL${groupEL}` };\r\n    }).sort((a, b) => b.groupEL - a.groupEL); // Sort by EL descending\r\n    \r\n    lines.push(...crGroups.map(g => `└─ ${g.text}`));\r\n    \r\n    // Step 2: Show combination process if multiple groups\r\n    if (crGroups.length > 1) {\r\n      const sortedELs = crGroups.map(g => g.groupEL).sort((a, b) => b - a);\r\n      let combineSteps: string[] = [];\r\n      let remaining = [...sortedELs];\r\n      \r\n      while (remaining.length > 1) {\r\n        const highest = remaining.shift()!;\r\n        const second = remaining.shift()!;\r\n        const diff = Math.abs(highest - second);\r\n        let combined = highest;\r\n        \r\n        if (diff === 0) {\r\n          combined = highest + 2;\r\n          combineSteps.push(`EL${highest} + EL${second} (same) → EL${combined}`);\r\n        } else if (diff === 1 || diff === 2) {\r\n          combined = highest + 1;\r\n          combineSteps.push(`EL${highest} + EL${second} (±${diff}) → EL${combined}`);\r\n        } else {\r\n          combineSteps.push(`EL${highest} + EL${second} (±${diff}, negligible) → EL${highest}`);\r\n        }\r\n        \r\n        remaining.push(combined);\r\n        remaining.sort((a, b) => b - a);\r\n      }\r\n      \r\n      lines.push(...combineSteps.map(step => `    └─ ${step}`));\r\n    }\r\n    \r\n    // Step 3: Show EL modifier if any\r\n    if (this.elDelta !== 0) {\r\n      lines.push(`    └─ EL modifier ${this.elDelta >= 0 ? '+' : ''}${this.elDelta} → EL${elInt}`);\r\n    }\r\n    \r\n    elBreakdown = lines.join('\\n');\r\n  }\r\n\r\n  // Settings\r\n  const awardMode = game.settings.get(\"motwm-xp\", \"awardMode\") as string;\r\n\r\n  // Party array + display bubble size + current manual award values\r\n  const partyArr = [...this.party.values()].map(p => {\r\n    const m = this.manualAwards?.get?.(p.id) ?? { amount: 0, unit: \"points\", reason: \"\" };\r\n    return {\r\n      ...p,\r\n      bubble: Math.round(bubbleSizeForLevel(p.level)),\r\n      manual: m\r\n    };\r\n  });\r\n\r\n  // Live preview - calculate encounter XP + manual awards\r\n  let preview: any[] = [];\r\n\r\n  // First, get encounter XP for earners\r\n  const encounterXpMap = new Map<string, number>();\r\n  if (elInt > 0 && partyArr.some(p => p.earns)) {\r\n    if (awardMode === \"raw35\") {\r\n      // RAW 3.5e per-PC\r\n      partyArr.filter(p => p.earns).forEach(p => {\r\n        encounterXpMap.set(p.id, awardRaw35(p.level, elInt));\r\n      });\r\n    } else if (awardMode === \"split30\") {\r\n      // D&D 3.0 split pot (using actual DMG table)\r\n      const apl = Math.round(partyArr.reduce((a, p) => a + p.level, 0) / Math.max(1, partyArr.length));\r\n      const pot = getPot30(apl, elInt);\r\n      const earners = partyArr.filter(p => p.earns);\r\n      const slice = split30(pot, 1, earners.length);\r\n      earners.forEach(p => {\r\n        encounterXpMap.set(p.id, slice);\r\n      });\r\n    }\r\n  }\r\n\r\n  // Now build preview including manual awards for ALL party members who have either\r\n  partyArr.forEach(p => {\r\n    const encounterXp = encounterXpMap.get(p.id) || 0;\r\n    const manualAward = this.manualAwards.get(p.id);\r\n    let manualXp = 0;\r\n    \r\n    if (manualAward && manualAward.amount) {\r\n      const bubbleSize = bubbleSizeForLevel(p.level);\r\n      manualXp = Math.round(manualAward.unit === \"bubbles\" ? manualAward.amount * bubbleSize : manualAward.amount);\r\n    }\r\n    \r\n    const totalXp = encounterXp + manualXp;\r\n    \r\n    // Only show in preview if they're getting XP from either source\r\n    if (totalXp > 0) {\r\n      preview.push({\r\n        id: p.id,\r\n        name: p.name,\r\n        level: p.level,\r\n        el: elInt || \"—\",\r\n        xp: totalXp\r\n      });\r\n    }\r\n  });\r\n\r\n  // Transform enemies to include the Map key (tokenId if available, else actor id)\r\n  const enemiesArr = [...this.enemies.entries()].map(([mapKey, enemy]) => ({\r\n    ...enemy,\r\n    mapKey, // Add the actual Map key so the template can use it for removal\r\n    cr: formatCR(Number(enemy.cr) || 0) // Format CR with Unicode fractions\r\n  }));\r\n\r\n  return {\r\n    party: partyArr,\r\n    enemies: enemiesArr,\r\n    el: elInt,               // integer EL for UI\r\n    encounterInfo: encounterInfo,\r\n    elBreakdown: elBreakdown,\r\n    showElDetails: this.showElDetails,\r\n    elDelta: this.elDelta,   // bind input directly to this value\r\n    preview,\r\n    hasRollback: !!this.lastAward\r\n  };\r\n}\r\n\r\n/* ---------- LISTENERS ---------- */\r\nactivateListeners(html: JQuery) {\r\n  super.activateListeners(html);\r\n\r\n  // --- Row actions ---\r\n  html.on(\"click\", \"[data-action='remove-party']\", ev => {\r\n    const id = (ev.currentTarget as HTMLElement).dataset.id!;\r\n    this.party.delete(id);\r\n    this.render();\r\n  });\r\n\r\n  html.on(\"click\", \"[data-action='remove-enemy']\", ev => {\r\n    const id = (ev.currentTarget as HTMLElement).dataset.id!;\r\n    this.enemies.delete(id);\r\n    this.render();\r\n  });\r\n\r\n  html.on(\"change\", \"input[data-action='toggle-earns']\", ev => {\r\n    const id = (ev.currentTarget as HTMLInputElement).dataset.id!;\r\n    const p = this.party.get(id);\r\n    if (p) {\r\n      p.earns = (ev.currentTarget as HTMLInputElement).checked;\r\n      this.render(false);\r\n    }\r\n  });\r\n\r\n  // --- EL modifier: integer only, allow negatives ---\r\n  html.on(\"change blur\", \"[data-action='el-delta']\", ev => {\r\n    const s = (ev.currentTarget as HTMLInputElement).value.trim();\r\n    if (s === \"\" || s === \"-\") return;                 // ignore incomplete/empty\r\n    const n = parseInt(s, 10);\r\n    this.elDelta = Number.isFinite(n) ? n : 0;         // commit integer\r\n    this.render(true);                                  // refresh preview\r\n  });\r\n\r\n  // --- Manual Award inputs (per-party row) ---\r\n  html.on(\"change blur\", \"[data-action='award-amount']\", ev => {\r\n    const row = (ev.currentTarget as HTMLElement).closest(\"[data-id]\") as HTMLElement;\r\n    const id = row?.dataset.id!;\r\n    const prev = this.manualAwards.get(id) ?? { amount: 0, unit: \"points\", reason: \"\" };\r\n    this.manualAwards.set(id, { ...prev, amount: Number((ev.currentTarget as HTMLInputElement).value) || 0 });\r\n    this.render(false); // Update preview\r\n  });\r\n\r\n  html.on(\"change\", \"[data-action='award-unit']\", ev => {\r\n    const row = (ev.currentTarget as HTMLElement).closest(\"[data-id]\") as HTMLElement;\r\n    const id = row?.dataset.id!;\r\n    const prev = this.manualAwards.get(id) ?? { amount: 0, unit: \"points\", reason: \"\" };\r\n    this.manualAwards.set(id, { ...prev, unit: ((ev.currentTarget as HTMLSelectElement).value as \"points\" | \"bubbles\") });\r\n    this.render(false); // Update preview\r\n  });\r\n\r\n  html.on(\"input\", \"[data-action='award-reason']\", ev => {\r\n    const row = (ev.currentTarget as HTMLElement).closest(\"[data-id]\") as HTMLElement;\r\n    const id = row?.dataset.id!;\r\n    const prev = this.manualAwards.get(id) ?? { amount: 0, unit: \"points\", reason: \"\" };\r\n    this.manualAwards.set(id, { ...prev, reason: (ev.currentTarget as HTMLInputElement).value ?? \"\" });\r\n    // No render needed for reason - it's just for chat message\r\n  });\r\n\r\n  // --- Party / setup sources (NEW canonical set) ---\r\n  html.on(\"click\", \"[data-action='add-online-assigned']\", () => this.addAssignedPlayersToPartyOnlineOnly());\r\n  html.on(\"click\", \"[data-action='add-all-assigned']\",   () => this.addAssignedPlayersToPartyAll());\r\n  html.on(\"click\", \"[data-action='add-friendly-scene']\", () => this.addFriendlySceneTokensToParty());\r\n  html.on(\"click\", \"[data-action='add-selected-party']\", () => this.addSelectedToParty());\r\n\r\n  // --- Enemies sources ---\r\n  html.on(\"click\", \"[data-action='add-selected-enemies']\", () => this.addSelectedToEnemies());\r\n  html.on(\"click\", \"[data-action='add-hostile-scene']\",    () => this.addHostileSceneTokensToEnemies());\r\n  html.on(\"click\", \"[data-action='add-neutral-scene']\",    () => this.addNeutralSceneTokensToEnemies());\r\n\r\n  // --- Clearers ---\r\n  html.on(\"click\", \"[data-action='clear-party']\",   () => { this.party.clear();   this.render(true); });\r\n  html.on(\"click\", \"[data-action='clear-enemies']\", () => { this.enemies.clear(); this.render(true); });\r\n\r\n  // --- Apply & Rollback ---\r\n  html.on(\"click\", \"[data-action='apply-xp']\", () => this.applyXP());\r\n  html.on(\"click\", \"[data-action='rollback-xp']\", () => this.rollbackXP());\r\n\r\n  // --- EL Details Toggle ---\r\n  html.on(\"click\", \"[data-action='toggle-el-details']\", () => {\r\n    this.showElDetails = !this.showElDetails;\r\n    (this as any).render(false);\r\n  });\r\n\r\n  // --- Double-click to open character sheets ---\r\n  html.on(\"dblclick\", \".party .row\", ev => {\r\n    // Don't open sheet if user double-clicked on interactive elements\r\n    const target = ev.target as HTMLElement;\r\n    if (target.tagName === 'INPUT' || target.tagName === 'SELECT' || target.tagName === 'BUTTON' || target.closest('button')) {\r\n      return;\r\n    }\r\n    \r\n    const id = (ev.currentTarget as HTMLElement).dataset.id;\r\n    if (id) {\r\n      const actor = (game as any).actors?.get(id);\r\n      if (actor?.sheet) {\r\n        (actor.sheet as any).render(true);\r\n      }\r\n    }\r\n  });\r\n\r\n  html.on(\"dblclick\", \".enemies .row\", ev => {\r\n    // Don't open sheet if user double-clicked on interactive elements\r\n    const target = ev.target as HTMLElement;\r\n    if (target.tagName === 'BUTTON' || target.closest('button')) {\r\n      return;\r\n    }\r\n    \r\n    // Use data-actor-id to get the actor (not the token ID from data-id)\r\n    const actorId = (ev.currentTarget as HTMLElement).dataset.actorId;\r\n    if (actorId) {\r\n      const actor = (game as any).actors?.get(actorId);\r\n      if (actor?.sheet) {\r\n        (actor.sheet as any).render(true);\r\n      }\r\n    }\r\n  });\r\n  }\r\n  \r\n/** --- CR extraction used for enemies (unified across all adders) --- */\r\nprivate getActorCR(a: Actor): number {\r\n  // D35E system stores CR in different ways:\r\n  // - system.details.totalCr = adjusted CR with templates (PRIORITY - this is what we want!)\r\n  // - system.details.cr = base CR without templates\r\n  // - system.details.cr.total or system.details.cr.value = alternative structures\r\n  \r\n  const crPaths = [\r\n    \"system.details.totalCr\",     // D35E: adjusted CR (includes templates!) - CHECK THIS FIRST\r\n    \"system.details.cr.total\",    // alternative adjusted CR format\r\n    \"system.attributes.cr.total\", // yet another alternative\r\n    \"system.details.cr.value\",    // structured base CR\r\n    \"system.details.cr\",          // flat base CR number\r\n    \"data.details.totalCr\",       // legacy adjusted\r\n    \"data.details.cr.total\",      // legacy adjusted\r\n    \"data.details.cr.value\",      // legacy base CR\r\n    \"data.details.cr\"             // legacy flat number\r\n  ];\r\n\r\n  for (const p of crPaths) {\r\n    // @ts-ignore\r\n    const v = Number(getProperty(a, p));\r\n    // Preserve fractional CRs (0.125, 0.25, 0.33, 0.5, etc.) - don't round them to 0!\r\n    if (Number.isFinite(v) && v > 0) return v;\r\n  }\r\n\r\n  // Derive from level if no explicit CR present\r\n  // @ts-ignore\r\n  const type  = (a as any).type;\r\n  // @ts-ignore\r\n  const level = Number(getProperty(a, \"system.details.level.value\")) || 0;\r\n\r\n  if (type === \"character\") {\r\n    // RAW quick heuristic: PC CR ≈ Character Level\r\n    return Math.max(1, Math.floor(level));\r\n  }\r\n\r\n  // Monsters/NPCs with no CR: fall back to level if present, else 1\r\n  return Math.max(1, Math.floor(level) || 1);\r\n}\r\n\r\n\r\n/** Add all hostile tokens on the current scene to the enemies list (with proper CR). */\r\nprivate addHostileSceneTokensToEnemies(): void {\r\n  const HOSTILE = (CONST as any)?.TOKEN_DISPOSITIONS?.HOSTILE ?? -1;\r\n  const tokens = canvas.tokens?.placeables ?? [];\r\n  const hostileTokens = tokens.filter(t => (t as any).document?.disposition === HOSTILE);\r\n\r\n  let added = 0;\r\n  for (const t of hostileTokens) {\r\n    const a = t.actor;\r\n    const tokenId = (t as any).id;\r\n    if (!a?.id || !tokenId || this.enemies.has(tokenId)) continue;\r\n\r\n    const name = a.name ?? \"Unknown\";\r\n    // @ts-ignore\r\n    const img  = a.img ?? a.prototypeToken?.texture?.src ?? \"icons/svg/skull.svg\";\r\n    const cr   = this.getActorCR(a); // <-- unified CR conversion\r\n\r\n    this.enemies.set(tokenId, { id: a.id, tokenId, name, img, cr });\r\n    added++;\r\n  }\r\n  ui.notifications?.info(`Added ${added} hostile token(s) from this scene.`);\r\n  this.render(true);\r\n}\r\n\r\n/** Add all neutral tokens on the current scene to the enemies list (with proper CR). */\r\nprivate addNeutralSceneTokensToEnemies(): void {\r\n  const NEUTRAL = (CONST as any)?.TOKEN_DISPOSITIONS?.NEUTRAL ?? 0;\r\n  const tokens = canvas.tokens?.placeables ?? [];\r\n  const neutralTokens = tokens.filter(t => (t as any).document?.disposition === NEUTRAL);\r\n\r\n  let added = 0;\r\n  for (const t of neutralTokens) {\r\n    const a = t.actor;\r\n    const tokenId = (t as any).id;\r\n    if (!a?.id || !tokenId || this.enemies.has(tokenId)) continue;\r\n\r\n    const name = a.name ?? \"Unknown\";\r\n    // @ts-ignore\r\n    const img  = a.img ?? a.prototypeToken?.texture?.src ?? \"icons/svg/eye.svg\";\r\n    const cr   = this.getActorCR(a); // <-- unified CR conversion\r\n\r\n    this.enemies.set(tokenId, { id: a.id, tokenId, name, img, cr });\r\n    added++;\r\n  }\r\n  ui.notifications?.info(`Added ${added} neutral token(s) from this scene.`);\r\n  this.render(true);\r\n}\r\n\r\n/** Add a batch of actors into the calculator \"party\" list (dedup by actor id). */\r\nprivate addActorsToParty(actors: Actor[]): number {\r\n  let added = 0;\r\n  for (const a of actors) {\r\n    if (!a?.id || this.party.has(a.id)) continue;\r\n\r\n    const name  = a.name ?? \"Unknown\";\r\n    // @ts-ignore\r\n    const img   = a.img ?? a.prototypeToken?.texture?.src ?? \"icons/svg/mystery-man.svg\";\r\n    // @ts-ignore\r\n    const level = Number(getProperty(a, \"system.details.level.value\")) || 1;\r\n\r\n    this.party.set(a.id, { id: a.id, name, img, level, earns: true, friend: false });\r\n    added++;\r\n  }\r\n  return added;\r\n}\r\n\r\n\r\n/** (1) Online users with assigned characters (simulate party addon). */\r\nprivate addAssignedPlayersToPartyOnlineOnly(): void {\r\n  const users = game.users?.players ?? [];\r\n  const online = users.filter(u => u.active);\r\n  const actors = online.map(u => u.character).filter((a): a is Actor => !!a);\r\n  const added = this.addActorsToParty(actors);\r\n  ui.notifications?.info(`Added ${added} online assigned PC(s).`);\r\n  this.render(true);\r\n}\r\n\r\n/** (2) All users with assigned characters (online or not). */\r\nprivate addAssignedPlayersToPartyAll(): void {\r\n  const users = game.users?.players ?? [];\r\n  const actors = users.map(u => u.character).filter((a): a is Actor => !!a);\r\n  const added = this.addActorsToParty(actors);\r\n  ui.notifications?.info(`Added ${added} assigned PC(s) (all logins).`);\r\n  this.render(true);\r\n}\r\n\r\n/** (3) All tokens marked Friendly on current scene (any actor behind them). */\r\nprivate addFriendlySceneTokensToParty(): void {\r\n  const FRIENDLY = (CONST as any)?.TOKEN_DISPOSITIONS?.FRIENDLY ?? 1;\r\n  const tokens = canvas.tokens?.placeables ?? [];\r\n  const actors = tokens\r\n    .filter(t => (t as any).document?.disposition === FRIENDLY)\r\n    .map(t => t.actor)\r\n    .filter((a): a is Actor => !!a);\r\n\r\n  const added = this.addActorsToParty(actors);\r\n  ui.notifications?.info(`Added ${added} Friendly token actor(s) from this scene.`);\r\n  this.render(true);\r\n}\r\n\r\n/** Populate from the CURRENT SCENE: only Friendly PC tokens (actor.type === \"character\"). */\r\nprivate populateScenePlayers(): void {\r\n  const FRIENDLY = (CONST as any)?.TOKEN_DISPOSITIONS?.FRIENDLY ?? 1;\r\n\r\n  const tokens = canvas.tokens?.placeables ?? [];\r\n  const actors: Actor[] = [];\r\n\r\n  for (const t of tokens) {\r\n    const doc = (t as any).document;           // TokenDocument\r\n    const a: Actor | undefined = t.actor ?? undefined;\r\n    if (!doc || !a) continue;\r\n\r\n    const isFriendly = doc.disposition === FRIENDLY;\r\n    const isPC = (a as any).type === \"character\";  // D35E PCs\r\n\r\n    if (isFriendly && isPC) actors.push(a);\r\n  }\r\n\r\n  const added = this.addActorsToParty(actors);\r\n  ui.notifications?.info(`Added ${added} Friendly PC(s) from this scene.`);\r\n  this.render(true);\r\n}\r\n\r\n/** Add members from Foundry's built-in Party (game.party.members). */\r\nprivate addFoundryParty(): void {\r\n  let actors: Actor[] = [];\r\n\r\n  // Primary: Core Party (v11+)\r\n  const coreParty: any = (game as any).party;\r\n  if (coreParty?.members?.length) {\r\n    actors = coreParty.members\r\n      .map((m: any) => m?.actor)\r\n      .filter((a: Actor | undefined) => !!a);\r\n  }\r\n\r\n  // OPTIONAL fallback: if you want strictly \"Party only\", comment these two blocks out\r\n  if (!actors.length) {\r\n    // Fallback #1: users' assigned characters\r\n    const pcs = game.users?.players\r\n      .map(u => u.character)\r\n      .filter((a: Actor | undefined) => !!a) as Actor[];\r\n    actors = pcs;\r\n  }\r\n  if (!actors.length) {\r\n    // Fallback #2: any PC actors on scene (not restricted to Friendly)\r\n    const tokens = canvas.tokens?.placeables ?? [];\r\n    actors = tokens\r\n      .map(t => t.actor)\r\n      .filter((a): a is Actor => !!a && ((a as any).type === \"character\"));\r\n  }\r\n  // END fallbacks\r\n\r\n  const added = this.addActorsToParty(actors);\r\n  ui.notifications?.info(`Added ${added} actor(s) from Foundry Party.`);\r\n  this.render(true);\r\n}\r\n  /* ---------- ACTIONS ---------- */\r\n\r\n  private _manualAwardsToGrants(): { id: string; name: string; xp: number; reason: string }[] {\r\n  const out: { id: string; name: string; xp: number; reason: string }[] = [];\r\n  for (const [id, award] of this.manualAwards) {\r\n    if (!award || !award.amount) continue;\r\n    const actor = game.actors?.get(id);\r\n    if (!actor) continue;\r\n    const name = actor.name ?? id;\r\n    // @ts-ignore\r\n    const lvl = Number(getProperty(actor, \"system.details.level.value\") ?? 1);\r\n    const perBubble = bubbleSizeForLevel(lvl);\r\n    const xp = Math.round(award.unit === \"bubbles\" ? award.amount * perBubble : award.amount);\r\n    if (xp !== 0) out.push({ id, name, xp, reason: award.reason?.trim() || \"Manual award\" });\r\n  }\r\n  return out;\r\n}\r\n\r\n  private populatePartyPlayers() {\r\n    let added = 0, skipped = 0;\r\n    const players = game.users?.players ?? [];\r\n    for (const u of players) {\r\n      const a = u.character as Actor | undefined;\r\n      if (!a) continue;\r\n      if (this.enemies.has(a.id)) { skipped++; continue; }\r\n      const level = D35EAdapter.getLevel(a) || 1;\r\n      const entry: PartyEntry = {\r\n        id: a.id, name: a.name ?? \"Actor\", img: a.img ?? \"\",\r\n        level, earns: true, friend: !a.hasPlayerOwner\r\n      };\r\n      if (!this.party.has(a.id)) { this.party.set(a.id, entry); added++; } else skipped++;\r\n    }\r\n    ui.notifications?.info(`Party +${added}${skipped ? `, skipped ${skipped}` : \"\"}`);\r\n    this.render();\r\n  }\r\n\r\n  private addSelectedToParty() {\r\n    const selected = canvas?.tokens?.controlled ?? [];\r\n    if (!selected.length) return ui.notifications?.warn(\"Select one or more tokens first.\");\r\n    let added = 0, skipped = 0;\r\n    for (const t of selected) {\r\n      const a = (t as any).actor as Actor | null;\r\n      if (!a) { skipped++; continue; }\r\n      if (this.enemies.has(a.id)) { skipped++; continue; }\r\n      const level = D35EAdapter.getLevel(a) || 1;\r\n      const entry: PartyEntry = {\r\n        id: a.id, name: a.name ?? \"Actor\", img: a.img ?? \"\",\r\n        level, earns: true, friend: !a.hasPlayerOwner\r\n      };\r\n      if (!this.party.has(a.id)) { this.party.set(a.id, entry); added++; } else skipped++;\r\n    }\r\n    ui.notifications?.info(`Party +${added}${skipped ? `, skipped ${skipped}` : \"\"}`);\r\n    this.render();\r\n  }\r\n\r\n/** Add currently selected canvas tokens as enemies (uses unified CR logic). */\r\nprivate addSelectedToEnemies(): void {\r\n  const selected = canvas?.tokens?.controlled ?? [];\r\n  if (!selected.length) {\r\n    ui.notifications?.warn(\"Select one or more tokens first.\");\r\n    return;\r\n  }\r\n\r\n  let added = 0, skipped = 0;\r\n\r\n  for (const t of selected) {\r\n    const a: Actor | undefined = (t as any).actor;\r\n    const tokenId = (t as any).id;\r\n    if (!a || !tokenId) { skipped++; continue; }\r\n\r\n    // Don't duplicate party members or existing enemies (use token ID for enemies now)\r\n    if (this.party.has(a.id) || this.enemies.has(tokenId)) { skipped++; continue; }\r\n\r\n    // Unified CR extraction (matches hostile/neutral adders)\r\n    const cr = this.getActorCR(a);\r\n    if (!Number.isFinite(cr) || cr <= 0) { skipped++; continue; }\r\n\r\n    // Safe image fallbacks\r\n    // @ts-ignore\r\n    const img = a.img ?? a.prototypeToken?.texture?.src ?? \"icons/svg/skull.svg\";\r\n    const name = a.name ?? \"Enemy\";\r\n\r\n    const entry: EnemyEntry = { id: a.id, tokenId, name, img, cr: Number(cr) };\r\n    this.enemies.set(tokenId, entry);\r\n    added++;\r\n  }\r\n\r\n  ui.notifications?.info(`Enemies +${added}${skipped ? `, skipped ${skipped}` : \"\"}`);\r\n  this.render(true); // refresh preview with updated enemies\r\n}\r\n\r\n\r\n  private addTargetedToEnemies() {\r\n    const targets = game.user?.targets ?? new Set();\r\n    if (!targets.size) return ui.notifications?.warn(\"Target one or more creatures first.\");\r\n    let added = 0, skipped = 0;\r\n    for (const t of targets as any) {\r\n      const a = (t as any).actor as Actor | null;\r\n      const tokenId = (t as any).id;\r\n      if (!a || !tokenId) { skipped++; continue; }\r\n      if (this.party.has(a.id)) { skipped++; continue; }\r\n      const crRaw = D35EAdapter.getCR(a); if (!crRaw) { skipped++; continue; }\r\n      const entry: EnemyEntry = { id: a.id, tokenId, name: a.name ?? \"Enemy\", img: a.img ?? \"\", cr: Number(crRaw) };\r\n      if (!this.enemies.has(tokenId)) { this.enemies.set(tokenId, entry); added++; } else skipped++;\r\n    }\r\n    ui.notifications?.info(`Enemies +${added}${skipped ? `, skipped ${skipped}` : \"\"}`);\r\n    this.render();\r\n  }\r\n\r\n  private async applyXP() {\r\n  // --- 1) Build encounter grants from your existing preview (keep your logic) ---\r\n  const encounterGrants: { id: string; name: string; xp: number }[] = [];\r\n  const partyArr = [...this.party.values()];\r\n  const earners = partyArr.filter(p => p.earns);\r\n\r\n  // Recompute encounter preview (mirror your getData preview branch)\r\n  const crMap = new Map<number, number>();\r\n  for (const e of this.enemies.values()) {\r\n    // Preserve fractional CRs (0.125, 0.25, 0.33, 0.5, etc.)\r\n    const cr = Math.max(0.125, Number(e.cr) || 1);\r\n    crMap.set(cr, (crMap.get(cr) ?? 0) + 1);\r\n  }\r\n  const groupELs: number[] = [];\r\n  for (const [cr, count] of crMap.entries()) groupELs.push(groupToEL(cr, count));\r\n  let el = groupELs.length ? combineELs(groupELs) : 0;\r\n  el += this.elDelta;\r\n\r\n  const awardMode = game.settings.get(\"motwm-xp\", \"awardMode\") as string;\r\n  if (el > 0 && earners.length) {\r\n    if (awardMode === \"raw35\") {\r\n      for (const p of earners) encounterGrants.push({ id: p.id, name: p.name, xp: awardRaw35(p.level, el) });\r\n    } else if (awardMode === \"split30\") {\r\n      const apl = Math.round(partyArr.reduce((a, p) => a + p.level, 0) / Math.max(1, partyArr.length));\r\n      const pot = getPot30(apl, el);\r\n      const slice = split30(pot, 1, earners.length);\r\n      for (const p of earners) encounterGrants.push({ id: p.id, name: p.name, xp: slice });\r\n    }\r\n  }\r\n\r\n  // --- 2) Build manual grants (points or segments) ---\r\n  const manualGrants = this._manualAwardsToGrants();\r\n\r\n  // --- 3) Guard: nothing to award at all ---\r\n  if (!encounterGrants.length && !manualGrants.length) {\r\n    ui.notifications?.info(\"No XP to award: add enemies and/or manual awards first.\");\r\n    return;\r\n  }\r\n\r\n  // --- 4) Apply: encounter first, then manual (order is cosmetic only) ---\r\n  const applyGrants = async (grants: { id: string; name: string; xp: number }[]) => {\r\n    for (const g of grants) {\r\n      const actor = game.actors?.get(g.id);\r\n      if (!actor) continue;\r\n      // @ts-ignore\r\n      const curr = Number(getProperty(actor, \"system.details.xp.value\") ?? 0);\r\n      await actor.update({ \"system.details.xp.value\": curr + g.xp });\r\n    }\r\n  };\r\n\r\n  if (encounterGrants.length) await applyGrants(encounterGrants);\r\n  if (manualGrants.length)    await applyGrants(manualGrants);\r\n\r\n  // --- 5) Chat: separate cards for clarity ---\r\n  const chatMessageIds: string[] = [];\r\n\r\n  if (game.settings.get(\"motwm-xp\", \"broadcastChat\")) {\r\n    const esc = (str: any) => {\r\n      try { return TextEditor.escapeHTML(String(str ?? \"\")); }\r\n      catch {\r\n        // @ts-ignore\r\n        return foundry.utils?.escapeHTML\r\n          ? foundry.utils.escapeHTML(String(str ?? \"\"))\r\n          : String(str ?? \"\").replace(/[&<>\"']/g, s =>\r\n              ({ \"&\": \"&amp;\", \"<\": \"&lt;\", \">\": \"&gt;\", '\"': \"&quot;\", \"'\": \"&#039;\" }[s])\r\n            );\r\n      }\r\n    };\r\n\r\n    const makeList = (items: { name: string; xp: number; reason?: string }[]) =>\r\n      `<ul>${items.map(a => {\r\n        const safeName = esc(a.name);\r\n        const r = a.reason ? ` <em>(${esc(a.reason)})</em>` : \"\";\r\n        return `<li><b>${safeName}</b>: +${a.xp.toLocaleString()} XP${r}</li>`;\r\n      }).join(\"\")}</ul>`;\r\n\r\n    if (encounterGrants.length) {\r\n      const html = `<div><h3>Encounter XP Awards</h3>${makeList(encounterGrants)}</div>`;\r\n      const msg = await ChatMessage.create({ content: html });\r\n      if (msg?.id) chatMessageIds.push(msg.id);\r\n    }\r\n    if (manualGrants.length) {\r\n      // attach reasons where available\r\n      const withReasons = manualGrants.map(g => ({ ...g, reason: (this.manualAwards.get(g.id)?.reason) || \"Manual award\" }));\r\n      const html = `<div><h3>Manual XP Awards</h3>${makeList(withReasons)}</div>`;\r\n      const msg = await ChatMessage.create({ content: html });\r\n      if (msg?.id) chatMessageIds.push(msg.id);\r\n    }\r\n  }\r\n\r\n  // --- 6) Save state for rollback, then clear encounter inputs ---\r\n  this.lastAward = {\r\n    enemies: new Map(this.enemies),\r\n    manualAwards: new Map(this.manualAwards),\r\n    elDelta: this.elDelta,\r\n    grants: [...encounterGrants, ...manualGrants],\r\n    chatMessageIds: chatMessageIds\r\n  };\r\n\r\n  this.enemies.clear();\r\n  this.manualAwards.clear();\r\n  this.elDelta = 0;\r\n\r\n  // Re-render to show cleared state\r\n  this.render(true);\r\n  }\r\n\r\n  private async rollbackXP() {\r\n  if (!this.lastAward) {\r\n    ui.notifications?.warn(\"No XP award to rollback.\");\r\n    return;\r\n  }\r\n\r\n  // --- 1) Delete chat messages ---\r\n  for (const id of this.lastAward.chatMessageIds) {\r\n    const msg = game.messages?.get(id);\r\n    await msg?.delete();\r\n  }\r\n\r\n  // --- 2) Reverse the XP grants ---\r\n  const reverseGrants = async (grants: { id: string; name: string; xp: number }[]) => {\r\n    for (const g of grants) {\r\n      const actor = game.actors?.get(g.id);\r\n      if (!actor) continue;\r\n      // @ts-ignore\r\n      const curr = Number(getProperty(actor, \"system.details.xp.value\") ?? 0);\r\n      await actor.update({ \"system.details.xp.value\": curr - g.xp });\r\n    }\r\n  };\r\n\r\n  await reverseGrants(this.lastAward.grants);\r\n\r\n  // --- 3) Restore the state ---\r\n  this.enemies = new Map(this.lastAward.enemies);\r\n  this.manualAwards = new Map(this.lastAward.manualAwards);\r\n  this.elDelta = this.lastAward.elDelta;\r\n\r\n  // --- 4) Clear rollback history ---\r\n  this.lastAward = null;\r\n\r\n  // --- 5) Notify & re-render ---\r\n  ui.notifications?.info(\"XP award rolled back.\");\r\n  this.render(true);\r\n  }\r\n\r\n}","import { systemTotalXPForLevel, TOTAL_BUBBLE_SEGMENTS } from \"../calc/xp\";\r\n\r\ntype Pos = { left: number; top: number };\r\n\r\nexport class XpBarApp extends Application {\r\n  actor: Actor;\r\n  private _dragging = false;\r\n  private _dragOffset = { x: 0, y: 0 };\r\n  private _wired = false; // prevent duplicate listeners\r\n\r\n  constructor(actor: Actor, options: Partial<ApplicationOptions> = {}) {\r\n    super({ popOut: false, id: \"motwmxp-bar\", ...options });\r\n    this.actor = actor;\r\n  }\r\n\r\n  static get defaultOptions() {\r\n    return mergeObject(super.defaultOptions, {\r\n      id: \"motwmxp-bar\",\r\n      template: \"modules/motwm-xp/templates/xp-bar.hbs\"\r\n    });\r\n  }\r\n\r\n  /* ---------- position helpers ---------- */\r\n  private _getSavedPos(): Pos | null {\r\n    const str = game.settings.get(\"motwm-xp\", \"barPos\") as string;\r\n    if (!str) return null;\r\n    try {\r\n      const p = JSON.parse(str);\r\n      return p && Number.isFinite(p.left) && Number.isFinite(p.top) ? p : null;\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private async _savePos(left: number, top: number) {\r\n    await game.settings.set(\"motwm-xp\", \"barPos\", JSON.stringify({ left, top }));\r\n  }\r\n\r\n  /** Apply pixel position; if none saved, center by calculating pixels (no CSS transform). */\r\n  private _applyPos() {\r\n    const el = this.element[0] as HTMLElement;\r\n    if (!el) return;\r\n\r\n    const saved = this._getSavedPos();\r\n    el.style.position = \"fixed\";\r\n    el.style.zIndex = \"70000\";\r\n\r\n    if (saved) {\r\n      el.style.left = `${saved.left}px`;\r\n      el.style.top  = `${saved.top}px`;\r\n    } else {\r\n      // compute pixel-centered bottom position once\r\n      const w = el.getBoundingClientRect().width || 520;\r\n      const h = el.getBoundingClientRect().height || 18;\r\n      const left = Math.round((window.innerWidth  - w) / 2);\r\n      const top  = Math.round(window.innerHeight - h - 8);\r\n      el.style.left = `${left}px`;\r\n      el.style.top  = `${top}px`;\r\n    }\r\n  }\r\n\r\n  /* ---------- data: layers + segments ---------- */\r\n  getData(): any {\r\n    // read from sheet/system\r\n    // @ts-ignore\r\n    const lvl = Number(getProperty(this.actor, \"system.details.level.value\") ?? 1);\r\n    // @ts-ignore\r\n    const totalXP = Number(getProperty(this.actor, \"system.details.xp.value\") ?? 0);\r\n    // @ts-ignore\r\n    const nextFromSheet = getProperty(this.actor, \"system.details.xp.max\");\r\n\r\n    const next0 = Number(nextFromSheet != null ? nextFromSheet : systemTotalXPForLevel(lvl + 1));\r\n    const prev0 = systemTotalXPForLevel(lvl);\r\n\r\n    // thresholds for up to 3 layers\r\n    const thresholds = [prev0, next0, systemTotalXPForLevel(lvl + 2), systemTotalXPForLevel(lvl + 3)];\r\n\r\n    // consume excess into layers\r\n    let excess = Math.max(0, totalXP - thresholds[0]);\r\n    const layers: { class: string; width: number }[] = [];\r\n    for (let i = 0; i < 3; i++) {\r\n      const span = Math.max(1, thresholds[i + 1] - thresholds[i]);\r\n      const frac = Math.max(0, Math.min(1, excess / span));\r\n      layers.push({ class: `layer${i}`, width: Math.round(frac * 10000) / 100 });\r\n      excess = Math.max(0, excess - span);\r\n    }\r\n\r\n    // segments (13 + mini 1/3)\r\n    const segments: any[] = [];\r\n    const totalSegs = TOTAL_BUBBLE_SEGMENTS;\r\n    for (let i = 1; i <= 13; i++) segments.push({ left: (i / totalSegs) * 100, class: \"\" });\r\n    segments.push({ left: (13 / totalSegs) * 100, class: \"mini\" });\r\n\r\n    const label = `Lv ${lvl} | ${totalXP.toLocaleString()} / ${next0.toLocaleString()} XP`;\r\n    const tooltip = `Level: ${lvl}`;\r\n\r\n    return { layers, segments, label, tooltip };\r\n  }\r\n\r\n  /* ---------- render & drag ---------- */\r\n  async _render(force?: boolean, options?: any): Promise<void> {\r\n    await super._render(force, options);\r\n    this._applyPos();\r\n\r\n    // Always re-attach pointerdown to the new element after render\r\n    const el = this.element[0] as HTMLElement;\r\n    if (!el) return;\r\n\r\n    // DRAG ON WHOLE BAR - must re-attach every render since element is recreated\r\n    el.addEventListener(\"pointerdown\", (ev: PointerEvent) => {\r\n      ev.preventDefault();\r\n\r\n      // 1) snapshot current pixels BEFORE any style changes\r\n      const rect = el.getBoundingClientRect();\r\n\r\n      // 2) ensure explicit pixel position (no bottom/transform anywhere)\r\n      el.style.left = `${rect.left}px`;\r\n      el.style.top  = `${rect.top}px`;\r\n\r\n      // 3) start drag\r\n      this._dragging = true;\r\n      (ev.currentTarget as HTMLElement).setPointerCapture?.(ev.pointerId);\r\n\r\n      // 4) offset from pointer to element origin\r\n      this._dragOffset.x = ev.clientX - rect.left;\r\n      this._dragOffset.y = ev.clientY - rect.top;\r\n    });\r\n\r\n    // Window listeners only need to be attached once\r\n    if (this._wired) return;\r\n    this._wired = true;\r\n\r\n    window.addEventListener(\"pointermove\", (ev: PointerEvent) => {\r\n      if (!this._dragging) return;\r\n      const currentEl = this.element[0] as HTMLElement;\r\n      if (!currentEl) return;\r\n      const left = Math.max(0, Math.min(window.innerWidth  - 50, ev.clientX - this._dragOffset.x));\r\n      const top  = Math.max(0, Math.min(window.innerHeight - 24, ev.clientY - this._dragOffset.y));\r\n      currentEl.style.left = `${left}px`;\r\n      currentEl.style.top  = `${top}px`;\r\n    });\r\n\r\n    window.addEventListener(\"pointerup\", async () => {\r\n      if (!this._dragging) return;\r\n      this._dragging = false;\r\n      const currentEl = this.element[0] as HTMLElement;\r\n      if (!currentEl) return;\r\n      const left = parseInt(currentEl.style.left || \"0\", 10);\r\n      const top  = parseInt(currentEl.style.top  || \"0\", 10);\r\n      await this._savePos(left, top);\r\n    });\r\n\r\n    // keep it on-screen on resize; if saved, re-apply saved pixels; else re-center by pixels\r\n    window.addEventListener(\"resize\", () => this._applyPos(), { passive: true });\r\n  }\r\n\r\n  render(force?: boolean, options?: any): this {\r\n    const show = game.settings.get(\"motwm-xp\", \"showPlayerBar\") as boolean;\r\n    if (!show) return this;\r\n    return super.render(force, options);\r\n  }\r\n}\r\n","import { registerSettings } from \"./settings\";\r\nimport { XpCalculatorApp } from \"./ui/XpCalculatorApp\";\r\nimport { XpBarApp } from \"./ui/XpBarApp\";\r\nimport \"./styles/styles.css\";\r\n\r\ndeclare global {\r\n  interface Window {\r\n    MOTWM_XP?: {\r\n      calc?: XpCalculatorApp;\r\n      bars?: Map<string, XpBarApp>;\r\n    };\r\n  }\r\n}\r\n\r\nHooks.once(\"init\", () => {\r\n  console.log(\"motwm-xp | init\");\r\n  registerSettings();\r\n  window.MOTWM_XP = window.MOTWM_XP ?? { bars: new Map() };\r\n});\r\n\r\nHooks.once(\"ready\", () => {\r\n  console.log(\"motwm-xp | ready\");\r\n\r\n  // Player XP bar: each user sees their own assigned character (if any)\r\n  const show = game.settings.get(\"motwm-xp\", \"showPlayerBar\") as boolean;\r\n  const myActor = game.user?.character as Actor | undefined;\r\n  if (show && myActor) {\r\n    const bars = window.MOTWM_XP!.bars!;\r\n    let app = bars.get(myActor.id);\r\n    if (!app) {\r\n      app = new XpBarApp(myActor, { top: window.innerHeight - 54, left: 0 });\r\n      bars.set(myActor.id, app);\r\n    }\r\n    app.render(true);\r\n  }\r\n\r\n  // Re-render my bar if my actor's XP/level changes\r\n  Hooks.on(\"updateActor\", (actor: Actor, changes: any) => {\r\n    const a = game.user?.character;\r\n    if (!a || actor.id !== a.id) return;\r\n    const app = window.MOTWM_XP!.bars!.get(a.id);\r\n    app?.render(true);\r\n  });\r\n\r\n  // Re-render XP calculator when award mode setting changes\r\n  Hooks.on(\"updateSetting\", (setting: any, value: any) => {\r\n    if (setting.key === \"motwm-xp.awardMode\" && window.MOTWM_XP?.calc) {\r\n      const calc = window.MOTWM_XP.calc as any;\r\n      if (calc.element) {\r\n        calc.render(false);\r\n      }\r\n    }\r\n  });\r\n});\r\n\r\n// Add the GM calculator button to Token controls\r\nHooks.on(\"getSceneControlButtons\", (controls: any[]) => {\r\n  if (!game.user?.isGM) return;\r\n  const tokenControl = controls.find(c => c.name === \"token\");\r\n  tokenControl?.tools?.push({\r\n    name: \"motwm-xp-calc\",\r\n    title: \"Open XP Calculator\",\r\n    icon: \"fas fa-calculator\",\r\n    visible: true,\r\n    onClick: () => {\r\n      if (!window.MOTWM_XP?.calc) window.MOTWM_XP!.calc = new XpCalculatorApp();\r\n      (window.MOTWM_XP!.calc as any).render(true);\r\n    },\r\n    button: true\r\n  });\r\n});"],"names":["registerSettings","D35EAdapter","actor","v","value","classes","total","cls","lv","fallback","crPaths","path","cr","lvl","groupToEL","count","el","k","combineELs","els","arr","a","b","diff","combined","x","y","systemTotalXPForLevel","level","_a","_b","L","rate","table","TOTAL_BUBBLE_SEGMENTS","awardRaw35","pcLevel","encounterLevel","iReturn","mEven","val","result","getPot30","apl","TABLE_30","aplInt","crInt","levelRow","xp","baseXP","getBasePot30","step","irregular","pattern","mult","split30","pot","weight","totalWeight","formatCR","fractions","symbol","bubbleSizeForLevel","start","next","XpCalculatorApp","__publicField","crMap","e","groupELs","baseEL","delta","elInt","partyLevels","p","partySize","crToPower","powerToLevel","power","averageLevel","sum","partyLevel","partyPower","elDiff","difficulty","encounterInfo","elBreakdown","lines","crGroups","groupEL","g","sortedELs","combineSteps","remaining","highest","second","awardMode","partyArr","m","preview","encounterXpMap","earners","slice","encounterXp","manualAward","manualXp","bubbleSize","totalXp","enemiesArr","mapKey","enemy","html","ev","id","row","prev","target","actorId","type","_c","_d","_e","HOSTILE","hostileTokens","t","added","tokenId","name","img","NEUTRAL","neutralTokens","actors","u","FRIENDLY","tokens","doc","isFriendly","isPC","coreParty","out","award","perBubble","skipped","players","entry","selected","targets","crRaw","encounterGrants","manualGrants","applyGrants","grants","curr","chatMessageIds","esc","str","s","makeList","items","safeName","r","msg","withReasons","XpBarApp","options","left","top","saved","w","h","totalXP","nextFromSheet","next0","thresholds","excess","layers","i","span","frac","segments","totalSegs","label","tooltip","force","rect","currentEl","show","myActor","bars","app","changes","setting","calc","controls","tokenControl","c"],"mappings":"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"}